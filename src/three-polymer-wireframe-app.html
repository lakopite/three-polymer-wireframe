@license
<!--
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../bower_components/three-polymer/three-view/three-view.html">
<link rel="import" href="../bower_components/three-polymer/three-model/three-model.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">

<dom-module id="three-polymer-wireframe-app">
  <template>
    <style>
      :host {
        --app-primary-color: #4285f4;
        --app-secondary-color: black;

        display: block;
      }

      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }

      app-header {
        color: #fff;
        background-color: var(--app-primary-color);
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      .drawer-list {
        margin: 0 20px;
      }

      .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }

      .three-container {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        height: 100%;
      }

      #view {
        @apply(--layout-self-center);
        @apply(--shadow-elevation-2dp);
      }

      #filter-container {
        margin-top: 60px;
      }

      .horizontal {
        @apply(--layout-horizontal);
      }

      .inline-input {
        padding: 0.1em;
        @apply(--layout-flex);
      }

      .dropdown-item {
        cursor: pointer;
      }

      #uploaded-by {
        font-size: .9em;
        color: #3F51B5;
        padding: 0;
      }

      #model-dropdown {
        font-size: .75em;
      }

      paper-button.filterBtn {
        background: var(--app-primary-color);
        color: #FFF;
      }

      paper-button[disabled] {
        background: #eaeaea;
        color: #a8a8a8;
      }

      paper-dialog#addModelDialog {
        padding: 1em;
      }

      paper-spinner {
        --paper-spinner-layer-1-color: #FFF;
        --paper-spinner-layer-2-color: #FFF;
        --paper-spinner-layer-3-color: #FFF;
        --paper-spinner-layer-4-color: #FFF;
      }

      #sum-field-dropdown {
        --paper-input-container-label: {
          font-size:20px;
        }
      }

      .numerical-aggregations-table {
        height: calc(100vh - 192px);
      }

      .data-by-group-table, .numerical-aggregations-table {
        --vaadin-grid-body-row-odd-cell: {
          background-color: #f5f5f5;
        };
      }

      .num-wrapper {
        background-color: var(--paper-grey-300);
        display: grid;
        grid-template-columns: 1fr 1fr;
      }

      .str-header {
        background-color: var(--paper-grey-300);
        display: grid;
        grid-template-columns: 1fr 1fr 2fr;
      }

      #num-contour-dropdown, #str-contour-dropdown {
        padding: 0 0.5em;
          --paper-input-container-label: {
            font-size:20px;
          }
      }

      #wrap-str-info {
        @apply(--layout-vertical);
        overflow-x:hidden;
      }

      #group-data-table-section {
        /*height: 50%;*/
      }

      #chart-container {
        height: 398px;
      }

      #csv-button {
        margin: 60px 0 0 0;
        background: var(--app-primary-color);
        color: #FFF;
      }

      #validationToast {
        padding: 1em 1em;
        border: 1px solid gray;
      }

      .yellow-toast {
        text-transform: none;
        color: #eeff41;
      }

      #uploadSuccessToast {
        --paper-toast-background-color: green;
        --paper-toast-color: white;
      }

    </style>
    <iron-ajax headers="{{authHeaders}}" id="get-models-request" method="GET" url="[[baseUrl]]get-models" handle-as="json" on-response="handleOptionsResponse" on-error="handleOptionsError"></iron-ajax>
    <iron-ajax headers="{{authHeaders}}" id="model-request" method="GET" handle-as="json" on-response="handleDataResponse" on-error="handleDataError"></iron-ajax>
    <iron-ajax headers="{{authHeaders}}" id="json-upload-request" method="POST" content-type="application/json" body='[[jsonUploadPayload]]' on-response="handleUploadResponse" url="[[baseUrl]]post-model"></iron-ajax>
    <paper-dialog modal id="addModelDialog">
      <h2>Add a Model</h2>
      <paper-input id="user-email" label="username" prevent-invalid-input allowed-pattern="([A-Za-z0-9\._-]+)" value="{{userEmail}}">
        <div slot="suffix">@arup.com</div>
      </paper-input>
      <iron-input>
      <input id="modelUpload" type="file" on-change="handleJsonUpload"></input>
      </iron-input>
      <div class="buttons">
        <paper-button dialog-dismiss on-tap="_clearUploadInput">Cancel</paper-button>
        <paper-button id="acceptUploadBtn" dialog-confirm autofocus disabled$="{{_acceptUploadDisabled}}" on-tap="uploadJsonModel">Upload</paper-button>
      </div>
    </paper-dialog>
    <paper-toast id="validationToast" duration="0" class="fit-bottom">
      <paper-button on-tap="reopenUploadBox" class="yellow-toast">Try Again</paper-button>
      <paper-button dialog-dismiss on-tap="closeToast" class="yellow-toast">Cancel</paper-button>
    </paper-toast>
    <paper-toast id="uploadSuccessToast" duration="3000"></paper-toast>
    <app-drawer-layout fullbleed>
    <!-- Drawer content -->
    <app-drawer id="drawer" slot="drawer">
    <div style="height: 100%; overflow: auto;">
    <app-toolbar>
      <paper-item>Model Options</paper-item>
    </app-toolbar>
    <div class="drawer-list">
      <paper-dropdown-menu label="Model">
        <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedModel}}">
          <template is="dom-repeat" items="[[dataOptions]]">
            <paper-item id="model-dropdown" class="dropdown-item" name="[[item.model]]">[[item.model]]</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>
      <paper-item id="uploaded-by" label="Uploaded by"><p>Uploaded by: [[currentModelResp.modelInformation.user]]<br/>at [[currentModelResp.modelInformation.s3_attributes.uploadTime]]</p></paper-item>
      <div hidden$="{{_hideMainDropdown(selectedView)}}">
        <paper-dropdown-menu id="main-contour-dropdown" label="Contour">
          <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
            <template is="dom-repeat" items="[[metadataFields]]">
              <paper-item class="dropdown-item" name="{{item}}">{{_dropdownUnitLabel(item)}}</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>
      <div id="filter-container">
        <paper-item>Model Filters</paper-item>
        <div class="horizontal">
          <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min x" class="inline-input" type="number" value="{{geometryFilter.xMin}}" max="[[_computeMax(boundaries.xMax,geometryFilter.xMax)]]" min="[[boundaries.xMin]]"></paper-input>
          <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max x" class="inline-input" type="number" value="{{geometryFilter.xMax}}" max="[[boundaries.xMax]]" min="[[_computeMin(boundaries.xMin,geometryFilter.xMin)]]"></paper-input>
        </div>
        <div class="horizontal">
          <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min y" class="inline-input" type="number" value="{{geometryFilter.yMin}}" max="[[_computeMax(boundaries.yMax,geometryFilter.yMax)]]" min="[[boundaries.yMin]]"></paper-input>
          <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max y" class="inline-input" type="number" value="{{geometryFilter.yMax}}" max="[[boundaries.yMax]]" min="[[_computeMin(boundaries.yMin,geometryFilter.yMin)]]"></paper-input>
        </div>
        <div class="horizontal">
          <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min z" class="inline-input" type="number" value="{{geometryFilter.zMin}}" max="[[_computeMax(boundaries.zMax,geometryFilter.zMax)]]" min="[[boundaries.zMin]]"></paper-input>
          <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max z" class="inline-input" type="number" value="{{geometryFilter.zMax}}" max="[[boundaries.zMax]]" min="[[_computeMin(boundaries.zMin,geometryFilter.zMin)]]"></paper-input>
        </div>
        <div class="horizontal">
          <paper-button class="filterBtn" raised disabled$="{{_filtersDisabled}}" id="applyBtn" on-tap="applyFilters" type="number">Apply</paper-button>
          <paper-button class="filterBtn" raised disabled$="{{modelLoading}}" id="resetBtn" on-tap="resetFilters" type="number">Reset</paper-button>
        </div>
      </div>
      <!-- for numerical aggregations -->
      <div hidden$="{{_hideCsvButton(selectedView)}}">
        <div class="csv-wrapper">
          <div hidden$="[[!showNumericalAggregations]]">
            <div class="csv-button">
              <paper-button id="csv-button" on-tap="createNumericalCsv">Export Table to CSV</paper-button>
            </div>
          </div>
        </div>
      </div>
      <!-- for string aggregations -->
      <div hidden$="{{_hideCsvButton(selectedView)}}">
        <div class="csv-wrapper">
          <div hidden$="[[!showStringAggregations]]">
            <div class="csv-button">
              <paper-button id="csv-button" on-tap="createGroupDataCsv">Export Table to CSV</paper-button>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>
    </app-drawer>
  <!-- Main content -->
    <app-header-layout has-scrolling-region>
    <app-header slot="header" medium-tall>
      <app-toolbar>
        <paper-icon-button icon="my-icons:menu" drawer-toggle></paper-icon-button>
        <div main-title>Arup Model QuickView</div>
        <paper-item>Build Date: 10/09/17</paper-item>
        <div class="spacer"></div>
        <paper-spinner active$="{{isLoadingState(modelLoading,appLoading)}}"></paper-spinner>
        <paper-icon-button on-tap="showDialog" icon="my-icons:add"></paper-icon-button>
        <paper-menu-button horizontal-align="right">
          <paper-icon-button icon="my-icons:account-circle" slot="dropdown-trigger"></paper-icon-button>
          <paper-listbox slot="dropdown-content">
            <paper-item style="cursor:pointer;" on-tap="logout">Logout</paper-item>
          </paper-listbox>
        </paper-menu-button>
      </app-toolbar>
      <app-toolbar>
        <paper-tabs bottom-item attr-for-selected="name" selected="{{selectedView}}">
          <paper-tab name="model-view">Model</paper-tab>
          <paper-tab name="aggregations-view">Quantities</paper-tab>
        </paper-tabs>
      </app-toolbar>
    </app-header>
    <iron-pages style="height:100%;" attr-for-selected="name" selected="{{selectedView}}">
    <div name="model-view" class="three-container">
      <three-view id="view" legend-position="top-left" scene-background-color="#F5F5F5">
        <three-model id="model" slot="model" metadata-fields="{{metadataFields}}" is-loading="{{modelLoading}}" contour-by="[[selectedContourBy]]" boundaries="{{boundaries}}" geometry-filter="{{geometryFilter}}" data="[[_modelData]]"></three-model>
      </three-view>
    </div>
    <!-- Quantities tab -->
      <!-- For numerical aggregations -->
    <div name="aggregations-view">
      <div hidden$="[[!showNumericalAggregations]]">
        <div class="num-wrapper">
          <app-toolbar class="aggregation-toolbar">
            <div main-title>Aggregations</div>
          </app-toolbar>
          <paper-dropdown-menu id="num-contour-dropdown" label="Contour">
            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
              <template is="dom-repeat" items="[[metadataFields]]">
                <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
              </template>
            </paper-listbox>
            </paper-dropdown-menu>
        </div>
        <!-- min/max/avg table -->
        <vaadin-grid class="numerical-aggregations-table" items="[[numericalAggregationsTableData]]">
          <vaadin-grid-column>
            <template class="header">Name</template>
            <template>[[item.name]] [[_numericalAggUnitLabels(selectedContourBy)]]</template>
            <template class="footer">Grand Total: [[_prettify(totalResult)]] [[_numericalAggUnitLabels(selectedContourBy)]]</template>
          </vaadin-grid-column>
          <vaadin-grid-column>
            <template class="header">Result</template>
            <template>[[_prettify(item.result)]]</template>
          </vaadin-grid-column>
        </vaadin-grid>
      </div>
      <!-- For string aggregations -->
      <div hidden$="[[!showStringAggregations]]">
        <div class="str-header">
          <app-toolbar class="aggregation-toolbar">
            <div main-title>Data by Group</div>
          </app-toolbar>
          <paper-dropdown-menu id="str-contour-dropdown" label="Contour">
            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
              <template is="dom-repeat" items="[[metadataFields]]">
                <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
          <paper-dropdown-menu class="aggregation-toolbar" id="sum-field-dropdown" label="Select Sum Field">
            <paper-listbox slot="dropdown-content" class="dropdown-content" attr-for-selected="name" selected="{{selectedSumField}}">
              <template is="dom-repeat" items="[[numericalMetadataKeys]]">
                <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
        </div>
        <!-- wrap all string aggregation info -->
        <div id="wrap-str-info">
          <!-- div holds pie chart -->
          <div id="chart-container"></div>
          <!-- data by group table -->
          <div id="group-data-table-section">
          <vaadin-grid class="data-by-group-table" items="[[groupSumData]]">
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="group">group</vaadin-grid-sorter>
              </template>
              <template>[[item.group]]</template>
              <template class="footer">Grand Total</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="elemsPerGroup">elements/group</vaadin-grid-sorter>
              </template>
              <template>[[_prettify(item.elemsPerGroup)]]</template>
              <template class="footer">[[_prettify(totalElements)]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="sum">sum [[selectedSumField]] [[_specifyUnits(selectedSumField)]]</vaadin-grid-sorter>
              </template>
              <template>[[_prettify(item.sum)]]</template>
              <template class="footer">[[_prettify(grandTotalSum)]] [[_specifyUnits(selectedSumField)]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column hidden$="{{_hideColumn(selectedSumField)}}">
              <template class="header">
                <vaadin-grid-sorter path="otherUnitSum">sum [[selectedSumField]] [[strOtherUnitLabel]]</vaadin-grid-sorter>
              </template>
              <template>[[_prettify(item.otherUnitSum)]]</template>
              <template class="footer">[[_prettify(grandTotalOtherUnitSum)]] [[strOtherUnitLabel]]</template>
            </vaadin-grid-column>
            <!-- NUMERICAL AGGREGATIONS WITHIN STRING AGGREGATION TABLE-->
            <vaadin-grid-column>
              <template class="header">min [[selectedSumField]] [[_specifyUnits(selectedSumField)]]</template>
              <template>[[_prettify(item.min)]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">max [[selectedSumField]] [[_specifyUnits(selectedSumField)]]</template>
              <template>[[_prettify(item.max)]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">avg [[selectedSumField]] [[_specifyUnits(selectedSumField)]]</template>
              <template>[[_prettify(item.avg)]]</template>
            </vaadin-grid-column>
          </vaadin-grid>
          </div>
        </div>
    </div>
    </div>
    </iron-pages>
    </app-header-layout>
    </app-drawer-layout>
    </template>

  <script>

    class ThreePolymerWireframe extends Polymer.Element {

      static get is() {
        return 'three-polymer-wireframe-app';
      }

      static get properties() {
        return {
          authHeaders: {
            type: Object,
            value: {}
          },
          baseUrl: {
            type: String,
            //CI pipeline will replace with the production api link
            value: _BACKEND_URL_,
            readOnly: true
          },
          selectedModel: {
            type: String
          },
          currentModelResp: {
            type: Object
          },
          userEmail: {
            type: String
          },
          selectedContourBy: {
            type: String,
            value: "flexure"
          },
          boundaries: {
            type: Object
          },
          geometryFilter: {
            type: Object
          },
          dataOptions: {
            type: Array,
            value: []
          },
          _filtersDisabled: {
            type: Boolean,
            value: false
          },
          _modelData: {
            type: Object,
            value: {}
          },
          modelLoading: {
            type: Boolean
          },
          appLoading: {
            type: Boolean,
            value: true
          },
          _acceptUploadDisabled: {
            type: Boolean,
            value: true
            //notify: true
          },
          jsonUploadPayload: {
            type: Object,
            value: {}
          },
          metadataFields: {
            type: Array,
            value: []
          },
          avgResult: {
            type: Number,
            value: 0
          },
          minResult: {
            type: Number,
            value: 0
          },
          maxResult: {
            type: Number,
            value: 0
          },
          getAvgLabel: {
            type: String,
            value: "average"
          },
          getMinLabel: {
            type: String,
            value: "min value"
          },
          getMaxLabel: {
            type: String,
            value: "max value"
          },
          totalResult : {
            type: Number,
            value: 0
          },
          allObjectsByGroup: {
            type: Array,
            value: []
          },
          numericalAggregationsTableData: {
            type: Array,
            value: []
          },
          grandTotalSum : {
            type: Number,
            value: 0
          },
          totalCost: {
            type: Number,
            value: 0
          },
          getTotalResultLabel: {
            type: String,
            value: "total"
          },
          groupSumData: {
            type: Array,
            value: []
          },
          pieChart: {
            type: Object
          },
          pieData: {
            type: Array
          },
          costCoefficient: {
            type: Number
          },
          selectedView: {
            type: String,
            value: 'model-view'
          },
          selectedSumField: {
            type: String
          },
          showNumericalAggregations: {
            type: Boolean,
            value: false
          },
          showStringAggregations: {
            type: Boolean,
            value: false
          }
        };
      }

      static get observers() {
        return [
          '_boundariesChanged(boundaries.*)',
          '_loadingChanged(modelLoading)',
          '_contourPropsChanged(metadataFields)',
          '_getModelData(selectedModel)',
          '_aggregations(_modelData,selectedContourBy)',
          '_getAggregationLabels(_modelData, selectedContourBy)',
          '_getSumByForSelectedSumField(selectedSumField)',
          '_drawChart(pieData)',
          '_delayChartResize(selectedView, selectedContourBy)'
        ]
      }

      constructor() {
        super();
      }

      logout() {
        this.dispatchEvent(new CustomEvent('logout', {bubbles: true, composed: true}))
      }

      uploadJsonModel() {
        var that = this
        that.$['json-upload-request'].generateRequest();
        that._clearUploadInput()
        this.$.uploadSuccessToast.show({ text: "File has been uploaded successfully!" })
        this.userEmail = ''
      }

      reopenUploadBox(){
        this.$.validationToast.hide()
        Polymer.dom(this.root).querySelector('#addModelDialog').open();
      }

      closeToast() {
        this.$.validationToast.hide()
        this.userEmail = ''
      }

      handleJsonUpload(evt) {
        var inputFile = this.$.modelUpload.files[0]
        var fileName = inputFile.name
        var fileNameNoExtension = fileName.slice(0, fileName.lastIndexOf('.'))
        var extension = fileName.slice(fileName.indexOf('.'))
      	var reader = new FileReader()
        var that = this;
        // Capture the file information
        reader.onload = (function (theFile) {
    			return function (e) {
    				// console.log('e readAsText = ', e);
    				// console.log('e readAsText target = ', e.target);
              //validation
            try {
              //check extension
              if (fileName.slice(-5) !== ".json")
              throw "file has a " + "\"'" + extension  + "'\"" + " extension, but must be a .json file."
              // check that this json has not already been uplaoded
              if (_.includes(_.map(that.dataOptions,'model'), fileNameNoExtension))
              throw "a file with the name " + "\"'" + fileNameNoExtension + "'\"" + " has already been uploaded."
              //parse JSON
              that.jsonUploadPayload = JSON.parse(e.target.result)
              // check that file name matches name in doc
              if (_.toLower(that.jsonUploadPayload.modelInformation.name) + ".json"!== _.toLower(fileName))
              throw "file name is "  + "\"'" + fileName + "'\"" + " and modelInformation.name is " + "\"'" + that.jsonUploadPayload.modelInformation.name + "'\"" + ". These must match."
              // check that modelInfo keys exists
              if (_.has(that.jsonUploadPayload, 'modelInformation') === false)
              throw "it is missing a 'modelInformation' key. This property is required."
              // check that payload key exists
              if (_.has(that.jsonUploadPayload, 'payload') === false)
              throw "it is missing payload key. This property is required."
              // check that modelInfo has units and name keys
              if (_.has(that.jsonUploadPayload, 'modelInformation.units') === false)
              throw "modelInformation must contain a 'units' key."
              if (_.has(that.jsonUploadPayload, 'modelInformation.name') === false)
              throw "modelInformation must contain a 'name' key."
              //add email of user uploading file
              that.jsonUploadPayload.modelInformation.user = that.userEmail
              // check that units are either metric or imperial only
              if (!(that.jsonUploadPayload.modelInformation.units === "metric" ||
              that.jsonUploadPayload.modelInformation.units === "imperial"))
              throw "units values must be either 'imperial' or 'metric'. " + "\"'" + that.jsonUploadPayload.modelInformation.units + "'\"" + " is not a valid unit type."
              var payloadElems = that.jsonUploadPayload.payload
              for (var i=0; i < payloadElems.length; i++) {
                // go through payload elements and ensure each has vertices and metadata keys
                if (_.has(payloadElems[i], 'vertices') === false ||
                    _.has(payloadElems[i], 'metadata') === false) {
                  throw "payload must include both a 'vertices' and 'metadata' key for each element."
                }
              }
            //if it does not get stuck on any errors above, it'll make it to the below
              that._checkEmailField()
            } catch (err) {
                that._clearUploadInput()
                var toast = Polymer.dom(that.root).querySelector('#validationToast')
                toast.show({ text: "File could not be uploaded because " + err })
                Polymer.dom(that.root).querySelector('#addModelDialog').close();
            }
          }
        })(inputFile);
        reader.readAsText(inputFile);
      }

      _checkEmailField(userEmail) {
        userEmail = this.jsonUploadPayload.modelInformation.user
        try {
          if (_.isEmpty(userEmail)) {
            throw "you must include your email"
          }
          this._acceptUploadDisabled = false;
        } catch (err) {
          throw err
        }
      }
      //clear upload input and disable accept button
      _clearUploadInput() {
        Polymer.dom(this.root).querySelector('#modelUpload').value = ''
        this._acceptUploadDisabled = true;
      }

      _isWithinBounds(val, min, max) {
        return val >= min && val <= max
      }

      _prettify(n) {
        return typeof(n) !== 'undefined' ? parseFloat(n).toLocaleString() : ""
      }

      _prettifyDollar(n) {
        return typeof(n) !== 'undefined' ? n.toLocaleString('en-US', { style: 'currency', currency: 'USD' }) : ""
      }

      _dropdownUnitLabel(item, unitType) {
        var that = this;
        item = _.toLower(item)
        unitType = _.toLower(that.currentModelResp.modelInformation.units)
        if (item.includes('area')) {
          return unitType === 'imperial' ? item + ' (in\u00B2)' : item + ' (mm\u00B2)'
        } else if (item.includes('length')) {
          return unitType === 'imperial' ? item + ' (in)' : item + ' (mm)'
        } else if (item.includes('mass')) {
          return unitType === 'imperial' ? item + ' (lb)' : item + ' (kg)'
        } else if (item.includes('vol')) {
          return unitType === 'imperial' ? item + ' (in\u00B3)' : item + ' (mm\u00B3)'
        } else {
          return item
        }
      }

      _numericalAggUnitLabels(measurement, unitType) {
        var that = this;
        measurement = _.toLower(that.selectedContourBy)
        unitType = _.toLower(that.currentModelResp.modelInformation.units)
        if (measurement.includes('area')) {
          return unitType === 'imperial' ? that.unitLabel = ' (in\u00B2)' : that.unitLabel = ' (mm\u00B2)'
        } else if (measurement.includes('length')) {
          return unitType === 'imperial' ? that.unitLabel = ' (in)' : that.unitLabel = ' (mm)'
        } else if (measurement.includes('mass')) {
          return unitType === 'imperial' ? that.unitLabel = ' (lb)' : that.unitLabel = ' (kg)'
        } else if (measurement.includes('vol')) {
          return unitType === 'imperial' ? that.unitLabel = ' (in\u00B3)' : that.unitLabel = ' (mm\u00B3)'
        } else if (measurement.includes('cost')) {
          return unitType === 'imperial' ? that.unitLabel = ' (USD)' : that.unitLabel = ''
        } else {
          return ''
        }
      }

      _specifyUnits(measurement, unitType) {
        var that = this;
        measurement = _.toLower(that.selectedSumField)
        unitType = _.toLower(that.currentModelResp.modelInformation.units)
        if (measurement.includes('length')) {
          return unitType === 'imperial' ? that.unitLabel =' (in)' : that.unitLabel =' (mm)'
        } else if (measurement.includes('mass')) {
          return unitType === 'imperial' ? that.unitLabel =' (lb)' : that.unitLabel =' (kg)'
        } else if (measurement.includes('vol')) {
          return unitType === 'imperial' ? that.unitLabel =' (in\u00B3)' : that.unitLabel =' (mm\u00B3)'
        } else if (measurement.includes('cost')) {
          return unitType === 'imperial' ? that.unitLabel =' (USD)' : that.unitLabel = ''
        } else {
          return ''
        }
      }

      //for strOtherUnitLabel
      _strOtherUnitLabel(unitType, unitLabel) {
        if (this.currentModelResp.modelInformation.units === 'imperial') {
          //mass
          if (this.unitLabel === ' (lb)') {
          this.strOtherUnitLabel = ' (ton)'
          //vol
        } else if (this.unitLabel === ' (in\u00B3)') {
          this.strOtherUnitLabel = ' (yd\u00B3)'
        }
      } else if (this.currentModelResp.modelInformation.units === 'metric') {
          //mass
          if (this.unitLabel === ' (kg)') {
            this.strOtherUnitLabel = ' (tonne)'
            //vol
          } else if (this.unitLabel === ' (mm\u00B3)') {
            this.strOtherUnitLabel = ' (m\u00B3)'
          }
        }
      }

      _numericalAggregations() {
        this.showStringAggregations = false;
        var that = this;
        var resultFilterInput = _.filter(that._modelData.linearElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
              that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
              that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        this.minResult = _.round(_.minBy(resultFilterInput, function(o) {
          return o.metadata[that.selectedContourBy]
        }).metadata[this.selectedContourBy], 3)
        this.maxResult = _.round(_.maxBy(resultFilterInput, function(o) {
          return o.metadata[that.selectedContourBy]
        }).metadata[this.selectedContourBy], 3)
        this.avgResult = _.round(_.meanBy(resultFilterInput, function(o) {
          return o.metadata[that.selectedContourBy]
        }), 3);
        this._getAggregationLabels()
        this.numericalAggregationsTableData = []
        var name = [this.getMinLabel, this.getMaxLabel, this.getAvgLabel];
        var result = [this.minResult, this.maxResult, this.avgResult];
        for (var i=0; i < name.length; i++) {
          var setup = {
            'name': name[i],
            'result': result[i]
          }
          this.push('numericalAggregationsTableData', setup)
        }
        this.totalResult = _.round(_.sumBy(resultFilterInput, function(o) {
          return o.metadata[that.selectedContourBy]
        }), 3);
        this.showNumericalAggregations = true;
      }

      _getSumByForSelectedSumField(_selectedSumField) {
        this.numericalMetadataKeys = this.numericalMetadataKeys
        if (typeof this.selectedSumField !== 'undefined') {
          this._stringAggregations();
        }
        return
      }


      _stringAggregations() {
        this.showNumericalAggregations = false;
        var that = this
        // ================ repeated function start ==========================================
        var resultFilterInput = _.filter(that._modelData.linearElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
              that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
              that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        // ================ repeated function end ==========================================
        //console.log(resultFilterInput);
        var resultGroupByName = _.groupBy(resultFilterInput, function(o) {
          return o.metadata[that.selectedContourBy]
        })
        // console.log("RESULTGROUPBYNAME");
        // console.log(resultGroupByName);
        this.groupKeys = _.without(_.keys(resultGroupByName), 'undefined')
        if(typeof this.selectedSumField === 'undefined') {
          this.allObjectsByGroup = []
          // console.log("ALL OBJECTS BY GROUP ONCE");
          // console.log(this.allObjectsByGroup);
          for (var i = 0; i < this.groupKeys.length; i++) {
            var groupObjects = resultGroupByName[this.groupKeys[i]]
            this.push('allObjectsByGroup', groupObjects)
        }
        var _numericalMetadataKeys = []
        var totalGroupObjects = _.flatten(this.allObjectsByGroup)
        for (var i = 0; i < totalGroupObjects.length; i++) {
          var metadataObject = totalGroupObjects[i].metadata
          var metadataValues = _.values(metadataObject)
          var metadataKeys = _.keys(metadataObject)
           for (var j = 0; j < metadataKeys.length; j++) {
            //to include only these in dropdown menu
            var validSumGroups = ['meta_length', 'length', 'meta_mass', 'mass', 'meta_vol', 'vol', 'volume']
            //but also do an "includes/contains" because names could vary
             // to find unique keys with numeric values for dropdown options
             if(_.isNumber(metadataValues[j]) && _numericalMetadataKeys.indexOf(metadataKeys[j]) === -1 && validSumGroups.indexOf(metadataKeys[j]) !== -1) {
               _numericalMetadataKeys.push(metadataKeys[j])
             }
             this.set('numericalMetadataKeys', _numericalMetadataKeys.sort())
           }
         }
         this.selectedSumField = this.numericalMetadataKeys[0]
       } else {
        var _groupSumData = []
        this.allObjectsByGroupDupe = []
        // console.log("ALL OBJECTS BY GROUP SECOND");
        // console.log(this.allObjectsByGroupDupe);
        for (var i = 0; i < this.groupKeys.length; i++) {
          //reusing var groupObjects below (was local variable in previous loop for numericalMetadataKeys)
          var groupObjects = resultGroupByName[this.groupKeys[i]]
          var elemsPerGroup = groupObjects.length
          var sumByGroup = _.round(_.sumBy(groupObjects, function(o) {
            return o.metadata[that.selectedSumField]
          }), 1)
          var minByGroup = _.round(_.minBy(groupObjects, function(o) {
            return o.metadata[that.selectedSumField]
          }).metadata[that.selectedSumField], 1)
          var maxByGroup = _.round(_.maxBy(groupObjects, function(o) {
            return o.metadata[that.selectedSumField]
          }).metadata[that.selectedSumField], 1)
          var avgByGroup = _.round(_.meanBy(groupObjects, function(o) {
            return o.metadata[that.selectedSumField]
          }), 0);
          //for conversion
          if (that.currentModelResp.modelInformation.units === 'imperial') {
              if (that.selectedSumField.includes('mass')) {
              this.strOtherUnitSum = _.round(sumByGroup/2000, 3)
            } else if (that.selectedSumField.includes('vol')) {
              this.strOtherUnitSum = _.round(sumByGroup/46656, 3)
            }
            } else if (that.currentModelResp.modelInformation.units === 'metric') {
              if (that.selectedSumField.includes('mass')) {
                this.strOtherUnitSum = _.round(sumByGroup/1000, 3)
              } else if (that.selectedSumField.includes('vol')) {
                this.strOtherUnitSum = _.round(sumByGroup/1000000000, 3)
              }
            }
            var groupSumDataSetup = {
              'group': this.groupKeys[i],
              'elemsPerGroup': elemsPerGroup,
              'sum': sumByGroup,
              'otherUnitSum': this.strOtherUnitSum,
              'min' : minByGroup,
              'max' : maxByGroup,
              'avg' : avgByGroup
            }
            _groupSumData.push(groupSumDataSetup)
            this.push('allObjectsByGroupDupe', groupObjects)
          }
          this.set('groupSumData', _.sortBy(_groupSumData, [function(o) { return o.group }]))
          this._strOtherUnitLabel()
          // for chart total sum by group
          this.totalElements = _.round(_.sumBy(this.groupSumData, function(o) {
            return o.elemsPerGroup
          }), 0)
          this.grandTotalSum = _.round(_.sumBy(this.groupSumData, function(o) {
            return o.sum
          }), 0)
          this.grandTotalOtherUnitSum = _.round(_.sumBy(this.groupSumData, function(o) {
            return o.otherUnitSum
          }), 0)
          // for pie chart
          var _pieData = []
          for (var i=0; i < this.groupSumData.length; i++) {
            var item = this.groupSumData[i]
            _pieData.push([item.group, parseFloat(item.sum)])
            }
          this.pieData = _pieData;
        }
        //log unit type
        //console.log(this.currentModelResp.modelInformation.units)
        this.showStringAggregations = true;
      }


      _aggregations(_modelData, selectedContourBy) {
        if (this._isNumberField(_modelData, selectedContourBy)) {
          this._numericalAggregations();
          return
        }
        if (this._isStringField(_modelData, selectedContourBy)) {
          this._stringAggregations();
          return
        }
        this.showStringAggregations = false;
        this.showNumericalAggregations = false;
      }

      _getAggregationLabels() {
        if (typeof this.selectedContourBy === 'undefined' || typeof this.selectedModel === 'undefined') {
          this.getAvgLabel = "Avg unavailable"
          this.getMinLabel = "Min unavailable"
          this.getMaxLabel = "Max unavailable"
          this.getTotalResultLabel = "Total unavailable"
        } else {
          this.getAvgLabel = "Avg " + _.capitalize(this.selectedContourBy)
          this.getMinLabel = "Min " + _.capitalize(this.selectedContourBy)
          this.getMaxLabel = "Max " + _.capitalize(this.selectedContourBy)
          this.getTotalResultLabel = "Total " + _.capitalize(this.selectedContourBy)
        }
      }

      _initChart() {
        var chartdiv = Polymer.dom(this.root).querySelector("#chart-container")
        this.pieChart = Highcharts.chart(chartdiv, {
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false,
            type: 'pie'
        },
        title: {
            text: 'Sum by Group'
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: false
                },
                showInLegend: true
            }
        },
        series: [{
            name: 'Sum',
            colorByPoint: true,
            data: []
          }]
        });
      }

      _hideColumn(_stringDropdown) {
        return this.selectedSumField.includes('length')
      }

      _drawChart() {
        var chartdiv = Polymer.dom(this.root).querySelector("#chart-container")
        this.pieChart = Highcharts.chart(chartdiv, {
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false,
            type: 'pie'
        },
        title: {
            text: 'Sum by Group',
            align: 'right'
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: false
                },
                showInLegend: true
            }
        },
        legend: {
          layout: 'vertical',
          align: 'right',
          verticalAlign: 'top',
          y: 40,
        },
        series: [{
            name: 'Sum',
            colorByPoint: true,
            colors: ['#7cb5ec', '#434348', '#90ed7d', '#f7a35c', '#8085e9',
                    '#f15c80', '#e4d354', '#2b908f', '#f45b5b', '#91e8e1', '#2f7ed8', '#0d233a', '#8bbc21', '#910000', '#1aadce',
                    '#492970', '#f28f43', '#77a1e5', '#c42525', '#a6c96a', '#4572A7', '#AA4643', '#89A54E', '#80699B', '#3D96AE',
                    '#DB843D', '#92A8CD', '#A47D7C', '#B5CA92'],
            data: this.pieData
          }]
        });
        //console.log(this.pieChart.series[0].userOptions.data);
      }

      _delayChartResize() {
        var that = this;
        setTimeout(function() {
          that.pieChart.reflow()
        }, 0)
      }

      ready() {
        super.ready();
        this.$['get-models-request'].generateRequest();
        this._initChart();
      }

      createNumericalCsv() {
        var rowData = ''
        if (this.numericalAggregationsTableData.length > 0) {
          for (var i=0; i < this.numericalAggregationsTableData.length; i++) {
            this.numDataHeaders = _.keys(this.numericalAggregationsTableData[i])
            var el = [_.values(this.numericalAggregationsTableData[i])] + '\r\n'
          	rowData += el
          }
          var that = this;
          var headers_ = _.map(this.numDataHeaders, function(h) {
            if (h === 'name') {
              return h
            }
            return h + that.unitLabel
          })
          this.numDataHeaders = headers_ + '\r\n'
          var currentFilters = "Filters:" + '\r\n' +
          'min x, ' + this.geometryFilter.xMin + '\r\n' + 'max x, ' + this.geometryFilter.xMax + '\r\n' +
          'min y, ' + this.geometryFilter.yMin + '\r\n' + 'max y, ' + this.geometryFilter.yMax + '\r\n' +
          'min z, ' + this.geometryFilter.zMin + '\r\n' + 'max z, ' + this.geometryFilter.zMax
          var csvData = this.numDataHeaders + rowData + '\r\n' + currentFilters
          var uri = 'data:text/csv;charset=utf-8,' + escape(csvData);
          var link = document.createElement("a");
          link.href = uri;
          link.style = "visibility:hidden";
          var d = new Date();
          var curr_date = (d.getDate() < 9 ? '0': '') + (d.getDate()+1)
          var curr_month = (d.getMonth() < 9 ? '0': '') + (d.getMonth()+1)
          var curr_year = d.getFullYear();
          var curr_year_formatted = curr_year.toString().substring(2)
          var curr_hour = (d.getHours() < 9 ? '0': '') + d.getHours()
          var currMins = (d.getMinutes() < 9 ? '0': '') + d.getMinutes()
          var timeFormat = curr_year_formatted + curr_month + curr_date + "_" + curr_hour + currMins
          link.download = this.selectedModel + " " + timeFormat + ".csv";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }

      createGroupDataCsv() {
        var rowData = ''
        if (this.groupSumData.length > 0) {
          for (var i=0; i < this.groupSumData.length; i++) {
            this.groupDataHeaders = _.keys(this.groupSumData[i])
            var el = [_.values(this.groupSumData[i])] + '\r\n'
            rowData += el
          }
          var that = this;
          var headers_ = _.map(this.groupDataHeaders,function(h) {
            if (h === 'group') {
              return h
            } if (h === 'elemsPerGroup') {
              return "elements per group"
            } if (h === 'otherUnitSum' && that.selectedSumField.includes('length')) {
              return ''
            } if (h === 'otherUnitSum') {
              return that.selectedSumField + " sum " + that.strOtherUnitLabel
            }
            return that.selectedSumField + " " + h + that.unitLabel
          })
          this.groupDataHeaders = headers_ + '\r\n';
          var currentFilters = "Filters:" + '\r\n' +
          'min x, ' + this.geometryFilter.xMin + '\r\n' + 'max x, ' + this.geometryFilter.xMax + '\r\n' +
          'min y, ' + this.geometryFilter.yMin + '\r\n' + 'max y, ' + this.geometryFilter.yMax + '\r\n' +
          'min z, ' + this.geometryFilter.zMin + '\r\n' + 'max z, ' + this.geometryFilter.zMax
          var csvData = this.groupDataHeaders + rowData + '\r\n' + currentFilters
          var uri = 'data:text/csv;charset=utf-8,' + escape(csvData);
          var link = document.createElement("a");
          link.href = uri;
          link.style = "visibility:hidden";
          var d = new Date();
          var curr_date = (d.getDate() < 9 ? '0': '') + (d.getDate()+1)
          var curr_month = (d.getMonth() < 9 ? '0': '') + (d.getMonth()+1)
          var curr_year = d.getFullYear();
          var curr_year_formatted = curr_year.toString().substring(2)
          var curr_hour = (d.getHours() < 9 ? '0': '') + d.getHours()
          var currMins = (d.getMinutes() < 9 ? '0': '') + d.getMinutes()
          var timeFormat = curr_year_formatted + curr_month + curr_date + "_" + curr_hour + currMins
          link.download = this.selectedModel + " " + timeFormat + ".csv";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }

      _hideMainDropdown(_currentPage) {
        return this.selectedView == 'aggregations-view';
      }

      _hideCsvButton(_currentPage) {
        return this.selectedView == 'model-view'
      }

      //Ensure that the geometry input is within boundaries and is compatible with its input sibling
      _computeMin(_b, _g) {
        _g = parseFloat(_g)
        if (_.isNumber(_g)) {
          return (_g > _b) ? _g : _b
        }
        return _b
      }

      _computeMax(_b, _g) {
        _g = parseFloat(_g)
        if (_.isNumber(_g)) {
          return (_g < _b) ? _g : _b
        }
        return _b
      }

      _boundariesChanged(boundaries) {
        this.resetFilters();
      }

      _loadingChanged(modelLoading) {
        this.checkValidInput();
      }

      _contourPropsChanged(metadataFields) {
        this.metadataFields = this.metadataFields.sort()
        if (this.metadataFields.indexOf(this.selectedContourBy) === -1) {
          this.selectedContourBy = undefined;
          if (this.metadataFields.length > 0) {
            var that = this;
            setTimeout(function() {
              that.selectedContourBy = that.metadataFields[0];
            }, 0);
          }
        }
      }

      _isNumberField(_modelData, selectedContourBy) {
        return !_.isEmpty(_modelData.linearElements) && this.selectedContourBy && _.isNumber(_modelData.linearElements[0].metadata[this.selectedContourBy])
      }

      _isStringField(_modelData, selectedContourBy) {
        return !_.isEmpty(_modelData.linearElements) && typeof this.selectedContourBy !== 'undefined' && !_.isNumber(_modelData.linearElements[0].metadata[this.selectedContourBy])
      }

      isLoadingState(modelLoading, appLoading) {
        return modelLoading || appLoading
      }

      checkValidInput() {
        //console.log(this.geometryFilter)
        if (!_.isEmpty(this.geometryFilter) && !_.isEmpty(this.boundaries) && !this.modelLoading && _.every(_.values(this.geometryFilter), function(o) {
            return o !== ""
          })) {
          this._filtersDisabled =
            parseFloat(this.geometryFilter.xMin) < this.boundaries.xMin || parseFloat(this.geometryFilter.xMin) > this.geometryFilter.xMax ||
            parseFloat(this.geometryFilter.yMin) < this.boundaries.yMin || parseFloat(this.geometryFilter.yMin) > this.geometryFilter.yMax ||
            parseFloat(this.geometryFilter.zMin) < this.boundaries.zMin || parseFloat(this.geometryFilter.zMin) > this.geometryFilter.zMax ||
            parseFloat(this.geometryFilter.xMax) > this.boundaries.xMax ||
            parseFloat(this.geometryFilter.yMax) > this.boundaries.yMax ||
            parseFloat(this.geometryFilter.zMax) > this.boundaries.zMax
        } else {
          this._filtersDisabled = true;
        }
      }

      resetFilters() {
        this.geometryFilter = _.cloneDeep(this.boundaries);
        this.checkValidInput();
        this._aggregations(this._modelData, this.selectedContourBy);
      }

      applyFilters() {
        this.geometryFilter = {
          'xMin': parseFloat(this.geometryFilter.xMin),
          'xMax': parseFloat(this.geometryFilter.xMax),
          'yMin': parseFloat(this.geometryFilter.yMin),
          'yMax': parseFloat(this.geometryFilter.yMax),
          'zMin': parseFloat(this.geometryFilter.zMin),
          'zMax': parseFloat(this.geometryFilter.zMax)
        }
        this._aggregations(this._modelData, this.selectedContourBy)
      }

      _initData(dataOptions_) {
        this.set('dataOptions', dataOptions_);
        if (this.dataOptions.length > 0) {
          this.set('selectedModel', this.dataOptions[0].model)
        }
      }

      handleOptionsResponse(event, response) {
        this.getModelsResp = response.response
        var resp = response.response;
        if (resp) {
          this.appLoading = false
          this._initData(resp);
        } else {
          this.handleOptionsError();
        }
      }

      handleOptionsError(event, response) {
        this.appLoading = false;
        this._initData([]);
        alert("Couldn't fetch data.  Please check your internet connection");
      }

      handleDataResponse(event, response) {
        this.currentModelResp = response.response
        if (this.currentModelResp && this.currentModelResp.modelInformation.name === this.selectedModel && "payload" in this.currentModelResp) {
          this.appLoading = false;
          this.set('_modelData', {
            'linearElements': this.currentModelResp.payload,
            'planarElements': []
            // 'linearElements': this.currentModelResp.payload.linearElements,
            // 'planarElements': this.currentModelResp.payload.planarElements
          });
          //set selectedSumField to undefined in order to trigger stringAggregtions initialization
          this.selectedSumField = undefined
          //console.log(this._modelData)
        } else {
          this.handleDataError()
        }
      }

      handleDataError(event, response) {
        this.appLoading = false;
        alert("couldn't retrieve " + this.selectedModel)
      }

      _getModelData(_selectedModel) {
        this.viewData = {
             "linearElements": [],
             "planarElements": []
        }
        this.$['model-request'].url = this.baseUrl + "get-model-data/" + this.selectedModel
        this.$['model-request'].generateRequest();
        this.appLoading = true;
      }

      showDialog() {
        this.$.addModelDialog.open();
      }

      handleUploadResponse(event, response) {
        var resp = response.response;
        if ("success" in resp) {
          this.$['get-models-request'].generateRequest();
        }
      }
    }

    window.customElements.define(ThreePolymerWireframe.is, ThreePolymerWireframe);
  </script>
</dom-module>

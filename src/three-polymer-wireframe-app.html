<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/three-polymer/three-view/three-view.html">
<link rel="import" href="../bower_components/three-polymer/three-model/three-model.html">
<link rel="import" href="my-icons.html">

<dom-module id="three-polymer-wireframe-app">
  <template>
    <style>
      :host {
        --app-primary-color: #4285f4;
        --app-secondary-color: black;

        display: block;
      }

      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }

      app-header {
        color: #fff;
        background-color: var(--app-primary-color);
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      .drawer-list {
        margin: 0 20px;
      }

      .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }

      .three-container {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        height: 100%;
      }

      #view {
        @apply(--layout-self-center);
        @apply(--shadow-elevation-2dp);
      }

      #filter-container {
        margin-top: 60px;
      }

      .horizontal {
        @apply(--layout-horizontal);
      }

      .inline-input {
        padding: 0.1em;
        @apply(--layout-flex);
      }

      .dropdown-item {
        cursor: pointer;
      }

      paper-dialog#addModelDialog {
        padding: 1em;
      }
    </style>
    <iron-ajax auto url="/data/test_response.json" handle-as="json" on-response="handleResponse" on-error="handleError"></iron-ajax>
    <paper-dialog modal id="addModelDialog">
      <h2>Add a Model</h2>
      <paper-input label="JSON file" type="file"></paper-input>
      <paper-input label="meta val" type="text"></paper-input>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Accept</paper-button>
      </div>
    </paper-dialog>
    <app-drawer-layout fullbleed>
      <!-- Drawer content -->
      <app-drawer id="drawer" slot="drawer">
        <app-toolbar>
          <paper-item>Model Options</paper-item>
        </app-toolbar>
        <div class="drawer-list">
          <paper-dropdown-menu label="Model">
            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedModel}}">
              <template is="dom-repeat" items="[[data]]">
                <paper-item class="dropdown-item" name="{{item.id}}">{{item.id}}</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
          <paper-dropdown-menu label="Contour">
            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
              <paper-item class="dropdown-item" name="axial">Axial</paper-item>
              <paper-item class="dropdown-item" name="flexure">Flexure</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
          <div id="filter-container">
          <paper-item>Model Filters</paper-item>
            <div class="horizontal">
              <paper-input on-invalid-changed="inputBeyondBoundaries" auto-validate label="min x" class="inline-input" type="number" value="{{geometryFilter.xMin}}" max="[[boundaries.xMax]]" min="[[boundaries.xMin]]"></paper-input>
              <paper-input on-invalid-changed="inputBeyondBoundaries" auto-validate label="max x" class="inline-input" type="number" value="{{geometryFilter.xMax}}" max="[[boundaries.xMax]]" min="[[boundaries.xMin]]"></paper-input>
            </div>
            <div class="horizontal">
              <paper-input on-invalid-changed="inputBeyondBoundaries" auto-validate label="min y" class="inline-input" type="number" value="{{geometryFilter.yMin}}" max="[[boundaries.yMax]]" min="[[boundaries.yMin]]"></paper-input>
              <paper-input on-invalid-changed="inputBeyondBoundaries" auto-validate label="max y" class="inline-input" type="number" value="{{geometryFilter.yMax}}" max="[[boundaries.yMax]]" min="[[boundaries.yMin]]"></paper-input>
            </div>
            <div class="horizontal">
              <paper-input on-invalid-changed="inputBeyondBoundaries" auto-validate label="min z" class="inline-input" type="number" value="{{geometryFilter.zMin}}" max="[[boundaries.zMax]]" min="[[boundaries.zMin]]"></paper-input>
              <paper-input on-invalid-changed="inputBeyondBoundaries" auto-validate label="max z" class="inline-input" type="number" value="{{geometryFilter.zMax}}" max="[[boundaries.zMax]]" min="[[boundaries.zMin]]"></paper-input>
            </div>
            <div class="horizontal">
              <paper-button disabled$="{{_filtersDisabled}}" id="applyBtn" on-tap="applyFilters">Apply</paper-button>
              <paper-button id="resetBtn" on-tap="resetFilters">Reset</paper-button>
            </div>
          </div>
        </div>
      </app-drawer>

      <!-- Main content -->
      <app-header-layout has-scrolling-region>

        <app-header slot="header" condenses reveals effects="waterfall">
          <app-toolbar>
            <paper-icon-button icon="my-icons:menu" drawer-toggle></paper-icon-button>
            <div main-title>Arup Model QuickView</div>
            <div class="spacer"></div>
            <paper-icon-button on-tap="showDialog" icon="my-icons:add"></paper-icon-button>
          </app-toolbar>
        </app-header>
        <div class="three-container">
          <three-view id="view" scene-background-color="#F5F5F5">
            <three-model id="model" slot="model" is-loading="{{modelLoading}}" contour-by="[[selectedContourBy]]" boundaries="{{boundaries}}" geometry-filter="{{geometryFilter}}" data="[[getModelData(selectedModel)]]">
            </three-model>
          </three-view>
        </div>
      </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>
    class ThreePolymerWireframe extends Polymer.Element {

      static get is() {
        return 'three-polymer-wireframe-app';
      }

      static get properties() {
        return {
          /*         page: {
                      type: String,
                      reflectToAttribute: true,
                      observer: '_pageChanged',
                    },
                    rootPattern: String,
                    routeData: Object,
                    subroute: String,*/
          selectedModel: {
            type: String
          },
          selectedContourBy: {
            type: String,
            value: "flexure"
          },
          boundaries: {
            type: Object
          },
          geometryFilter: {
            type: Object
          },
          data: {
            type: Array,
            value: []
          },
          _filtersDisabled: {
            type: Boolean,
            value: false
          },
          modelLoading: {
            type: Boolean
          }
        };
      }

    //aggregation
    // _.meanBy(payload, function(o) {return o.metadata[this.selectedContourBy]})
    //
    // _mean() {
    //   var that = this;
    //   _.meanBy(payload, function(o) {return o.metadata[that.selectedContourBy]})
    // }

      static get observers() {
        return [
          '_boundariesChanged(boundaries.*)',
          '_loadingChanged(modelLoading)'
        ]
      }

      constructor() {
        super();
      }

      resetFilters() {
        this.geometryFilter = _.cloneDeep(this.boundaries)
        //reset filter selection to the model boundaries
        //console.log(this.geometryFilter)
        //console.log(this.boundaries)
      }

      _boundariesChanged(boundaries) {
        this.resetFilters();
      }

      _loadingChanged(modelLoading) {
        //console.log(modelLoading)
        this.inputBeyondBoundaries();
      }

      inputBeyondBoundaries() {
        if (this.modelLoading) {
          this._filtersDisabled = true;
        }
        else {
          this._filtersDisabled =
            this.geometryFilter.xMin < this.boundaries.xMin ||
            this.geometryFilter.yMin < this.boundaries.yMin ||
            this.geometryFilter.zMin < this.boundaries.zMin ||
            this.geometryFilter.xMax > this.boundaries.xMax ||
            this.geometryFilter.yMax > this.boundaries.yMax ||
            this.geometryFilter.zMax > this.boundaries.zMax
        }
      }

      applyFilters() {
        //this clone below works, but it turns values into strings. must parseFloat *values*. -rsc
        // this.geometryFilter = _.cloneDeep(this.geometryFilter)
        //parse filter selection and pass the range to three-model
        if (this.geometryFilter.xMin >= this.boundaries.xMin &&
          this.geometryFilter.yMin >= this.boundaries.yMin &&
          this.geometryFilter.zMin >= this.boundaries.zMin &&
          this.geometryFilter.xMax <= this.boundaries.xMax &&
          this.geometryFilter.yMax <= this.boundaries.yMax &&
          this.geometryFilter.zMax <= this.boundaries.zMax) {

            this.geometryFilter = {
              'xMin': parseFloat(this.geometryFilter.xMin),
              'xMax': parseFloat(this.geometryFilter.xMax),
              'yMin': parseFloat(this.geometryFilter.yMin),
              'yMax': parseFloat(this.geometryFilter.yMax),
              'zMin': parseFloat(this.geometryFilter.zMin),
              'zMax': parseFloat(this.geometryFilter.zMax)
            }
          //console.log(this.geometryFilter)
          //console.log(this.boundaries)
        }
      }

      _initData(data_) {
        this.set('data', data_);
        if (this.data.length > 0) {
          this.set('selectedModel', this.data[0].id)
        }
      }

      handleResponse(event, response) {
        var resp = response.response;
        if (resp) {
          this._initData(resp);
        } else {
          this.handleError();
        }
      }

      handleError(event, response) {
        this._initData([{
          "id": "Model A",
          "payload": [{
            "vertices": [
              [-10, 0, -10],
              [-10, 0, 10]
            ],
            "metadata": {
              "axial": 10,
              "flexure": 40
            }
          }, {
            "vertices": [
              [-10, 0, 10],
              [10, 0, 10]
            ],
            "metadata": {
              "axial": 40,
              "flexure": 55
            }
          }, {
            "vertices": [
              [10, 0, 10],
              [10, 0, -10]
            ],
            "metadata": {
              "axial": 100,
              "flexure": 20
            }
          }]
        }, {
          "id": "Model B",
          "payload": [{
            "vertices": [
              [-10, 0, -10],
              [-10, 0, 10]
            ],
            "metadata": {
              "axial": 40,
              "flexure": 20
            }
          }, {
            "vertices": [
              [-10, 0, 10],
              [10, 0, 10]
            ],
            "metadata": {
              "axial": 10,
              "flexure": 55
            }
          }, {
            "vertices": [
              [10, 0, 10],
              [10, 0, 30]
            ],
            "metadata": {
              "axial": 100,
              "flexure": 40
            }
          }]
        }, {
          "id": "Model C",
          "payload": [{
            "vertices": [
              [-10, 0, 30],
              [-10, 0, 10]
            ],
            "metadata": {
              "axial": 100,
              "flexure": 55
            }
          }, {
            "vertices": [
              [-10, 0, 10],
              [10, 0, 10]
            ],
            "metadata": {
              "axial": 40,
              "flexure": 20
            }
          }, {
            "vertices": [
              [10, 0, 10],
              [10, 0, -10]
            ],
            "metadata": {
              "axial": 10,
              "flexure": 40
            }
          }]
        }])
        alert("Couldn't fetch sample data, using three stick models.")
      }

      getModelData(_selectedModel) {
        var result = _.find(this.data, function(o) {
          return o.id === _selectedModel
        });
        if (result) {
          return result.payload;
        }
        return []
      }

      showDialog() {
        this.$.addModelDialog.open();
      }
    }

    window.customElements.define(ThreePolymerWireframe.is, ThreePolymerWireframe);
  </script>
</dom-module>

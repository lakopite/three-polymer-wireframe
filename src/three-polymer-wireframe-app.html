@license
<!--
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../bower_components/three-polymer/three-view/three-view.html">
<link rel="import" href="../bower_components/three-polymer/three-model/three-model.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">

<dom-module id="three-polymer-wireframe-app">
  <template>
    <style>
      :host {
        --app-primary-color: #4285f4;
        --app-secondary-color: black;

        display: block;
      }

      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }

      app-header {
        color: #fff;
        background-color: var(--app-primary-color);
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      .drawer-list {
        margin: 0 20px;
      }

      .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }

      .three-container {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        height: 100%;
      }

      #view {
        @apply(--layout-self-center);
        @apply(--shadow-elevation-2dp);
      }

      #filter-container {
        margin-top: 60px;
      }

      .horizontal {
        @apply(--layout-horizontal);
      }

      .inline-input {
        padding: 0.1em;
        @apply(--layout-flex);
      }

      .dropdown-item {
        cursor: pointer;
      }

      paper-button.filterBtn {
        background: var(--app-primary-color);
        color: #FFF;
      }

      paper-button[disabled] {
        background: #eaeaea;
        color: #a8a8a8;
      }

      paper-dialog#addModelDialog {
        padding: 1em;
      }

      paper-spinner {
        --paper-spinner-layer-1-color: #FFF;
        --paper-spinner-layer-2-color: #FFF;
        --paper-spinner-layer-3-color: #FFF;
        --paper-spinner-layer-4-color: #FFF;
      }

      #sum-field-dropdown {
        --paper-input-container-label: {
          font-size:20px;
        }
      }

      .numerical-aggregations-table {
        height: calc(100vh - 192px);
      }

      .sum-by-group-table, .numerical-aggregations-table {
        --vaadin-grid-body-row-odd-cell: {
          background-color: #f5f5f5;
        };
      }

      .num-wrapper {
        background-color: var(--paper-grey-300);
        display: grid;
        grid-template-columns: 1fr 1fr;
      }

      .str-header {
        background-color: var(--paper-grey-300);
        display: grid;
        grid-template-columns: 1fr 1fr 2fr;
      }

      #num-contour-dropdown, #str-contour-dropdown {
        padding: 0 0.5em;
          --paper-input-container-label: {
            font-size:20px;
          }
      }

      #wrap-str-info {
        @apply(--layout-vertical);
        overflow-x:hidden;
      }

      #group-data-table-section {
        /*height: 50%;*/
      }

      #chart-container {
        height: 500px;
      }

      #csv-button {
        margin: 25em 0 0 0;
        background: var(--app-primary-color);
        color: #FFF;
      }

    </style>
<<<<<<< HEAD
    <iron-ajax auto method="GET" url="[[baseUrl]]get-models" handle-as="json" on-response="handleOptionsResponse" on-error="handleOptionsError"></iron-ajax>
    <iron-ajax method="GET" id="model-request" handle-as="json" on-response="handleDataResponse" on-error="handleDataError"></iron-ajax>
    <iron-ajax id="json-upload-request" method="POST" content-type="application/json" body='[[jsonUploadPayload]]' on-response="handleUploadResponse" url="https://poxq4kkpy7.execute-api.us-west-2.amazonaws.com/api/echo-json"></iron-ajax>
    <paper-dialog modal id="addModelDialog">
      <h2>Add a Model</h2>
=======
    <iron-ajax auto url="[[baseUrl]]get-models" handle-as="json" on-response="handleOptionsResponse" on-error="handleOptionsError"></iron-ajax>
    <iron-ajax id="model-request" handle-as="json" on-response="handleDataResponse" on-error="handleDataError"></iron-ajax>
    <iron-ajax id="json-upload-request" method="POST" content-type="application/json" body='[[jsonUploadPayload]]' on-response="handleUploadResponse" url="https://poxq4kkpy7.execute-api.us-west-2.amazonaws.com/api/echo-json"></iron-ajax>
    <paper-dialog modal id="addModelDialog">
      <h2>Add a Model</h2>
      <!-- set on-change -->
>>>>>>> feat/quads
      <paper-input id="modelUpload" label="JSON file" type="file" on-change="handleJsonUpload"></paper-input>
      <div class="buttons">
        <paper-button dialog-dismiss on-tap="_clearUploadInput">Cancel</paper-button>
        <paper-button id="acceptUploadBtn" dialog-confirm autofocus disabled$="{{_acceptUploadDisabled}}" on-tap="uploadJsonModel">Accept</paper-button>
      </div>
    </paper-dialog>
    <app-drawer-layout fullbleed>
      <!-- Drawer content -->
      <app-drawer id="drawer" slot="drawer">
        <div style="height: 100%; overflow: auto;">
        <app-toolbar>
          <paper-item>Model Options</paper-item>
        </app-toolbar>
        <div class="drawer-list">
          <paper-dropdown-menu label="Model">
            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedModel}}">
              <template is="dom-repeat" items="[[dataOptions]]">
                <paper-item class="dropdown-item" name="[[item]]">[[item]]</paper-item>
              </template>
  </paper-listbox>
  </paper-dropdown-menu>
  <div hidden$="{{_hideMainDropdown(selectedView)}}">
    <paper-dropdown-menu id="main-contour-dropdown" label="Contour">
      <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
        <template is="dom-repeat" items="[[metadataFields]]">
                  <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
                </template>
      </paper-listbox>
    </paper-dropdown-menu>
  </div>
  <div id="filter-container">
    <paper-item>Model Filters</paper-item>
    <div class="horizontal">
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min x" class="inline-input" type="number" value="{{geometryFilter.xMin}}" max="[[_computeMax(boundaries.xMax,geometryFilter.xMax)]]" min="[[boundaries.xMin]]"></paper-input>
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max x" class="inline-input" type="number" value="{{geometryFilter.xMax}}" max="[[boundaries.xMax]]" min="[[_computeMin(boundaries.xMin,geometryFilter.xMin)]]"></paper-input>
    </div>
    <div class="horizontal">
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min y" class="inline-input" type="number" value="{{geometryFilter.yMin}}" max="[[_computeMax(boundaries.yMax,geometryFilter.yMax)]]" min="[[boundaries.yMin]]"></paper-input>
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max y" class="inline-input" type="number" value="{{geometryFilter.yMax}}" max="[[boundaries.yMax]]" min="[[_computeMin(boundaries.yMin,geometryFilter.yMin)]]"></paper-input>
    </div>
    <div class="horizontal">
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min z"  class="inline-input" type="number" value="{{geometryFilter.zMin}}" max="[[_computeMax(boundaries.zMax,geometryFilter.zMax)]]" min="[[boundaries.zMin]]"></paper-input>
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max z" class="inline-input" type="number" value="{{geometryFilter.zMax}}" max="[[boundaries.zMax]]" min="[[_computeMin(boundaries.zMin,geometryFilter.zMin)]]"></paper-input>
    </div>
    <!-- for force filter -->
    <!-- <div hidden$="[[!showNumericalAggregations]]">
      <div class="horizontal">
        <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min [[selectedContourBy]]" class="inline-input" type="number" value="[[minResult]]" min="#"></paper-input>
        <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max [[selectedContourBy]]" class="inline-input" type="number" value="[[maxResult]]" max="#"></paper-input>
      </div>
    </div> -->
    <!-- force filter end -->
    <div class="horizontal">
      <paper-button class="filterBtn" raised disabled$="{{_filtersDisabled}}" id="applyBtn" on-tap="applyFilters" type="number">Apply</paper-button>
      <paper-button class="filterBtn" raised disabled$="{{modelLoading}}" id="resetBtn" on-tap="resetFilters" type="number">Reset</paper-button>
    </div>
  </div>
    <div hidden$="{{_hideCsvButton(selectedView)}}">
      <div class="csv-button">
        <paper-button id="csv-button" on-tap="createCsv">Export Table to CSV</paper-button>
    </div>
  </div>
  </div>
  </div>
  </app-drawer>
  <!-- Main content -->
  <app-header-layout has-scrolling-region>
    <app-header slot="header" medium-tall>
      <app-toolbar>
        <paper-icon-button icon="my-icons:menu" drawer-toggle></paper-icon-button>
        <div main-title>Arup Model QuickView</div>
        <paper-item>Build Date: 8/28/17</paper-item>
        <div class="spacer"></div>
        <paper-spinner active$="{{isLoadingState(modelLoading,appLoading)}}"></paper-spinner>
        <paper-icon-button on-tap="showDialog" icon="my-icons:add"></paper-icon-button>
      </app-toolbar>
      <app-toolbar>
        <paper-tabs bottom-item attr-for-selected="name" selected="{{selectedView}}">
          <paper-tab name="model-view">Model</paper-tab>
          <paper-tab name="aggregations-view">Quantities</paper-tab>
        </paper-tabs>
      </app-toolbar>
    </app-header>
    <iron-pages style="height:100%;" attr-for-selected="name" selected="{{selectedView}}">
      <div name="model-view" class="three-container">
        <three-view id="view" scene-background-color="#F5F5F5">
          <three-model id="model" slot="model" metadata-fields="{{metadataFields}}" is-loading="{{modelLoading}}" contour-by="[[selectedContourBy]]" boundaries="{{boundaries}}" geometry-filter="{{geometryFilter}}" data="[[_modelData]]">
          </three-model>
        </three-view>
      </div>
      <!-- Quantities tab -->
      <!-- For numerical aggregations -->
      <div name="aggregations-view">
        <div hidden$="[[!showNumericalAggregations]]">
          <div class="num-wrapper">
          <app-toolbar class="aggregation-toolbar">
            <div main-title>Aggregations</div>
          </app-toolbar>
          <paper-dropdown-menu id="num-contour-dropdown" label="Contour">
            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
              <template is="dom-repeat" items="[[metadataFields]]">
                        <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
                      </template>
            </paper-listbox>
            </paper-dropdown-menu>
          </div>
            <!-- min/max/avg table -->
              <vaadin-grid class="numerical-aggregations-table" items="[[numericalAggregationsTableData]]">
                <vaadin-grid-column>
                  <template class="header">Name</template>
                  <template>[[item.name]]</template>
                  <template class="footer">Grand Total: [[_prettify(totalResult)]]</template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                  <template class="header">Result</template>
                  <template>[[_prettify(item.result)]]</template>
                </vaadin-grid-column>
              </vaadin-grid>
        </div>
        <!-- For string aggregations -->
        <div hidden$="[[!showStringAggregations]]">
          <div class="str-header">
            <app-toolbar class="aggregation-toolbar">
              <div main-title>Data by Group</div>
            </app-toolbar>
            <paper-dropdown-menu id="str-contour-dropdown" label="Contour">
              <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
                <template is="dom-repeat" items="[[metadataFields]]">
                          <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
                        </template>
              </paper-listbox>
              </paper-dropdown-menu>
            <paper-dropdown-menu class="aggregation-toolbar" id="sum-field-dropdown" label="Select Sum Field">
              <paper-listbox slot="dropdown-content" class="dropdown-content" attr-for-selected="name" selected="{{selectedSumField}}">
                <template is="dom-repeat" items="[[numericalMetadataKeys]]">
                  <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>
        </div>
        <!-- wrap all string aggregation info -->
          <div id="wrap-str-info">
          <!-- div holds pie chart -->
          <div id="chart-container"></div>
            <!-- data by group table -->
          <div id="group-data-table-section">
          <vaadin-grid class="sum-by-group-table" items="[[groupSumData]]">
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="group">group</vaadin-grid-sorter>
              </template>
              <template>[[item.group]]</template>
              <template class="footer">Grand Total</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="sum">[[selectedSumField]] sum</vaadin-grid-sorter>
              </template>
              <template>[[_prettify(item.sum)]]</template>
              <template class="footer">[[_prettify(grandTotalSum)]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">cost</template>
              <template>[[_prettifyDollar(item.cost)]]</template>
            </vaadin-grid-column>
            <!-- NUMERICAL AGGREGATIONS WITHIN STRING AGGREGATION TABLE-->
            <vaadin-grid-column>
              <template class="header">min [[selectedSumField]]</template>
              <template>[[_prettify(item.min)]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">max [[selectedSumField]]</template>
              <template>[[_prettify(item.max)]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">avg [[selectedSumField]]</template>
              <template>[[_prettify(item.avg)]]</template>
            </vaadin-grid-column>
          </vaadin-grid>
        </div>
      </div>
      </div>
    </iron-pages>
  </app-header-layout>
  </app-drawer-layout>
  </template>

  <script>

    class ThreePolymerWireframe extends Polymer.Element {

      static get is() {
        return 'three-polymer-wireframe-app';
      }

      static get properties() {
        return {
          baseUrl: {
            type: String,
            //CI pipeline will replace with the production api link
            value: _BACKEND_URL_,
            readOnly: true
          },
          selectedModel: {
            type: String
          },
          selectedContourBy: {
            type: String,
            value: "flexure"
          },
          boundaries: {
            type: Object
          },
          geometryFilter: {
            type: Object
          },
          dataOptions: {
            type: Array,
            value: []
          },
          _filtersDisabled: {
            type: Boolean,
            value: false
          },
          _modelData: {
            type: Object,
            value: {}
          },
          modelLoading: {
            type: Boolean
          },
          appLoading: {
            type: Boolean,
            value: true
          },
          _acceptUploadDisabled: {
<<<<<<< HEAD
            type: Boolean,
            value: true
            //notify: true
          },
          jsonUploadPayload: {
            type: Object,
            value: {}
          },
=======
           type: Boolean,
           value: true
           //notify: true
         },
         jsonUploadPayload: {
           type: Object,
           value: {}
         },
>>>>>>> feat/quads
          metadataFields: {
            type: Array,
            value: []
          },
          avgResult: {
            type: Number,
            value: 0
          },
          minResult: {
            type: Number,
            value: 0
          },
          maxResult: {
            type: Number,
            value: 0
          },
          getAvgLabel: {
            type: String,
            value: "average"
          },
          getMinLabel: {
            type: String,
            value: "min value"
          },
          getMaxLabel: {
            type: String,
            value: "max value"
          },
          totalResult : {
            type: Number,
            value: 0
          },
          allObjectsByGroup: {
            type: Array,
            value: []
          },
          numericalAggregationsTableData: {
            type: Array,
            value: []
          },
          grandTotalSum : {
            type: Number,
            value: 0
          },
          getTotalResultLabel: {
            type: String,
            value: "total"
          },
          groupSumData: {
            type: Array,
            value: []
          },
          pieChart: {
            type: Object
          },
          pieData: {
            type: Array
          },
          costCoefficient: {
            type: Number
          },
          selectedView: {
            type: String,
            value: 'model-view'
          },
          selectedSumField: {
            type: String
          },
          showNumericalAggregations: {
            type: Boolean,
            value: false
          },
          showStringAggregations: {
            type: Boolean,
            value: false
          }
        };
      }

      static get observers() {
        return [
          '_boundariesChanged(boundaries.*)',
          '_loadingChanged(modelLoading)',
          '_contourPropsChanged(metadataFields)',
          '_getModelData(selectedModel)',
          '_aggregations(_modelData,selectedContourBy)',
          '_getAggregationLabels(_modelData, selectedContourBy)',
          '_getSumByForSelectedSumField(selectedSumField)',
          '_drawChart(pieData)',
          '_delayChartResize(selectedView, selectedContourBy)'
        ]
      }

      constructor() {
        super();
      }

      uploadJsonModel() {
        this.$['json-upload-request'].generateRequest();
        Polymer.dom(this.root).querySelector('#modelUpload').value = null
        alert("Success! File has been uploaded.")
      }

      handleJsonUpload(evt) {
        var inputFile = this.$.modelUpload.inputElement.inputElement.files[0]
        var fileName = inputFile.name
        var fileNameNoExtension = fileName.slice(0, fileName.lastIndexOf('.json'))
        console.log('Selected file name: ' + fileName)
      	var reader = new FileReader()
        var that = this;
        // Capture the file information.
        reader.onload = (function (theFile) {
    			return function (e) {
    				// console.log('e readAsText = ', e);
    				// console.log('e readAsText target = ', e.target);
              //validation
              try {
                that.jsonUploadPayload = JSON.parse(e.target.result)
                // check that this json has not already been uplaoded
                if (_.includes(that.dataOptions, fileNameNoExtension))
                throw "it has already been uploaded."
                // check that file name matches name in doc
                if (that.jsonUploadPayload.modelInformation.name + ".json"!== fileName)
                throw "it must be a .json -or- name of file does not match name within document."
                // check that modelInfo and payload keys exist
                if (_.has(that.jsonUploadPayload, 'modelInformation') === false ||
                    _.has(that.jsonUploadPayload, 'payload') === false)
                throw "modelInformation and payload properties are required."
                // check that modelInfo has units and name keys
                if (_.has(that.jsonUploadPayload, 'modelInformation.units') === false ||
                    _.has(that.jsonUploadPayload, 'modelInformation.name') === false)
                throw "modelInformation must contain units and name."
                // check that units are either metric or imperial only
                if (!(that.jsonUploadPayload.modelInformation.units === "metric" ||
                that.jsonUploadPayload.modelInformation.units === "imperial"))
                throw "units values must be either imperial or metric."
                var payloadElems = that.jsonUploadPayload.payload
                for (var i=0; i < payloadElems.length; i++) {
                  // go through payload elements and ensure each has vertices and metadata keys
                  if (_.has(payloadElems[i], 'vertices') === false ||
                      _.has(payloadElems[i], 'metadata') === false) {
                    throw "payload must include vertices and metadata for each element."
                  }
                }
                //if it does not get stuck on any errors above, it'll make it to the below
                console.log(that.jsonUploadPayload);
                that._acceptUploadDisabled = false;
              } catch (err) {
                  //same problem as _clearUploadInput
                  Polymer.dom(that.root).querySelector('#modelUpload').value = ''
                  throw "--File could not be uploaded because " + err
              } finally {
                console.log("tests completed")
              }
                  }
              })(inputFile);
            reader.readAsText(inputFile);
      }

      _clearUploadInput() {
        // clear input--but below only works after FIRST occasionlog
        Polymer.dom(this.root).querySelector('#modelUpload').value = ''
        this._acceptUploadDisabled = true;
      }

      _clearUploadInput() {
        // clear input--but below only works after FIRST occasionlog
        Polymer.dom(this.root).querySelector('#modelUpload').value = ''
        this._acceptUploadDisabled = true;
      }

      _isWithinBounds(val, min, max) {
        return val >= min && val <= max
      }

      _prettify(n) {
        return (n) ? parseFloat(n).toLocaleString() : ""
      }

      _prettifyDollar(n) {
        return (n) ? n.toLocaleString('en-US', { style: 'currency', currency: 'USD' }) : ""
      }

      _numericalAggregations() {
        this.showStringAggregations = false;
        var that = this;
        var resultFilterInput = _.filter(that._modelData.linearElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
              that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
              that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        this.minResult = _.round(_.minBy(resultFilterInput, function(o) {
          return o.metadata[that.selectedContourBy]
        }).metadata[this.selectedContourBy], 6)
        this.maxResult = _.round(_.maxBy(resultFilterInput, function(o) {
          return o.metadata[that.selectedContourBy]
        }).metadata[this.selectedContourBy], 6)
        this.avgResult = _.round(_.meanBy(resultFilterInput, function(o) {
          return o.metadata[that.selectedContourBy]
        }), 6);
        this._getAggregationLabels()
        this.numericalAggregationsTableData = []
        var name = [this.getMinLabel, this.getMaxLabel, this.getAvgLabel];
        var result = [this.minResult, this.maxResult, this.avgResult];
        for (var i=0; i < name.length; i++) {
          var setup = {
            'name': name[i],
            'result': result[i]
          }
          this.push('numericalAggregationsTableData', setup)
        }
        this.totalResult = _.round(_.sumBy(resultFilterInput, function(o) {
          return o.metadata[that.selectedContourBy]
        }), 6);
        this.showNumericalAggregations = true;
      }

      _getSumByForSelectedSumField(_selectedSumField) {
        if (typeof this.selectedSumField !== 'undefined') {
          this._stringAggregations();
        }
        return
      }


      _stringAggregations() {
        this.showNumericalAggregations = false;
        var that = this
        // ================ repeated function start ==========================================
        var resultFilterInput = _.filter(that._modelData.linearElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
              that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
              that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        // ================ repeated function end ==========================================
        //console.log(resultFilterInput);
        var resultGroupByName = _.groupBy(resultFilterInput, function(o) {
          return o.metadata[that.selectedContourBy]
        })
        // console.log("RESULTGROUPBYNAME");
        // console.log(resultGroupByName);
        this.groupKeys = _.without(_.keys(resultGroupByName), 'undefined')
        if(typeof this.selectedSumField === 'undefined') {
          this.allObjectsByGroup = []
          // console.log("ALL OBJECTS BY GROUP ONCE");
          // console.log(this.allObjectsByGroup);
          for (var i = 0; i < this.groupKeys.length; i++) {
            var groupObjects = resultGroupByName[this.groupKeys[i]]
            this.push('allObjectsByGroup', groupObjects)
        }
        this.numericalMetadataKeys = []
        var totalGroupObjects = _.flatten(this.allObjectsByGroup)
        for (var i = 0; i < totalGroupObjects.length; i++) {
          var metadataObject = totalGroupObjects[i].metadata
          var metadataValues = _.values(metadataObject)
          var metadataKeys = _.keys(metadataObject)
           for (var j = 0; j < metadataKeys.length; j++) {
             //to exclude these from the dropdown items
             var ignoreSumGroups = ['meta_st7id', 'meta_groupid', 'meta_propnum', 'beamnum']
             // to find unique keys with numeric values for dropdown options
             if(_.isNumber(metadataValues[j]) && this.numericalMetadataKeys.indexOf(metadataKeys[j]) === -1 && ignoreSumGroups.indexOf(metadataKeys[j]) === -1) {
               this.push('numericalMetadataKeys', metadataKeys[j])
             }
           }
         }
         this.selectedSumField = this.numericalMetadataKeys[0]
       } else {
        this.groupSumData = []
        this.allObjectsByGroupDupe = []
        // console.log("ALL OBJECTS BY GROUP SECOND");
        // console.log(this.allObjectsByGroupDupe);
        for (var i = 0; i < this.groupKeys.length; i++) {
          //reusing var groupObjects below (was local variable in previous loop for numericalMetadataKeys)
          var groupObjects = resultGroupByName[this.groupKeys[i]]
            var sumByGroup = _.round(_.sumBy(groupObjects, function(o) {
              return o.metadata[that.selectedSumField]
            }), 6)
            var minByGroup = _.round(_.minBy(groupObjects, function(o) {
              return o.metadata[that.selectedSumField]
            }).metadata[that.selectedSumField], 6)
            var maxByGroup = _.round(_.maxBy(groupObjects, function(o) {
              return o.metadata[that.selectedSumField]
            }).metadata[that.selectedSumField], 6)
            var avgByGroup = _.round(_.meanBy(groupObjects, function(o) {
              return o.metadata[that.selectedSumField]
            }), 6);
            //.2 is a temp placeholder, we will later place a cost costCoefficient in there
            var cost = _.multiply(.2, sumByGroup);

            var groupSumDataSetup = {
              'group': this.groupKeys[i],
              'sum': sumByGroup,
              'cost' : cost,
              'min' : minByGroup,
              'max' : maxByGroup,
              'avg' : avgByGroup
            }
            this.push('groupSumData', groupSumDataSetup)
            this.push('allObjectsByGroupDupe', groupObjects)
          }
          // for chart total sum by group
          this.grandTotalSum = _.round(_.sumBy(this.groupSumData, function(o) {
            return o.sum
          }), 6)
          // for pie chart
          var _pieData = []
          for (var i=0; i < this.groupSumData.length; i++) {
            var item = this.groupSumData[i]
            _pieData.push([item.group, parseFloat(item.sum)])
            }
          this.pieData = _pieData;
        }
        this.showStringAggregations = true;
      }


      _aggregations(_modelData, selectedContourBy) {
        if (this._isNumberField(_modelData, selectedContourBy)) {
          this._numericalAggregations();
          return
        }
        if (this._isStringField(_modelData, selectedContourBy)) {
          this._stringAggregations();
          return
        }
        this.showStringAggregations = false;
        this.showNumericalAggregations = false;
      }

      _getAggregationLabels() {
        if (typeof this.selectedContourBy === 'undefined' || typeof this.selectedModel === 'undefined') {
          this.getAvgLabel = "Avg unavailable"
          this.getMinLabel = "Min unavailable"
          this.getMaxLabel = "Max unavailable"
          this.getTotalResultLabel = "Total unavailable"
        } else {
          this.getAvgLabel = "Avg " + _.capitalize(this.selectedContourBy)
          this.getMinLabel = "Min " + _.capitalize(this.selectedContourBy)
          this.getMaxLabel = "Max " + _.capitalize(this.selectedContourBy)
          this.getTotalResultLabel = "Total " + _.capitalize(this.selectedContourBy)
        }
      }

      _initChart() {
        var chartdiv = Polymer.dom(this.root).querySelector("#chart-container")
        this.pieChart = Highcharts.chart(chartdiv, {
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false,
            type: 'pie'
        },
        title: {
            text: 'Sum by Group'
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.6f}%</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: false
                },
                showInLegend: true
            }
        },
        series: [{
            name: 'Sum',
            colorByPoint: true,
            data: []
          }]
        });
      }

      _drawChart() {
        var chartdiv = Polymer.dom(this.root).querySelector("#chart-container")
        //console.log(this.pieData);
        this.pieChart = Highcharts.chart(chartdiv, {
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false,
            type: 'pie'
        },
        title: {
            text: 'Sum by Group',
            align: 'right'
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.6f}%</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: false
                },
                showInLegend: true
            }
        },
        legend: {
          layout: 'vertical',
          align: 'right',
          verticalAlign: 'top',
          y: 40,
        },
        series: [{
            name: 'Sum',
            colorByPoint: true,
            colors: ['#7cb5ec', '#434348', '#90ed7d', '#f7a35c', '#8085e9',
                    '#f15c80', '#e4d354', '#2b908f', '#f45b5b', '#91e8e1', '#2f7ed8', '#0d233a', '#8bbc21', '#910000', '#1aadce',
                    '#492970', '#f28f43', '#77a1e5', '#c42525', '#a6c96a', '#4572A7', '#AA4643', '#89A54E', '#80699B', '#3D96AE',
                    '#DB843D', '#92A8CD', '#A47D7C', '#B5CA92'],
            data: this.pieData
          }]
        });
        //console.log(this.pieChart.series[0].userOptions.data);
      }

      _delayChartResize() {
        var that = this;
        setTimeout(function() {
          that.pieChart.reflow()
        }, 0)
      }

      ready() {
        super.ready();
        this._initChart();
      }

      createCsv() {
        var rowData = ''
        for (var i=0; i < this.groupSumData.length; i++) {
          this.headers = [_.keys(this.groupSumData[i])] + '\r\n'
          var el = [_.values(this.groupSumData[i])] + '\r\n'
        	rowData += el
        }
        var csvData = this.headers + rowData
        var uri = 'data:text/csv;charset=utf-8,' + escape(csvData);
        var link = document.createElement("a");
        link.href = uri;
        link.style = "visibility:hidden";
        link.download = this.selectedModel + ' ' + new Date() + ".csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      _hideMainDropdown(currentPage) {
        return this.selectedView == 'aggregations-view';
      }

      _hideCsvButton(currentPage, chart) {
        //this needs to also hide when not within string aggregations with table/chart
        return this.selectedView == 'model-view';
      }

      //Ensure that the geometry input is within boundaries and is compatible with its input sibling
      _computeMin(_b, _g) {
        _g = parseFloat(_g)
        if (_.isNumber(_g)) {
          return (_g > _b) ? _g : _b
        }
        return _b
      }

      _computeMax(_b, _g) {
        _g = parseFloat(_g)
        if (_.isNumber(_g)) {
          return (_g < _b) ? _g : _b
        }
        return _b
      }

      _boundariesChanged(boundaries) {
        this.resetFilters();
        //console.log(this.boundaries)
      }

      _loadingChanged(modelLoading) {
        //console.log(modelLoading)
        this.checkValidInput();
      }

      _contourPropsChanged(metadataFields) {
        if (this.metadataFields.indexOf(this.selectedContourBy) === -1) {
          this.selectedContourBy = undefined;
          if (this.metadataFields.length > 0) {
            var that = this;
            setTimeout(function() {
              that.selectedContourBy = that.metadataFields[0];
            }, 0);
          }
        }
      }

      _isNumberField(_modelData, selectedContourBy) {
        return !_.isEmpty(_modelData.linearElements) && this.selectedContourBy && _.isNumber(_modelData.linearElements[0].metadata[this.selectedContourBy])
      }

      _isStringField(_modelData, selectedContourBy) {
        return !_.isEmpty(_modelData.linearElements) && typeof this.selectedContourBy !== 'undefined' && !_.isNumber(_modelData.linearElements[0].metadata[this.selectedContourBy])
      }

      isLoadingState(modelLoading, appLoading) {
        return modelLoading || appLoading
      }

      checkValidInput() {
        //console.log(this.geometryFilter)
        if (!_.isEmpty(this.geometryFilter) && !_.isEmpty(this.boundaries) && !this.modelLoading && _.every(_.values(this.geometryFilter), function(o) {
            return o !== ""
          })) {
          this._filtersDisabled =
            parseFloat(this.geometryFilter.xMin) < this.boundaries.xMin || parseFloat(this.geometryFilter.xMin) > this.geometryFilter.xMax ||
            parseFloat(this.geometryFilter.yMin) < this.boundaries.yMin || parseFloat(this.geometryFilter.yMin) > this.geometryFilter.yMax ||
            parseFloat(this.geometryFilter.zMin) < this.boundaries.zMin || parseFloat(this.geometryFilter.zMin) > this.geometryFilter.zMax ||
            parseFloat(this.geometryFilter.xMax) > this.boundaries.xMax ||
            parseFloat(this.geometryFilter.yMax) > this.boundaries.yMax ||
            parseFloat(this.geometryFilter.zMax) > this.boundaries.zMax
        } else {
          this._filtersDisabled = true;
        }
      }

      resetFilters() {
        this.geometryFilter = _.cloneDeep(this.boundaries);
        this.checkValidInput();
        this._aggregations(this._modelData, this.selectedContourBy);
        //reset filter selection to the model boundaries
        //console.log(this.geometryFilter)
        //console.log(this.boundaries)
      }

      applyFilters() {
        //this clone below works, but it turns values into strings. must parseFloat *values*. -rsc
        // this.geometryFilter = _.cloneDeep(this.geometryFilter)
        this.geometryFilter = {
          'xMin': parseFloat(this.geometryFilter.xMin),
          'xMax': parseFloat(this.geometryFilter.xMax),
          'yMin': parseFloat(this.geometryFilter.yMin),
          'yMax': parseFloat(this.geometryFilter.yMax),
          'zMin': parseFloat(this.geometryFilter.zMin),
          'zMax': parseFloat(this.geometryFilter.zMax)
        }
        this._aggregations(this._modelData, this.selectedContourBy);
      }

      _initData(dataOptions_) {
        this.set('dataOptions', dataOptions_);
        //console.log(this.dataOptions)
        if (this.dataOptions.length > 0) {
          this.set('selectedModel', this.dataOptions[0])
        }
      }

      handleOptionsResponse(event, response) {
        var resp = response.response;
        if (resp) {
          this.appLoading = false
          this._initData(resp);
        } else {
          this.handleOptionsError();
        }
      }

      handleOptionsError(event, response) {
        this.appLoading = false;
        this._initData([]);
        alert("Couldn't fetch data.  Please check your internet connection");
      }

      handleDataResponse(event, response) {
        var resp = response.response;
        // console.log("data received")
        if (resp && resp.modelInformation.name === this.selectedModel && "payload" in resp) {
          this.appLoading = false;
          this.set('_modelData', {
            'linearElements': resp.payload,
            'planarElements': []
          });
          //set selectedSumField to undefined in order to trigger stringAggregtions initialization
          this.selectedSumField = undefined
          //console.log(this._modelData)
        } else {
          this.handleDataError()
        }
      }

      handleDataError(event, response) {
        this.appLoading = false;
        alert("couldn't retrieve " + this.selectedModel)
      }

      _getModelData(_selectedModel) {
        this.viewData = {
             "linearElements": [],
             "planarElements": []
        }
        this.$['model-request'].url = this.baseUrl + "get-model-data/" + this.selectedModel
        this.$['model-request'].generateRequest();
        this.appLoading = true;
      }

      showDialog() {
        this.$.addModelDialog.open();
      }

      handleUploadResponse(event, response) {
        console.log(response.response)
      }
    }

    window.customElements.define(ThreePolymerWireframe.is, ThreePolymerWireframe);
  </script>
</dom-module>

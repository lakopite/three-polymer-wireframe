@license
<!--
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../bower_components/three-polymer/three-view/three-view.html">
<link rel="import" href="../bower_components/three-polymer/three-model/three-model.html">
<link rel="import" href="my-icons.html">

<dom-module id="three-polymer-wireframe-app">
  <template>
    <style>
      :host {
        --app-primary-color: #4285f4;
        --app-secondary-color: black;

        display: block;
      }

      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }

      app-header {
        color: #fff;
        background-color: var(--app-primary-color);
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      .drawer-list {
        margin: 0 20px;
      }

      .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }

      .three-container {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        height: 100%;
      }

      #view {
        @apply(--layout-self-center);
        @apply(--shadow-elevation-2dp);
      }

      #filter-container {
        margin-top: 60px;
      }

      .horizontal {
        @apply(--layout-horizontal);
      }

      .inline-input {
        padding: 0.1em;
        @apply(--layout-flex);
      }

      .dropdown-item {
        cursor: pointer;
      }

      paper-button.filterBtn {
        background: var(--app-primary-color);
        color: #FFF;
      }

      paper-button[disabled] {
        background: #eaeaea;
        color: #a8a8a8;
      }

      paper-dialog#addModelDialog {
        padding: 1em;
      }

      paper-spinner {
        --paper-spinner-layer-1-color: #FFF;
        --paper-spinner-layer-2-color: #FFF;
        --paper-spinner-layer-3-color: #FFF;
        --paper-spinner-layer-4-color: #FFF;
      }

      #sum-field-dropdown {
        --paper-input-container-label: {
          font-size:20px;
        }
      }

      .sum-by-group-table, .numerical-aggregations-table {
        height: calc(100vh - 192px);
        --vaadin-grid-body-row-odd-cell: {
          background-color: #f5f5f5;
        };
      }

      .num-wrapper {
        background-color: var(--paper-grey-300);
        display: grid;
        grid-template-columns: 1fr 1fr;
      }

      .str-header {
        background-color: var(--paper-grey-300);
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
      }

      #num-contour-dropdown, #str-contour-dropdown {
        padding: 0 0.5em;
          --paper-input-container-label: {
            font-size:20px;
          }
      }

      #wrap-str-info {
        @apply(--layout-horizontal);
        height: calc(100vh - 192px);
      }

      #sum-table-section {
        width: 50%;
      }

      #chart-container {
        width: 50%;
      }

    </style>
    <iron-ajax auto url="[[baseUrl]]get-models" handle-as="json" on-response="handleOptionsResponse" on-error="handleOptionsError"></iron-ajax>
    <iron-ajax id="model-request" handle-as="json" on-response="handleDataResponse" on-error="handleDataError"></iron-ajax>
    <paper-dialog modal id="addModelDialog">
      <h2>Add a Model</h2>
      <paper-input label="JSON file" type="file"></paper-input>
      <paper-input label="meta val" type="text"></paper-input>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Accept</paper-button>
      </div>
    </paper-dialog>
    <app-drawer-layout fullbleed>
      <!-- Drawer content -->
      <app-drawer id="drawer" slot="drawer">
        <div style="height: 100%; overflow: auto;">
        <app-toolbar>
          <paper-item>Model Options</paper-item>
        </app-toolbar>
        <div class="drawer-list">
          <paper-dropdown-menu label="Model">
            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedModel}}">
              <template is="dom-repeat" items="[[dataOptions]]">
                <paper-item class="dropdown-item" name="[[item]]">[[item]]</paper-item>
              </template>
  </paper-listbox>
  </paper-dropdown-menu>
  <div hidden$="{{_hideMainDropdown(selectedView)}}">
    <paper-dropdown-menu id="main-contour-dropdown" label="Contour">
      <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
        <template is="dom-repeat" items="[[metadataFields]]">
                  <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
                </template>
      </paper-listbox>
    </paper-dropdown-menu>
  </div>
  <div id="filter-container">
    <paper-item>Model Filters</paper-item>
    <div class="horizontal">
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min x" class="inline-input" type="number" value="{{geometryFilter.xMin}}" max="[[_computeMax(boundaries.xMax,geometryFilter.xMax)]]" min="[[boundaries.xMin]]"></paper-input>
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max x" class="inline-input" type="number" value="{{geometryFilter.xMax}}" max="[[boundaries.xMax]]" min="[[_computeMin(boundaries.xMin,geometryFilter.xMin)]]"></paper-input>
    </div>
    <div class="horizontal">
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min y" class="inline-input" type="number" value="{{geometryFilter.yMin}}" max="[[_computeMax(boundaries.yMax,geometryFilter.yMax)]]" min="[[boundaries.yMin]]"></paper-input>
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max y" class="inline-input" type="number" value="{{geometryFilter.yMax}}" max="[[boundaries.yMax]]" min="[[_computeMin(boundaries.yMin,geometryFilter.yMin)]]"></paper-input>
    </div>
    <div class="horizontal">
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min z"  class="inline-input" type="number" value="{{geometryFilter.zMin}}" max="[[_computeMax(boundaries.zMax,geometryFilter.zMax)]]" min="[[boundaries.zMin]]"></paper-input>
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max z" class="inline-input" type="number" value="{{geometryFilter.zMax}}" max="[[boundaries.zMax]]" min="[[_computeMin(boundaries.zMin,geometryFilter.zMin)]]"></paper-input>
    </div>
    <!-- for force filter -->
    <!-- <div hidden$="[[!showNumericalAggregations]]">
      <div class="horizontal">
        <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min [[selectedContourBy]]" class="inline-input" type="number" value="[[minResult]]" min="#"></paper-input>
        <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max [[selectedContourBy]]" class="inline-input" type="number" value="[[maxResult]]" max="#"></paper-input>
      </div>
    </div> -->
    <!-- force filter end -->
    <div class="horizontal">
      <paper-button class="filterBtn" raised disabled$="{{_filtersDisabled}}" id="applyBtn" on-tap="applyFilters" type="number">Apply</paper-button>
      <paper-button class="filterBtn" raised disabled$="{{modelLoading}}" id="resetBtn" on-tap="resetFilters" type="number">Reset</paper-button>
    </div>
  </div>
  </div>
  </div>
  </app-drawer>
  <!-- Main content -->
  <app-header-layout has-scrolling-region>
    <app-header slot="header" medium-tall>
      <app-toolbar>
        <paper-icon-button icon="my-icons:menu" drawer-toggle></paper-icon-button>
        <div main-title>Arup Model QuickView</div>
        <paper-item>Build Date: 8/7/17</paper-item>
        <div class="spacer"></div>
        <paper-spinner active$="{{isLoadingState(modelLoading,appLoading)}}"></paper-spinner>
        <paper-icon-button on-tap="showDialog" icon="my-icons:add"></paper-icon-button>
      </app-toolbar>
      <app-toolbar>
        <paper-tabs bottom-item attr-for-selected="name" selected="{{selectedView}}">
          <paper-tab name="model-view">Model</paper-tab>
          <paper-tab name="aggregations-view">Quantities</paper-tab>
        </paper-tabs>
      </app-toolbar>
    </app-header>
    <iron-pages style="height:100%;" attr-for-selected="name" selected="{{selectedView}}">
      <div name="model-view" class="three-container">
        <three-view id="view" scene-background-color="#F5F5F5">
          <three-model id="model" slot="model" metadata-fields="{{metadataFields}}" is-loading="{{modelLoading}}" contour-by="[[selectedContourBy]]" boundaries="{{boundaries}}" geometry-filter="{{geometryFilter}}" data="[[_modelData]]">
          </three-model>
        </three-view>
      </div>
      <!-- Quantities tab -->
      <!-- For numerical aggregations -->
      <div name="aggregations-view">
        <div hidden$="[[!showNumericalAggregations]]">
          <div class="num-wrapper">
          <app-toolbar class="aggregation-toolbar">
            <div main-title>Aggregations</div>
          </app-toolbar>
          <paper-dropdown-menu id="num-contour-dropdown" label="Contour">
            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
              <template is="dom-repeat" items="[[metadataFields]]">
                        <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
                      </template>
            </paper-listbox>
            </paper-dropdown-menu>
          </div>
            <!-- min/max/avg table -->
              <vaadin-grid class="numerical-aggregations-table" items="[[numericalAggregationsTableData]]">
                <vaadin-grid-column>
                  <template class="header">Name</template>
                  <template>[[item.name]]</template>
                  <template class="footer">Total</template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                  <template class="header">Result</template>
                  <template>[[item.result]]</template>
                  <template class="footer">[[totalResult]]</template>
                </vaadin-grid-column>
              </vaadin-grid>
        </div>
        <!-- For string aggregations -->
        <div hidden$="[[!showStringAggregations]]">
          <div class="str-header">
            <app-toolbar class="aggregation-toolbar">
              <div main-title>Sum by group</div>
            </app-toolbar>
            <paper-dropdown-menu id="str-contour-dropdown" label="Contour">
              <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
                <template is="dom-repeat" items="[[metadataFields]]">
                          <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
                        </template>
              </paper-listbox>
              </paper-dropdown-menu>
            <paper-dropdown-menu class="aggregation-toolbar" id="sum-field-dropdown" label="Select Sum Field">
              <paper-listbox slot="dropdown-content" class="dropdown-content" attr-for-selected="name" selected="{{selectedSumField}}">
                <template is="dom-repeat" items="[[uniqueNumericKeys]]">
                  <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>
        </div>
        <!-- wrap all string aggregation info -->
          <div id="wrap-str-info">
            <!-- sum by group table -->
          <div id="sum-table-section">
          <vaadin-grid class="sum-by-group-table" items="[[groupSumData]]">
            <vaadin-grid-column>
              <template class="header">[[selectedContourBy]]</template>
              <template>[[item.group]]</template>
              <template class="footer">Total</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">[[selectedSumField]]</template>
              <template>[[item.sum]]</template>
              <template class="footer">[[grandTotalSum]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">$</template>
              <template>test</template>
            </vaadin-grid-column>
          </vaadin-grid>
        </div>
        </div>
    </iron-pages>
  </app-header-layout>
  </app-drawer-layout>
  </template>

  <script>
    class ThreePolymerWireframe extends Polymer.Element {

      static get is() {
        return 'three-polymer-wireframe-app';
      }

      static get properties() {
        return {
          baseUrl: {
            type: String,
            //CI pipeline will replace with the production api link
            value: _BACKEND_URL_,
            readOnly: true
          },
          selectedModel: {
            type: String
          },
          selectedContourBy: {
            type: String,
            value: "flexure"
          },
          boundaries: {
            type: Object
          },
          geometryFilter: {
            type: Object
          },
          dataOptions: {
            type: Array,
            value: []
          },
          _filtersDisabled: {
            type: Boolean,
            value: false
          },
          _modelData: {
            type: Array,
            value: []
          },
          modelLoading: {
            type: Boolean
          },
          appLoading: {
            type: Boolean,
            value: true
          },
          metadataFields: {
            type: Array,
            value: []
          },
          uniqueNumericKeys: {
            type: Array
          },
          avgResult: {
            type: Number,
            value: 0
          },
          minResult: {
            type: Number,
            value: 0
          },
          maxResult: {
            type: Number,
            value: 0
          },
          getAvgLabel: {
            type: String,
            value: "average"
          },
          getMinLabel: {
            type: String,
            value: "min value"
          },
          getMaxLabel: {
            type: String,
            value: "max value"
          },
          totalResult : {
            type: Number,
            value: 0
          },
          numericalAggregationsTableData: {
            type: Array,
            value: []
          },
          grandTotalSum : {
            type: Number,
            value: 0
          },
          getTotalResultLabel: {
            type: String,
            value: "total"
          },
          groupSumData: {
            type: Array,
            value: []
          },
          selectedView: {
            type: String,
            value: 'model-view'
          },
          selectedSumField: {
            type: String
          },
          showNumericalAggregations: {
            type: Boolean,
            value: false
          },
          showStringAggregations: {
            type: Boolean,
            value: false
          }
        };
      }

      static get observers() {
        return [
          '_boundariesChanged(boundaries.*)',
          '_loadingChanged(modelLoading)',
          '_contourPropsChanged(metadataFields)',
          '_getModelData(selectedModel)',
          '_aggregations(_modelData,selectedContourBy)',
          '_getAggregationLabels(_modelData, selectedContourBy)',
          '_getSumByForSelectedSumField(selectedSumField)'
        ]
      }

      constructor() {
        super();
      }

      _isWithinBounds(val, min, max) {
        return val >= min && val <= max
      }

      _numericalAggregations() {
        this.showStringAggregations = false;
        var that = this;
        var resultFilterInput = _.filter(that._modelData, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
              that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
              that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        console.log(resultFilterInput)
        this.minResult = _.round(_.minBy(resultFilterInput, function(o) {
          return o.metadata[that.selectedContourBy]
        }).metadata[this.selectedContourBy], 6).toLocaleString()
        this.maxResult = _.round(_.maxBy(resultFilterInput, function(o) {
          return o.metadata[that.selectedContourBy]
        }).metadata[this.selectedContourBy], 6).toLocaleString()
        this.avgResult = _.round(_.meanBy(resultFilterInput, function(o) {
          return o.metadata[that.selectedContourBy]
        }), 6).toLocaleString();
        this._getAggregationLabels()
        this.numericalAggregationsTableData = []
        var name = [this.getMinLabel, this.getMaxLabel, this.getAvgLabel];
        var result = [this.minResult, this.maxResult, this.avgResult];
        for (var i=0; i < name.length; i++) {
          var setup = {
            'name': name[i],
            'result': result[i]
          }
          this.push('numericalAggregationsTableData', setup)
        }
        this.totalResult = _.round(_.sumBy(resultFilterInput, function(o) {
          return o.metadata[that.selectedContourBy]
        }), 6).toLocaleString();
        this.showNumericalAggregations = true;
      }

      _getSumByForSelectedSumField(_selectedSumField) {
        this.selectedSumField
        {
          this._stringAggregations();
          return
        }
      }

      _stringAggregations() {
        this.showNumericalAggregations = false;
        var that = this
        // ================ repeated function start ==========================================
        var resultFilterInput = _.filter(that._modelData, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
              that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
              that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        // ================ repeated function end ==========================================
        var resultGroupByName = _.groupBy(resultFilterInput, function(o) {
          return o.metadata[that.selectedContourBy]
        })
        this.groupKeys = _.without(_.keys(resultGroupByName), 'undefined')
        this.groupSumData = []
        this.totalGroupObjects = []
        for (var i = 0; i < this.groupKeys.length; i++) {
          var groupObjects = resultGroupByName[this.groupKeys[i]]
          for (var j = 0; j < groupObjects.length; j++) {
            var sumByGroup = parseFloat(_.round(_.sumBy(groupObjects, function(o) {
              return o.metadata[that.selectedSumField]
            }), 6).toLocaleString())
          }
          var groupSumDataSetup = {
            'group': this.groupKeys[i],
            'sum': sumByGroup,
            'sum field': this.selectedSumField
          }
          this.push('groupSumData', groupSumDataSetup)
          this.push('totalGroupObjects', groupObjects)
        }
        // to find keys with numeric values for dropdown options
        this.uniqueNumericKeys = _.uniq(this.numericalMetadataKeys)
        this.numericalMetadataKeys = []
        var flatTotalGroupObjects = _.flatten(this.totalGroupObjects)
        for (var i = 0; i < flatTotalGroupObjects.length; i++) {
          var metadataObject = flatTotalGroupObjects[i].metadata
          var metadataValues = _.values(metadataObject)
          var metadataKeys = _.keys(metadataObject)
	         for (var j = 0; j < metadataKeys.length; j++) {
             //to exclude these from the dropdown items
             var ignoreSumGroups = ['meta_st7id', 'meta_groupid', 'meta_propnum', 'beamnum']
             if(_.isNumber(metadataValues[j]) && ignoreSumGroups.indexOf(metadataKeys[j]) === -1) {
               this.push('numericalMetadataKeys', metadataKeys[j])
             }
           }
         }
         this.showStringAggregations = true;
      }

      _aggregations(_modelData, selectedContourBy) {
        if (this._isNumberField(_modelData, selectedContourBy)) {
          this._numericalAggregations();
          return
        }
        if (this._isStringField(_modelData, selectedContourBy)) {
          //set a default selectedSumField
          this._stringAggregations();
          this.selectedSumField = this.numericalMetadataKeys[0]
          return
        }
        this.showStringAggregations = false;
        this.showNumericalAggregations = false;
      }

      _getAggregationLabels() {
        if (typeof this.selectedContourBy === 'undefined' || typeof this.selectedModel === 'undefined') {
          this.getAvgLabel = "Avg unavailable"
          this.getMinLabel = "Min unavailable"
          this.getMaxLabel = "Max unavailable"
          this.getTotalResultLabel = "Total unavailable"
        } else {
          this.getAvgLabel = "Avg " + _.capitalize(this.selectedContourBy)
          this.getMinLabel = "Min " + _.capitalize(this.selectedContourBy)
          this.getMaxLabel = "Max " + _.capitalize(this.selectedContourBy)
          this.getTotalResultLabel = "Total " + _.capitalize(this.selectedContourBy)
        }
      }

      _hideMainDropdown(currentPage) {
        return this.selectedView == 'aggregations-view'
      }
      //Ensure that the geometry input is within boundaries and is compatible with its input sibling
      _computeMin(_b, _g) {
        _g = parseFloat(_g)
        if (_.isNumber(_g)) {
          return (_g > _b) ? _g : _b
        }
        return _b
      }

      _computeMax(_b, _g) {
        _g = parseFloat(_g)
        if (_.isNumber(_g)) {
          return (_g < _b) ? _g : _b
        }
        return _b
      }

      _boundariesChanged(boundaries) {
        this.resetFilters();
        //console.log(this.boundaries)
      }

      _loadingChanged(modelLoading) {
        //console.log(modelLoading)
        this.checkValidInput();
      }

      _contourPropsChanged(metadataFields) {
        if (this.metadataFields.indexOf(this.selectedContourBy) === -1) {
          this.selectedContourBy = undefined;
          if (this.metadataFields.length > 0) {
            var that = this;
            setTimeout(function() {
              that.selectedContourBy = that.metadataFields[0];
            }, 0);
          }
        }
      }

      _isNumberField(_modelData, selectedContourBy) {
        return !_.isEmpty(_modelData) && this.selectedContourBy && _.isNumber(_modelData[0].metadata[this.selectedContourBy])
      }

      _isStringField(_modelData, selectedContourBy) {
        return !_.isEmpty(_modelData) && this.selectedContourBy && !_.isNumber(_modelData[0].metadata[this.selectedContourBy])
      }

      isLoadingState(modelLoading, appLoading) {
        return modelLoading || appLoading
      }

      checkValidInput() {
        //console.log(this.geometryFilter)
        if (!_.isEmpty(this.geometryFilter) && !_.isEmpty(this.boundaries) && !this.modelLoading && _.every(_.values(this.geometryFilter), function(o) {
            return o !== ""
          })) {
          this._filtersDisabled =
            parseFloat(this.geometryFilter.xMin) < this.boundaries.xMin || parseFloat(this.geometryFilter.xMin) > this.geometryFilter.xMax ||
            parseFloat(this.geometryFilter.yMin) < this.boundaries.yMin || parseFloat(this.geometryFilter.yMin) > this.geometryFilter.yMax ||
            parseFloat(this.geometryFilter.zMin) < this.boundaries.zMin || parseFloat(this.geometryFilter.zMin) > this.geometryFilter.zMax ||
            parseFloat(this.geometryFilter.xMax) > this.boundaries.xMax ||
            parseFloat(this.geometryFilter.yMax) > this.boundaries.yMax ||
            parseFloat(this.geometryFilter.zMax) > this.boundaries.zMax
        } else {
          this._filtersDisabled = true;
        }
      }

      resetFilters() {
        this.geometryFilter = _.cloneDeep(this.boundaries);
        this.checkValidInput();
        this._aggregations(this._modelData, this.selectedContourBy);
        //reset filter selection to the model boundaries
        //console.log(this.geometryFilter)
        //console.log(this.boundaries)
      }

      applyFilters() {
        //this clone below works, but it turns values into strings. must parseFloat *values*. -rsc
        // this.geometryFilter = _.cloneDeep(this.geometryFilter)
        this.geometryFilter = {
          'xMin': parseFloat(this.geometryFilter.xMin),
          'xMax': parseFloat(this.geometryFilter.xMax),
          'yMin': parseFloat(this.geometryFilter.yMin),
          'yMax': parseFloat(this.geometryFilter.yMax),
          'zMin': parseFloat(this.geometryFilter.zMin),
          'zMax': parseFloat(this.geometryFilter.zMax)
        }
        this._aggregations(this._modelData, this.selectedContourBy);
      }

      _initData(dataOptions_) {
        this.set('dataOptions', dataOptions_);
        //console.log(this.dataOptions)
        if (this.dataOptions.length > 0) {
          this.set('selectedModel', this.dataOptions[0])
        }
      }

      handleOptionsResponse(event, response) {
        var resp = response.response;
        if (resp) {
          this.appLoading = false
          this._initData(resp);
        } else {
          this.handleOptionsError();
        }
      }

      handleOptionsError(event, response) {
        this.appLoading = false;
        this._initData([]);
        alert("Couldn't fetch data.  Please check your internet connection");
      }

      handleDataResponse(event, response) {
        var resp = response.response;
        // console.log("data received")
        if (resp && resp.modelInformation.name === this.selectedModel && "payload" in resp) {
          this.appLoading = false;
          this.set('_modelData', resp.payload);
          console.log(this._modelData)
        } else {
          this.handleDataError()
        }
      }

      handleDataError(event, response) {
        this.appLoading = false;
        alert("couldn't retrieve " + this.selectedModel)
      }

      _getModelData(_selectedModel) {
        this._modelData = [];
        this.$['model-request'].url = this.baseUrl + "get-model-data/" + this.selectedModel
        this.$['model-request'].generateRequest();
        this.appLoading = true;
      }

      showDialog() {
        this.$.addModelDialog.open();
      }
    }

    window.customElements.define(ThreePolymerWireframe.is, ThreePolymerWireframe);
  </script>
</dom-module>

@license
<!--
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../bower_components/vaadin-valo-theme/vaadin-date-picker.html">
<link rel="import" href="../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../bower_components/three-polymer/three-view/three-view.html">
<link rel="import" href="../bower_components/three-polymer/three-model/three-model.html">
<link rel="import" href="../bower_components/arup-chart/arup-chart.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">

<dom-module id="three-polymer-wireframe-app">
  <template>
    <style>
      :host {
        --app-primary-color: #4285f4;
        --app-secondary-color: black;

        display: block;
      }

      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }

      app-header {
        color: #fff;
        background-color: var(--app-primary-color);
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      .drawer-list {
        margin: 0 20px;
      }

      .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }

      .three-container {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        height: 100%;
      }

      #view {
        @apply(--layout-self-center);
        @apply(--shadow-elevation-2dp);
      }

      #filter-container {
        margin-top: 60px;
      }

      .horizontal {
        @apply(--layout-horizontal);
      }

      .inline-input {
        padding: 0.1em;
        @apply(--layout-flex);
      }

      .dropdown-item {
        cursor: pointer;
        font-size: .95em;
      }

      .dropdown-item:hover {
        background-color: #C5CAE9;
      }

      #uploaded-by {
        font-size: .9em;
        color: #3F51B5;
        padding: 0;
      }

      #user-email {
        width: 250px;
      }

      paper-button.filterBtn {
        background: var(--app-primary-color);
        color: #FFF;
      }

      paper-button[disabled] {
        background: #eaeaea;
        color: #a8a8a8;
      }

      paper-dialog#addModelDialog {
        padding: 1em;
        width: 350px;
      }

      #searchFilterModal {
        padding: 1em;
        width: 315px;
      }

      paper-spinner {
        --paper-spinner-layer-1-color: #FFF;
        --paper-spinner-layer-2-color: #FFF;
        --paper-spinner-layer-3-color: #FFF;
        --paper-spinner-layer-4-color: #FFF;
      }

      #sumFieldDropDown {
        --paper-input-container-label: {
          font-size:20px;
        }
      }

      /*.numerical-aggregations-table {
        height: calc(100vh - 192px);
      }*/

      .data-by-group-table, .numerical-aggregations-table, .cost-by-group-table {
        height: calc(100vh - 240px);
        --vaadin-grid-body-row-odd-cell: {
          background-color: #f5f5f5;
        };
      }

      .num-wrapper {
        background-color: var(--paper-grey-300);
        display: grid;
        grid-template-columns: 5fr 5fr 0.5fr;
      }

      .str-header {
        background-color: var(--paper-grey-300);
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 0.2fr;
      }

      #num-contour-dropdown, #str-contour-dropdown {
        padding: 0 0.5em;
          --paper-input-container-label: {
            font-size:20px;
          }
      }

      #wrap-str-info {
        @apply(--layout-vertical);
        overflow-x:hidden;
        /*height: calc(100vh - 192px);*/
        /*overflow-y: hidden;*/
      }

      #wrap-cost-info {
        /*height: calc(100vh - 192px);*/
        /*overflow-y: hidden;*/
      }

      arup-chart {
        height: calc(100vh - 240px);
      }

      .data-by-group-table, .cost-by-group-table {
        height: calc(100vh - 240px);
      }

      #csv-button {
        margin: 60px 0 0 0;
        background: var(--app-primary-color);
        color: #FFF;
      }

      #validationToast {
        padding: 1em 1em;
        border: 1px solid gray;
      }

      .yellow-toast {
        text-transform: none;
        color: #eeff41;
      }

      #cost-tab[disabled] {
        color: #9E9E9E;
      }

      #linear-tab[disabled], #planar-tab[disabled] {
        font-style: italic;
        color: #9E9E9E;
      }

      #apply-all-div {
        display: flex;
        width: 100px;
      }

      .secondary-item {
        font-size: .7em;
        color: grey;
      }

      .model-div, .filter-input{
        @apply(--layout-horizontal);
        @apply(--layout-justified);
      }

      .model-div paper-dropdown-menu {
        @apply(--layout-flex);
      }

      paper-icon-button.filter, .clear-filter-input, .archive-icon, .menu-icon {
        @apply(--layout-self-end);
      }

      paper-icon-button#apply-all-btn {
        color: black;
        @apply(--layout-self-center);
      }

      paper-icon-button#apply-all-btn[disabled]{
        color: #9E9E9E;
      }

      #share-model {
        margin: 1em;
      }

      #apply-all-input {
        width: 65px;
      }

      .print-clean {
        border: none;
        background: transparent;
        width: 55px;
        padding: .5em;
      }

      paper-fab#strViewIcon, #costViewIcon {
         --paper-fab-background: var(--paper-blue-500);
         @apply(--layout-self-center)
      }

      paper-dialog#loadingData {
        border: 2px solid;
        border-color: #448AFF;
        background-color: #f1f8e9;
        color: #448AFF;
      }

      paper-dialog#archiveModal {
        border: 2px solid;
        border-color: var(--app-primary-color);
      }

      paper-spinner.loading {
        --paper-spinner-layer-1-color: var(--paper-blue-grey-500);
        --paper-spinner-layer-2-color: var(--paper-blue-grey-500);
        --paper-spinner-layer-3-color: var(--paper-blue-grey-500);
        --paper-spinner-layer-4-color: var(--paper-blue-grey-500);
      }

      span.pat {
        margin: 2em;
      }

      .commentBox {
        width: 93%;
        padding: .5em;
        margin-bottom: .5em
      }

      .wrapComments {
        text-align: center;
      }

      paper-icon-button#addComment {
        color: black;
      }

      paper-icon-button#addComment[disabled]{
        color: #9E9E9E;
      }

      paper-card.faq-card {
        margin: 1em;
        padding-left: 2em;
        display: flow-root;
      }

      .build-dates {
        font-size: .7em;
      }

      .model-version-details, .uploaded-details, .JSON-generated-details {
        font-size: .6em;
      }

      .buttons {
        display: flex;
      }

      #hold-header {
        margin-top: 1em;
        display: block;
      }

      #instructionsToast {
        --paper-toast-background-color: #BDBDBD;
        --paper-toast-color: black;
        margin-right: 2em;
        padding-right: 0em;
      }

      .halfPat {
        margin: 1em;
      }

      .wrapItem {
        @apply(--layout-flex);
      }

      #followingItem {
        margin-top: -.6em;
      }

    </style>

    <iron-ajax headers="{{authHeaders}}" id="get-models-request" method="GET" url="[[baseUrl]]get-models" handle-as="json" on-response="handleOptionsResponse" on-error="handleOptionsError"></iron-ajax>
    <iron-ajax headers="{{authHeaders}}" id="model-request" method="GET" handle-as="json" on-response="handleDataResponse" on-error="handleDataError"></iron-ajax>
    <iron-ajax headers="{{authHeaders}}" id="json-upload-request" method="POST" content-type="application/json" body='[[jsonUploadPayload]]' on-response="handleUploadResponse" url="[[baseUrl]]post-model"></iron-ajax>
    <iron-ajax headers="{{authHeaders}}" id="get-model-status" method="GET" handle-as="json" on-response="getModelStatus"></iron-ajax>
    <iron-ajax headers="{{authHeaders}}" id="archive-model" method="GET" handle-as="json" on-response="archiveModel"></iron-ajax>
    <iron-ajax id="get-latest-fe-commit" method="GET" url="https://api.github.com/repos/lakopite/three-polymer-wireframe/git/refs/heads/master" handle-as="json" on-response="handleGetLatestFeCommitResp" on-error="handleGetLatestCommitError"></iron-ajax>
    <iron-ajax id="get-latest-fe-commit-date" method="GET" url="https://api.github.com/repos/lakopite/three-polymer-wireframe/git/commits/[[feSha]]" handle-as="json" on-response="handleGetLatestFeCommitDateResp" on-error="handleGetLatestCommitDateError"></iron-ajax>
    <iron-ajax id="get-latest-be-commit" method="GET" url="https://api.github.com/repos/lakopite/model-viewer-api/git/refs/heads/master" handle-as="json" on-response="handleGetLatestBeCommitResp" on-error="handleGetLatestCommitError"></iron-ajax>
    <iron-ajax id="get-latest-be-commit-date" method="GET" url="https://api.github.com/repos/lakopite/model-viewer-api/git/commits/[[beSha]]" handle-as="json" on-response="handleGetLatestBeCommitDateResp" on-error="handleGetLatestCommitDateError"></iron-ajax>
    <paper-dialog modal id="addModelDialog">
      <h2>Add a Model</h2>
      <h5>*Please make sure you visit the FAQ tab to follow certain specifications for uploads</h5>
      <paper-dialog-scrollable>
        <paper-input id="user-email" label="username" prevent-invalid-input allowed-pattern="([A-Za-z0-9\._-]+)" on-input="_enableUploadBtn">
          <div slot="suffix" label="user">@arup.com</div>
        </paper-input>
        <paper-dropdown-menu id="office-dropdown" label="Select Office" on-iron-select="_enableUploadBtn">
          <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{uploadSelectedOffice}}">
            <template is="dom-repeat" items="[[officeList]]">
              <paper-item class="dropdown-item" name="[[item]]">[[item]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-dropdown-menu id="project-dropdown" label="Select Project" on-iron-select="_enableUploadBtn">
          <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{uploadSelectedProject}}">
            <template is="dom-repeat" items="[[projectList]]">
              <paper-item class="dropdown-item" name="[[item]]">[[item]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </paper-dialog-scrollable>
        <iron-input>
        <input id="modelUpload" type="file" on-change="_enableUploadBtn"></input>
        </iron-input>
        <div class="wrapComments">
          <template is="dom-repeat" items="{{commentList}}">
            <input class="commentBox" id="comment-input-[[index]]" is="iron-input" placeholder="Enter comment here..." on-change="_enableAddComment"></input>
          </template>
          <paper-icon-button id="addComment" icon="my-icons:add-circle-outline" title="add comment" on-tap="addCommentBox" disabled="{{_disableAddComment(commentList)}}"></paper-icon-button>
        </div>
      <div class="buttons">
        <paper-button dialog-dismiss on-tap="_clearUploadInput">Cancel</paper-button>
        <paper-button id="acceptUploadBtn" dialog-confirm autofocus disabled on-tap="handleJsonUpload">Upload</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog modal id="searchFilterModal">
      <h2>Filter Models</h2>
      <paper-dialog-scrollable>
        <div class="filter-input">
          <paper-dropdown-menu id="user-dropdown" label="Select User">
            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{filterSelectedUser}}">
              <template is="dom-repeat" items="[[searchOptionsMap.user]]">
                <paper-item class="dropdown-item" name="[[item]]">[[item]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
          <paper-icon-button class="clear-filter-input" id="clearFilterUser" icon="my-icons:clear" title="clear user" on-tap="clearSearchField"></paper-icon-button>
        </div>
        <div class="filter-input">
          <paper-dropdown-menu id="project-dropdown" label="Select Project">
            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{filterSelectedProject}}">
              <template is="dom-repeat" items="[[searchOptionsMap.project]]">
                <paper-item class="dropdown-item" name="[[item]]">[[item]]</paper-item>
              </template>
            </paper-listbox>
            </paper-dropdown-menu>
          <paper-icon-button class="clear-filter-input" id="clearFilterProject" icon="my-icons:clear" title="clear project" on-tap="clearSearchField"></paper-icon-button>
        </div>
        <div class="filter-input">
          <paper-dropdown-menu id="office-dropdown" label="Select Office">
            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{filterSelectedOffice}}">
              <template is="dom-repeat" items="[[searchOptionsMap.office]]">
                <paper-item class="dropdown-item" name="[[item]]">[[item]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
        <paper-icon-button class="clear-filter-input" id="clearFilterOffice" icon="my-icons:clear" title="clear office" on-tap="clearSearchField"></paper-icon-button>
        </div>
        <!-- for uploadTime -->
        <vaadin-date-picker id="from-upload-date" label="(Upload date) From" min="{{minUploadFromDate}}" max="[[todaysDate()]]"></vaadin-date-picker>
        <vaadin-date-picker id="to-upload-date" label="(Upload date) To" min="{{minUploadFromDate}}" max="[[todaysDate()]]"></vaadin-date-picker>
        <!-- for VersionDate -->
        <vaadin-date-picker id="from-model-version-date" label="(Model version date) From" min="{{minModelVersionFromDate}}" max="[[todaysDate()]]"></vaadin-date-picker>
        <vaadin-date-picker id="to-model-version-date" label="(Model version date) To" min="{{minModelVersionFromDate}}" max="[[todaysDate()]]"></vaadin-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss on-tap="clearAllFilters">Clear all</paper-button>
          <paper-button dialog-dismiss on-tap="cancelFilterInput">Cancel</paper-button>
          <paper-button on-tap="setSearchFilters">Apply</paper-button>
        </div>
      </paper-dialog-scrollable>
    </paper-dialog>
    <paper-toast id="searchResultMsg"></paper-toast>
    <paper-toast id="validationToast" duration="0" class="fit-bottom">
      <paper-button on-tap="reopenUploadBox" class="yellow-toast">Try Again</paper-button>
      <paper-button dialog-dismiss on-tap="closeValidationToast" class="yellow-toast">Cancel</paper-button>
    </paper-toast>
    <paper-toast id="pollingStatusToast" duration="0"></paper-toast>
    <paper-toast id="uploadSuccessToast" duration="5000"></paper-toast>
    <paper-toast id="linkFailToast" duration="3000"></paper-toast>
    <paper-toast id="archivingToast" duration="5000"></paper-toast>
    <app-drawer-layout id="drawerLayout" fullbleed>
    <!-- Drawer content -->
      <app-drawer id="drawer" slot="drawer" swipe-open>
      <div style="height: 100%; overflow: auto;">
      <app-toolbar>
        <paper-item>Model Options</paper-item>
      </app-toolbar>
      <div class="drawer-list">
        <div class="model-div">
          <paper-search-panel></paper-search-panel>
          <paper-icon-button id="filterIcon" class="filter" icon="my-icons:filter-list" title="filter models" on-tap="showFilterModal"></paper-icon-button>
          <paper-dropdown-menu label="Model">
          <paper-listbox id="model-options" slot="dropdown-content" attr-for-selected="name" selected="{{selectedModel}}">
            <template id="searchOptions" is="dom-repeat" items="[[dataOptions]]" filter="applySearchFilters">
              <paper-item id="model-dropdown" class="dropdown-item" name="[[item.model]]">
                <paper-item-body two-line>
                  <div class="primary-item">[[_formatModelName(item.model)]]</div>
                  <div secondary class="secondary-item">[[_formatModelTimeStamp(item.s3_attributes.uploadTime)]]</div>
                </paper-item-body>
            </paper-item>
          </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>
        <paper-button hidden$="{{_hideShareBtn(selectedModel)}}" id="share-model" class="filterBtn" on-tap="_shareModelEmail">Share via Email</paper-button>
        <div hidden$="{{_hideMainDropdown(selectedView)}}">
          <paper-dropdown-menu label="Contour" id="main-contour-dropdown">
            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
              <template is="dom-repeat" items="{{numDropdownOptions}}">
                <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
        </div>
        <div id="filter-container">
          <paper-item>Model Filters</paper-item>
          <div class="horizontal">
            <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min x" class="inline-input" type="number" value="{{geometryFilter.xMin}}" max="[[_computeMax(boundaries.xMax,geometryFilter.xMax)]]" min="[[boundaries.xMin]]"></paper-input>
            <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max x" class="inline-input" type="number" value="{{geometryFilter.xMax}}" max="[[boundaries.xMax]]" min="[[_computeMin(boundaries.xMin,geometryFilter.xMin)]]"></paper-input>
          </div>
          <div class="horizontal">
            <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min y" class="inline-input" type="number" value="{{geometryFilter.yMin}}" max="[[_computeMax(boundaries.yMax,geometryFilter.yMax)]]" min="[[boundaries.yMin]]"></paper-input>
            <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max y" class="inline-input" type="number" value="{{geometryFilter.yMax}}" max="[[boundaries.yMax]]" min="[[_computeMin(boundaries.yMin,geometryFilter.yMin)]]"></paper-input>
          </div>
          <div class="horizontal">
            <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min z" class="inline-input" type="number" value="{{geometryFilter.zMin}}" max="[[_computeMax(boundaries.zMax,geometryFilter.zMax)]]" min="[[boundaries.zMin]]"></paper-input>
            <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max z" class="inline-input" type="number" value="{{geometryFilter.zMax}}" max="[[boundaries.zMax]]" min="[[_computeMin(boundaries.zMin,geometryFilter.zMin)]]"></paper-input>
          </div>
          <div class="horizontal">
            <paper-button class="filterBtn" raised disabled$="{{_filtersDisabled}}" id="applyBtn" on-tap="applyFilters" type="number">Apply</paper-button>
            <paper-button class="filterBtn" raised disabled$="{{modelLoading}}" id="resetBtn" on-tap="resetFilters" type="number">Reset</paper-button>
          </div>
        </div>
        <!-- for csv xport button -->
        <div hidden$="{{_hideCsvButton(selectedView)}}">
          <div class="csv-button">
            <paper-button id="csv-button" on-tap="createCsv">Export Table to CSV</paper-button>
          </div>
        </div>
        <!-- end button -->
      </div>
      </div>
    <!-- </div>
    </div> -->
    </app-drawer>
    <!-- Main content -->
      <app-header-layout has-scrolling-region>
      <app-header slot="header" medium-tall>
        <app-toolbar>
          <paper-icon-button class="menu-icon" icon="my-icons:menu" on-tap="_toggleDrawer"></paper-icon-button>
          <paper-icon-button class="archive-icon" icon="my-icons:archive" title="remove model" on-tap="confirmArchive"></paper-icon-button>
          <paper-dialog id="archiveModal">
            <h3>Are you sure you want to archive the following model?</h3>
             <h4>[[selectedModel]]</h4>
             <br />
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button raised class="filterBtn" dialog-dismiss on-tap="agreeToArchive">Archive</paper-button>
          </paper-dialog>
          <div id="hold-header" main-title>
              Arup Model QuickView: [[_formatModelName(selectedModel)]]
          </div>
          <span class="pat"></span>
          <div class="spacer"></div>
          <paper-dialog modal id="loadingData">
            <h3>Pulling data from server, please wait</h3>
            <span class="pat"></span> <paper-spinner class="loading" active></paper-spinner>
          </paper-dialog>
          <paper-spinner active$="{{isLoadingState(modelLoading,appLoading)}}"></paper-spinner>
          <span class="pat"></span>
          <!-- important dates -->
          <paper-menu-button horizontal-align="right">
            <paper-icon-button class="clock-icon" icon="my-icons:access-time" title="view important dates" slot="dropdown-trigger"></paper-icon-button>
            <paper-listbox slot="dropdown-content">
              <paper-item disabled>{{ _modelVersion(currentModelResp.modelInformation.VersionDate) }}</paper-item>
              <paper-item disabled>{{ _jsonGenerated(currentModelResp.modelInformation.JSONCreateDate) }}</paper-item>
              <paper-item disabled>{{_uploadedInfo(currentModelResp.modelInformation.s3_attributes.uploadTime, currentModelResp.modelInformation.user)}}</paper-item>
              <paper-item disabled>FE build date: [[frontEndBuildDate]]</paper-item>
              <paper-item disabled>BE build date: [[backEndBuildDate]]</paper-item>
            </paper-listbox>
          </paper-menu-button>
          <!--  -->
          <paper-icon-button on-tap="showDialog" icon="my-icons:add" title="add model"></paper-icon-button>
          <paper-menu-button horizontal-align="right">
            <paper-icon-button icon="my-icons:account-circle" slot="dropdown-trigger"></paper-icon-button>
            <paper-listbox slot="dropdown-content">
              <paper-item style="cursor:pointer;" on-tap="logout">Logout</paper-item>
            </paper-listbox>
          </paper-menu-button>
        </app-toolbar>
        <app-toolbar>
          <paper-tabs bottom-item attr-for-selected="name" selected="{{selectedView}}">
            <paper-tab name="model-view">Model</paper-tab>
            <paper-tab name="aggregations-view">Quantities</paper-tab>
            <paper-tab name="cost-view" id="cost-tab" disabled$="{{_disableCostTab(metadataFields, currentModelResp, geometryFilter)}}">Cost</paper-tab>
            <paper-tab name="faq-view" id="faq-tab">FAQ</paper-tab>
          </paper-tabs>
        </app-toolbar>
      </app-header>
      <iron-pages style="height:100%;" attr-for-selected="name" selected="{{selectedView}}">
      <div name="model-view" class="three-container">
        <three-view id="view" legend-position="top-left" scene-background-color="#F5F5F5">
          <three-model id="model" slot="model" metadata-fields="{{metadataFields}}" is-loading="{{modelLoading}}" contour-by="[[selectedContourBy]]" boundaries="{{boundaries}}" geometry-filter="{{geometryFilter}}" data="[[_modelData]]"></three-model>
        </three-view>
        <paper-toast id="instructionsToast" duration="0" vertical-align="bottom" horizontal-align="right">
          <template is="dom-if" if="{{viewInstructions}}">
            <div class="wrapItem">left click & drag to rotate model<span class="halfPat"><paper-icon-button style="height: 2.5em; width: 2.5em;" icon="{{_getInstructionsIcon(viewInstructions)}}" title="clear" on-tap="toggleInstructionsView"></paper-icon-button></div>
            <div id="followingItem"style="padding: 0em;">right click & drag to move model</div>
            <div>scroll wheel to zoom in/out</div>
          </template>
          <template is="dom-if" if="{{!viewInstructions}}">
            <div class="wrapItem">View instructions<span class="halfPat"><paper-icon-button style="height: 2.5em; width: 2.5em;" icon="{{_getInstructionsIcon(viewInstructions)}}" title="view" on-tap="toggleInstructionsView"></paper-icon-button></div>
          </template>
        </paper-toast>
      </div>
      <!-- Quantities tab -->
        <!-- For numerical aggregations -->
      <div name="aggregations-view">
        <paper-tabs bottom-item attr-for-selected="name" selected="{{selectedElementType}}">
          <paper-tab name="linear-view" id="linear-tab" disabled$="{{_disableLinearTab(linearNumFilterResult, linearStringFilterResult)}}">Linear Elements</paper-tab>
          <paper-tab name="planar-view" id="planar-tab" disabled$="{{_disablePlanarTab(planarNumFilterResult, planarStringFilterResult)}}">Planar Elements</paper-tab>
        </paper-tabs>
        <div hidden$="[[!showNumericalAggregations]]">
          <div class="num-wrapper">
            <app-toolbar class="aggregation-toolbar">
              <div main-title>Aggregations</div>
            </app-toolbar>
            <paper-dropdown-menu id="num-contour-dropdown" label="Select Contour">
              <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
                <template is="dom-repeat" items="{{numDropdownOptions}}">
                  <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
                </template>
              </paper-listbox>
              </paper-dropdown-menu>
          </div>
          <!-- min/max/avg table -->
          <vaadin-grid class="numerical-aggregations-table" items="[[numericalAggregationsTableData]]">
            <vaadin-grid-column>
              <template class="header">Name</template>
              <template>[[item.name]] [[_quantUnitLabels(selectedContourBy)]]</template>
              <template class="footer">Grand Total: [[_prettify(totalResult)]] [[_quantUnitLabels(selectedContourBy)]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">Result</template>
              <template>[[_prettify(item.result)]]</template>
            </vaadin-grid-column>
          </vaadin-grid>
        </div>
        <!-- For string aggregations -->
        <div hidden$="[[!showStringAggregations]]">
          <div class="str-header">
            <app-toolbar class="aggregation-toolbar">
              <div main-title>Data by Group</div>
            </app-toolbar>
            <paper-dropdown-menu id="str-contour-dropdown" label="Select Contour">
              <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
                <template is="dom-repeat" items="{{numDropdownOptions}}">
                  <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>
            <paper-dropdown-menu class="aggregation-toolbar" id="sumFieldDropDown" label="Select Sum Field">
              <paper-listbox slot="dropdown-content" class="dropdown-content" attr-for-selected="name" selected="{{selectedSumField}}">
                <template is="dom-repeat" items="{{numericalMetadataKeys}}">
                  <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>
              <paper-fab mini id="strViewIcon" class="pie-icon" icon="{{_getStringIcon(stringPieView)}}" title="switch view" on-tap="strToggleView"></paper-fab>
          </div>
          <!-- wrap all string aggregation info -->
          <div id="wrap-str-info">
            <!-- div holds string pie chart -->
            <arup-chart hidden$="[[!stringPieView]]" y-axis-scale-factor="5" type="pie" id="strPieChart" title="Sum by Group" subtitle="{{selectedSumField}}" series="{{strPieData}}" export-file-name="{{strChartExportName}}"></arup-chart>
            <!-- data by group table -->
            <div id="group-data-table-section" hidden$="[[stringPieView]]">
              <vaadin-grid class="data-by-group-table" items="[[groupSumData]]">
                <vaadin-grid-column width="33%">
                  <template class="header">
                    <vaadin-grid-sorter path="group">group</vaadin-grid-sorter>
                  </template>
                  <template>[[item.group]]</template>
                  <template class="footer">Grand Total</template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                  <template class="header">
                    <vaadin-grid-sorter path="elemsPerGroup">elements/group</vaadin-grid-sorter>
                  </template>
                  <template>[[_prettify(item.elemsPerGroup)]]</template>
                  <template class="footer">[[_prettify(totalElements)]]</template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                  <template class="header">
                    <vaadin-grid-sorter path="sum">sum [[selectedSumField]] [[_quantUnitLabels(selectedSumField)]]</vaadin-grid-sorter>
                  </template>
                  <template>[[_prettify(item.sum)]]</template>
                  <template class="footer">[[_prettify(grandTotalSum)]] [[_quantUnitLabels(selectedSumField)]]</template>
                </vaadin-grid-column>
                <vaadin-grid-column id="otherUnitColumn">
                  <template class="header">
                    <vaadin-grid-sorter path="otherUnitSum">sum [[selectedSumField]] [[strOtherUnitLabel]]</vaadin-grid-sorter>
                  </template>
                  <template>[[_prettify(item.otherUnitSum)]]</template>
                  <template class="footer">[[_prettify(grandTotalOtherUnitSum)]] [[strOtherUnitLabel]]</template>
                </vaadin-grid-column>
                <!-- NUMERICAL AGGREGATIONS WITHIN STRING AGGREGATION TABLE-->
                <vaadin-grid-column>
                  <template class="header">min [[selectedSumField]] [[_quantUnitLabels(selectedSumField)]]</template>
                  <template>[[_prettify(item.min)]]</template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                  <template class="header">max [[selectedSumField]] [[_quantUnitLabels(selectedSumField)]]</template>
                  <template>[[_prettify(item.max)]]</template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                  <template class="header">avg [[selectedSumField]] [[_quantUnitLabels(selectedSumField)]]</template>
                  <template>[[_prettify(item.avg)]]</template>
                </vaadin-grid-column>
              </vaadin-grid>
            </div>
          </div>
      </div>
    </div>
      <!-- Cost Tab -->
      <div name="cost-view">
        <paper-tabs bottom-item attr-for-selected="name" selected="{{selectedElementType}}">
          <paper-tab name="linear-view" id="linear-tab" disabled$="{{_disableLinearTab(linearNumFilterResult, linearStringFilterResult)}}">Linear Elements</paper-tab>
          <paper-tab name="planar-view" id="planar-tab" disabled$="{{_disablePlanarTab(planarNumFilterResult, planarStringFilterResult)}}">Planar Elements</paper-tab>
        </paper-tabs>
        <div class="num-wrapper">
          <app-toolbar class="aggregation-toolbar">
            <div main-title>Cost of [[_capitalize(material)]] by Group</div>
          </app-toolbar>
          <paper-dropdown-menu id="cost-group" label="Select Group/Subgroup">
          <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedCostGroup}}">
            <template is="dom-repeat" items="[[costGroups]]">
              <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
            </template>
          </paper-listbox>
          </paper-dropdown-menu>
            <paper-fab mini disabled="{{_disableViewIcon(totalCost, costPieView)}}" id="costViewIcon" class="pie-icon" icon="{{_getCostIcon(costPieView)}}" title="switch view" on-tap="costToggleView"></paper-fab>
        </div>
        <div id="wrap-cost-info">
          <div id="cost-table-section" hidden$="[[costPieView]]">
          <!-- cost by group table -->
            <vaadin-grid class="cost-by-group-table" items="{{costTableData}}">
            <vaadin-grid-column width="200px">
              <template class="header">
                <vaadin-grid-sorter path="group">group</vaadin-grid-sorter>
              </template>
              <template>[[item.group]]</template>
              <template class="footer">Grand Total</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="elemsPerGroup">elements/group</vaadin-grid-sorter>
              </template>
              <template>[[_prettify(item.elemsPerGroup)]]</template>
              <template class="footer">[[_prettify(costTotalElements)]]</template>
            </vaadin-grid-column>
              <vaadin-grid-column>
                <template class="header">
                  <vaadin-grid-sorter path="sum">[[material]] sum [[_costUnitLabels(material, unitType)]]</vaadin-grid-sorter>
                </template>
                <template>[[_prettify(item.sum)]]</template>
                <template class="footer">[[_prettify(totalMaterialSum)]] [[_costUnitLabels(material, unitType)]]</template>
              </vaadin-grid-column>
              <vaadin-grid-column>
                <template class="header">
                  <vaadin-grid-sorter path="otherUnitSum">[[material]] sum [[costOtherUnitLabel]]</vaadin-grid-sorter>
                </template>
                <template>[[_prettify(item.otherUnitSum)]]</template>
                <template class="footer">[[_prettify(totalMaterialSumDiffUnit)]] [[costOtherUnitLabel]]</template>
              </vaadin-grid-column>
              <vaadin-grid-column style="width: 90px;">
                <template class="header">Cost/[[costOtherUnitLabel]]
                  <div id ="apply-all-div">
                    <paper-input-container style="width: 75px;">
                      <label slot="label">Apply all</label>
                      <iron-input slot="input" id="apply-all-input" prevent-invalid-input allowed-pattern="[.\d]" minlength="1" bind-value="{{applyToAll}}" on-change="{{_enableApplyAllBtn(applyToAll)}}">
                        <input class="print-clean">
                      </iron-input>
                    </paper-input-container>
                    <paper-icon-button id="apply-all-btn" on-tap="_applyAllCostResults" icon="my-icons:check-circle" title="apply to all" disabled></paper-icon-button>
                  </div>
                </template>
                <template>
                  <paper-input-container style="width: 70px;">
                    <label slot="label">Cost per unit</label>
                    <iron-input slot="input" id="cost-input-[[index]]" prevent-invalid-input allowed-pattern="[.\d]" minlength="1" bind-value="{{item.input}}" on-change="_setCostResults">
                      <input class="print-clean">
                    </iron-input>
                  </paper-input-container>
                </template>
              </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="costResult">Cost Amount</vaadin-grid-sorter>
              </template>
              <template>[[_prettifyDollar(item.costResult)]]</template>
              <template class="footer">[[_prettifyDollar(totalCost)]]</template>
            </vaadin-grid-column>
            </vaadin-grid>
          </div>
          <!-- to hold cost pie chart -->
          <arup-chart hidden$="[[!costPieView]]"  type="pie" id="costPieChart" title="Cost by Group" subtitle="{{selectedCostGroup}}" series="{{costPieData}}" export-file-name="{{costChartExportName}}"></arup-chart>
        </div>
      </div>
      <!-- FAQ -->
            <div name="faq-view">
              <paper-card class="faq-card">
                <h4>1. What can users do on this site?</h4>
                  <paper-item>a. Upload models and view them in 3D</paper-item>
                  <paper-item>b. Have easy access to automated calculations that represent measurements of their different sticks</paper-item>
                  <paper-item>c. Easily calculate of cost for each group of sticks and their subgroups</paper-item>
                  <paper-item>d. Adjust the options under the Model Filters heading in order to generate the corresponding data</paper-item>
                  <paper-item>e. View data by group/subgroup represented on a table and a a pie chart that illustrates the numerical proportion of each</paper-item>
                  <paper-item>f. Toggle back and forth between table and chart views</paper-item>
                  <paper-item>g. Share a model with a user via email</paper-item>
                  <paper-item>h. Export any of the data to a CSV file</paper-item>
                  <paper-item>i. Find models by project, office, date range, and/or the user that uploaded it using the search filter</paper-item>
                <h4>2. How do I upload a model?</h4>
                  <paper-item>1. Open Grasshopper:</paper-item>
                    <ul>- use the "FEA_Model_To_JSON_CSVInput" component to plug in the model data from Tekla/Revit</ul>
                    <ul>- make sure each model filters one material type (separate models for concrete and steel)</ul>
                    <ul>- make sure that you plug in the appropriate property names, according to what you want to sort by (*property names must have an underscore between each of them; they may not contain any spaces or special characters)</ul>
                    <ul>- make sure filename does not contain any spaces or special characters beyond underscores and does not end with a number</ul>
                    <ul>- plug in the "beamHeaders", "beamMetadadataCsv", "plateHeaders", and "plateMetadataCsv" into the "FEA_Model_To_JSON" component's "beamMetaDataNames", "beamMetaData", "shellMetaDataNames", and "shellMetaData" slots, respectively</ul>
                    <ul>- toggle boolean to true next to "activate" on the "FEA_Model_To_JSON" component</ul>
                  <paper-item>This will generate a JSON file that will appear in the folder specified in the target file location</paper-item>
                  <paper-item>2. Toggle the boolean in "activate" back to false</paper-item>
                  <paper-item>3. Log onto three-polymer-wireframe and select the + icon on the top right corner and fill in the fields on the screen</paper-item>
                <h4>3. Contact information</h4>
                  <paper-item>a.	Kermin Chok (Kermin.Chok@arup.com): Structural Engineer, Buildings, Los Angeles</paper-item>
                  <paper-item>b.	Trent Clifton (Trent.Clifton@arup.com): Web Developer, Buildings, Los Angeles</paper-item>
                  <paper-item>c.	Rubi Sanchez (Rubi.Sanchez@arup.com): Web Developer, Buildings, Los Angeles</paper-item>
                <h4>4. Web Technologies</h4>
                  <paper-item>a.	Front end framework/hosting: Polymer 2.0/Firebase</paper-item>
                  <paper-item>b.	Tables: Vaadin-Grid</paper-item>
                  <paper-item>c.	Charting: Highcharts</paper-item>
                  <paper-item>d.	3D Rendering: three-polymer</paper-item>
                  <paper-item>e.  Serverless Backend: Chalice, Node, AWS Lambda, AWS API Gateway</paper-item>
                  <paper-item>f.	Database: MongoDB</paper-item>
              </paper-card>
            </div>
          </iron-pages>
        </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>

    class ThreePolymerWireframe extends Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element) {

      static get is() {
        return 'three-polymer-wireframe-app';
      }

      static get properties() {
        return {
          authHeaders: {
            type: Object,
            value: {}
          },
          backoffCounter: {
            type: Number,
            value: 0
          },
          commentList: {
            type: Array,
            value: ['']
          },
          baseUrl: {
            type: String,
            //CI pipeline will replace with the production api link
            value: _BACKEND_URL_,
            readOnly: true
          },
          selectedModel: {
            type: String
          },
          currentModelResp: {
            type: Object
          },
          userEmail: {
            type: String
          },
          selectedContourBy: {
            type: String,
            value: "flexure"
          },
          boundaries: {
            type: Object
          },
          geometryFilter: {
            type: Object
          },
          dataOptions: {
            type: Array,
            value: []
          },
          _filtersDisabled: {
            type: Boolean,
            value: false
          },
          _modelData: {
            type: Object,
            value: {}
          },
          modelLoading: {
            type: Boolean
          },
          appLoading: {
            type: Boolean,
            value: true
          },
          _acceptUploadDisabled: {
            type: Boolean,
            value: true
            //notify: true
          },
          jsonUploadPayload: {
            type: Object,
            value: {}
          },
          metadataFields: {
            type: Array,
            value: []
          },
          avgResult: {
            type: Number,
            value: 0
          },
          minResult: {
            type: Number,
            value: 0
          },
          maxResult: {
            type: Number,
            value: 0
          },
          getAvgLabel: {
            type: String,
            value: "average"
          },
          getMinLabel: {
            type: String,
            value: "min value"
          },
          getMaxLabel: {
            type: String,
            value: "max value"
          },
          totalResult : {
            type: Number,
            value: 0
          },
          allObjectsByGroup: {
            type: Array,
            value: []
          },
          numericalAggregationsTableData: {
            type: Array,
            value: []
          },
          grandTotalSum : {
            type: Number,
            value: 0
          },
          totalCost: {
            type: Number,
            value: 0
          },
          getTotalResultLabel: {
            type: String,
            value: "total"
          },
          groupSumData: {
            type: Array,
            value: []
          },
          costTableData: {
            type: Array,
            value: []
          },
          costItems: {
            type: Array,
            value: []
          },
          strPieData: {
            type: Array
          },
          costPieData: {
            type: Array
          },
          selectedView: {
            type: String,
            value: 'model-view'
          },
          selectedSumField: {
            type: String
          },
          showNumericalAggregations: {
            type: Boolean,
            value: false
          },
          showStringAggregations: {
            type: Boolean,
            value: false
          },
          projectList: {
            type: Array,
            value: ["NLVS East", "NLVS West", "NLVS North", "NLVS South", "NLVS Operable Walls", "NLVS Roof Support", "NLVS Roof Canopy", "NLVS Cable Truss", "NLVS Bowl Concrete", "Wrapper Concrete", "Wrapper Steel", "LAX T2 New Work Steel", "LAX T3 New Work Steel", "LAX T3 HH New Work Steel", "LAX T3.5 Connector New Work Steel", "LAX Steel", "LAX Concrete", "Samples"]
          },
          officeList: {
            type: Array,
            value: ["Los Angeles", "Melbourne", "Adelaide", "Brisbane", "Perth", "Singapore", "Sydney"]
          },
          stringPieView: {
            type: Boolean,
            value: false
          },
          costPieView: {
            type: Boolean,
            value: false
          },
          viewInstructions: {
            type: Boolean,
            value: true
          }
        };
      }

      static get observers() {
        return [
          '_boundariesChanged(boundaries.*)',
          '_loadingChanged(modelLoading)',
          '_contourPropsChanged(metadataFields)',
          '_getModelData(selectedModel)',
          '_aggregations(_modelData, selectedContourBy, selectedView, selectedElementType)',
          '_getAggregationLabels(_modelData, selectedContourBy)',
          '_getSumByForSelectedSumField(selectedSumField)',
          '_getCostByForSelectedCostGroup(selectedCostGroup)',
          '_showLoading(modelLoading, appLoading)'
        ]
      }

      constructor() {
        super();
      }

      logout() {
        this.dispatchEvent(new CustomEvent('logout', {bubbles: true, composed: true}))
      }

      _showLoading(modelLoading, appLoading) {
        if (modelLoading || appLoading) {
          this.$.loadingData.open();
        } else {
          this.$.loadingData.close();
          this.$.instructionsToast.open();
        }
      }

      _toggleDrawer() {
        var drawer = Polymer.dom(this.root).querySelector("#drawer")
        var drawerLayout = Polymer.dom(this.root).querySelector("#drawerLayout")
        if (drawerLayout.forceNarrow || !drawerLayout.narrow) {
          drawerLayout.forceNarrow = !drawerLayout.forceNarrow;
        } else {
          drawerLayout.drawer.toggle();
        }
      }

      _shareModelEmail(message) {
        //for sending a link of the current model via email
        var email = '';
        var subject = "Arup Model Quickview link has been shared with you";
        var link = document.createElement("a");
        link.href =  window.location.pathname + '#' + this.selectedModel;
        var emailBody = 'Visit Arup Model Quickview link: ' + '\r\n' + link.href;
        document.location = "mailto:"+email+"?subject="+subject+"&body="+emailBody;
      }

      _formatModelName(modelName) {
        //to get model name without the prepended (GH) or appended timestamp (for main item in dropdown)
        var arr = modelName.split("_");
        return _.join(_.filter(arr,function(s) {
          return isNaN(s)
        }),' ')
      }

      _formatModelTimeStamp(_date) {
        var date = new Date(_date);
        var utcDate = new Date(date.toUTCString());
        //this does not account for daylight savings (when -8)
        utcDate.setHours(utcDate.getHours()-7);
        var pacificDate = new Date(utcDate);
        //format: yymmdd_hhmmss
        var _date = (pacificDate.getDate() <= 9 ? '0': '') + (pacificDate.getDate())
        var _month = (pacificDate.getMonth() <= 9 ? '0': '') + (pacificDate.getMonth()+1)
        var _year = pacificDate.getFullYear();
        var _year_formatted = _year.toString().substring(2)
        var _hour = (pacificDate.getHours() <= 9 ? '0': '') + pacificDate.getHours()
        var Mins = (pacificDate.getMinutes() <= 9 ? '0': '') + pacificDate.getMinutes()
        var Secs = (pacificDate.getSeconds() <= 9 ? '0': '') + pacificDate.getSeconds()
        // var timeFormat = _year_formatted + _month + _date + "_" + _hour + Mins + Secs
        var timeFormat = _year_formatted + _month + _date + " " + _hour  + ':' + Mins + ':' + Secs
        return timeFormat
      }

      // _formatModelTimeStamp(modelName) {
      //   //to get FE generated timestamp of model (for secondary text of item in dropdown)
      //   var arr = modelName.split("_")
      //   if (arr.length > 2) {
      //     if (!isNaN(arr[arr.length-1]) && !isNaN(arr[arr.length-2])) {
      //       return arr[arr.length-2] + " " + arr[arr.length-1]
      //     }
      //     if (!isNaN(arr[0]) && !isNaN(arr[1])) {
      //       return arr[0] + " " + arr[1]
      //     }
      //     if (!isNaN(arr[0])) {
      //       return arr[0]
      //     }
      //   }
      //   return ""
      // }

      _jsonGenerated(_date) {
        // to display the user that uploaded current model
        if (_.isEmpty(_date)) {
          return ''
        } else {
          return "JSON generated on: " + _date
        }
      }

      _uploadedInfo(uploadTime, user) {
        if (_.isEmpty(uploadTime)) {
          uploadTime = "unavailable date"
        }
        if (_.isEmpty(user)) {
          user = "unavailable user"
        }
        // to display the user that uploaded current model
        return "Model uploaded on " + this._convertUTCToPacific(uploadTime) + " by " + user
      }

      _modelVersion(_date) {
        // to display the user that uploaded current model
        if (_.isEmpty(_date)) {
          return ''
        } else {
          return "Model version date: " + _date
        }
      }

      requestModelStatus() {
        //console.log(this.fullFileNameNoExtension);
        this.$['get-model-status'].url = this.baseUrl + "get-model-status/" + this.fullFileNameNoExtension
        // console.log(this.$['get-model-status'].url);
        this.$['get-model-status'].generateRequest()
      }

      uploadJsonModel() {
        var that = this
        /**
          Need to add functionality to support models that exceed API Gateway Size limit (10 MB)
          if size > 10MB:
            request a pre-signed post url from backend api
          else:
            continue with existing workflow
        **/
        that.$['json-upload-request'].generateRequest();
        that._clearUploadInput()
        that.$.pollingStatusToast.show({ text: "Valid model posted to server. Waiting for confirmation..." })
        that.requestModelStatus()
        this.$.acceptUploadBtn.disabled = true
      }

      reopenUploadBox() {
        this.$.validationToast.hide()
        Polymer.dom(this.root).querySelector('#addModelDialog').open();
      }

      _getInstructionsIcon(viewInstructions) {
        return (viewInstructions) ? 'my-icons:close' : 'my-icons:expand-more'
      }

      toggleInstructionsView() {
        this.viewInstructions = !this.viewInstructions
        this.$.instructionsToast.notifyResize()
        //minimized
        if (!this.viewInstructions) {
          this.$.instructionsToast.style.cssText = "outline: none; z-index: 105; position: fixed; box-sizing: border-box; left: 1113px; top: 858px; min-width: 210px; text-align:right; padding: .5em"
        } else {
          //full
          this.$.instructionsToast.style.cssText = "outline: none; z-index: 105; position: fixed; box-sizing: border-box; left: 1074px; top: 858px; min-width: 288px; max-height: 67px;"
        }
      }

      closeValidationToast() {
        this.$.validationToast.hide()
        this.userEmail = ''
        this.uploadSelectedProject = undefined
        this.uploadSelectedOffice = undefined
      }

      addCommentBox() {
        // commentList is initialized with one blank field in order to identify the element in the array that we'll lte user assign
        var blankIndex = this.commentList.indexOf('');
        if (this.commentList.length < 5) {
          this.commentList[blankIndex] = Polymer.dom(this.root).querySelector('#comment-input-'+blankIndex).value;
          //once user input is added to array we add another blank field for the same purpose
          this.commentList = _.concat(this.commentList, '')
        } if (this.commentList.length === 5) {
          this.$.addComment.disabled = true
        }
      }

      finalCommentArr() {
        // gets final commentList contents without blank fields
        var commentListCopy = []
        for (var i=0; i < this.commentList.length; i++) {
          if (commentListCopy[i] !== '') {
            commentListCopy.push(Polymer.dom(this.root).querySelector('#comment-input-'+i).value);
          }
        }
        commentListCopy = _.without(commentListCopy, '', undefined)
        return commentListCopy
      }

      _disableAddComment(comments) {
        return comments.includes(undefined || '')
      }

      _enableAddComment() {
        if (!_.isEmpty(Polymer.dom(this.root).querySelector('.commentBox').value)) {
          this.$.addComment.disabled = false
        } else {
          this.$.addComment.disabled = true
        }
      }

      _enableUploadBtn() {
        //input fires this on-input file on-change) and dropdown menus on on-iron-select
        this.userEmail = Polymer.dom(this.root).querySelector('#user-email').value
        this.file = this.$.modelUpload.files[0]
        this.uploadSelectedProject = Polymer.dom(this.root).querySelector('#project-dropdown').value
        this.uploadSelectedOffice = Polymer.dom(this.root).querySelector('#office-dropdown').value
        if (this.file) {
          if (!_.isEmpty(this.userEmail) && !_.isEmpty(this.uploadSelectedProject) && !_.isEmpty(this.file.name) && !_.isEmpty(this.uploadSelectedOffice)) {
            this.$.acceptUploadBtn.disabled = false
          } else {
            this.$.acceptUploadBtn.disabled = true
          }
        }
      }

      handleJsonUpload(evt) {
        var inputFile = this.$.modelUpload.files[0]
        var fileName = inputFile.name
        var extension = fileName.slice(fileName.indexOf('.'))
        var fileNameWithTimeStamp = fileName.slice(0, fileName.lastIndexOf('.')) + "_" + this._currentDateTimeFormat() + extension
        this.fullFileNameNoExtension = fileNameWithTimeStamp.slice(0, fileNameWithTimeStamp.lastIndexOf('.'))
        console.log(inputFile.size / 1000000 + " MB");
      	var reader = new FileReader()
        var that = this;
        // Capture the file information
        reader.onload = (function (theFile) {
    			return function (e) {
            //console.log(theFile);//also works
    				// console.log('e readAsText = ', e);
    				// console.log('e readAsText target = ', e.target);
              //validation
            try {
              //check extension
              if (fileName.slice(-5) !== ".json")
              throw "file has a " + "\"'" + extension  + "'\"" + " extension, but must be a .json file."
              // check that this json has not already been uplaoded
              if (_.includes(_.map(that.dataOptions,'model'), this.fullFileNameNoExtension))
              throw "a file with the name " + "\"'" + this.fullFileNameNoExtension + "'\"" + " has already been uploaded."
              //parse JSON
              that.jsonUploadPayload = JSON.parse(e.target.result)
              // check that file name matches name in doc
              // if (_.toLower(that.jsonUploadPayload.modelInformation.name) + ".json"!== _.toLower(fileName))
              // throw "file name is "  + "\"'" + fileName + "'\"" + " and modelInformation.name is " + "\"'" + that.jsonUploadPayload.modelInformation.name + "'\"" + ". These must match."
              // check that modelInfo keys exists
              if (_.has(that.jsonUploadPayload, 'modelInformation') === false)
              throw "it is missing a 'modelInformation' key. This property is required."
              // check that payload key exists
              if (_.has(that.jsonUploadPayload, 'payload') === false)
              throw "it is missing payload key. This property is required."
              // check that modelInfo has units and name keys
              if (_.has(that.jsonUploadPayload, 'modelInformation.units') === false)
              throw "modelInformation must contain a 'units' key."
              if (_.has(that.jsonUploadPayload, 'modelInformation.name') === false)
              throw "modelInformation must contain a 'name' key."
              //add tags
              that.jsonUploadPayload.modelInformation.name = that.fullFileNameNoExtension
              that.jsonUploadPayload.modelInformation.user = that.userEmail
              that.jsonUploadPayload.modelInformation.project = that.uploadSelectedProject
              that.jsonUploadPayload.modelInformation.office = that.uploadSelectedOffice
              //add tag for JSONCreateDate too
              that.jsonUploadPayload.modelInformation.JSONCreateDate = that.jsonUploadPayload.modelInformation.JSONCreateDate
              //the two rows below create an "untagged" object containing user's comments at upload
              that.jsonUploadPayload.modelInformation.untagged = {}
              that.jsonUploadPayload.modelInformation.untagged.comments = that.finalCommentArr()
              console.log(that.jsonUploadPayload.modelInformation);
              // check that units are either metric or imperial only
              if (!(that.jsonUploadPayload.modelInformation.units === "metric" ||
              that.jsonUploadPayload.modelInformation.units === "imperial"))
              throw "units values must be either 'imperial' or 'metric'. " + "\"'" + that.jsonUploadPayload.modelInformation.units + "'\"" + " is not a valid unit type."
              var payloadElems = that.jsonUploadPayload.payload
              for (var i=0; i < payloadElems.length; i++) {
                // go through payload elements and ensure each has vertices and metadata keys
                if (_.has(payloadElems[i], 'vertices') === false ||
                    _.has(payloadElems[i], 'metadata') === false) {
                  throw "payload must include both a 'vertices' and 'metadata' key for each element."
                }
              }
            //if it does not get stuck on any errors above, it'll make it to the below
            that.uploadJsonModel()
          } catch (err) {
              Polymer.dom(that.root).querySelector('#modelUpload').value = ''
              var toast = Polymer.dom(that.root).querySelector('#validationToast')
              toast.show({ text: "File could not be uploaded because " + err })
            }
          }
        })(inputFile);
        reader.readAsText(inputFile);
      }

      _clearUploadInput() {
        //clears user input from upload modal
        Polymer.dom(this.root).querySelector('#modelUpload').value = ''
        // commenting out below because I want to remember the office
        // this.uploadSelectedOffice = undefined;
        this.uploadSelectedProject = undefined;
        this.commentList = [""]
        Polymer.dom(this.root).querySelector('#comment-input-0').value = ''
        this._acceptUploadDisabled = true;
      }

      _isWithinBounds(val, min, max) {
        return val >= min && val <= max
      }

      getModelStatus(event, response) {
        if (response) {
          //backoffCounter used to give code a chance to wait for the model status
          this.modelStatusResp = response.response
          if (_.has(this.modelStatusResp, 'error')) {
            if (this.modelStatusResp.error === "model not found") {
              //backoffcounter gives time to find model in db
                if (this.backoffCounter <= 10) {
                  var that = this;
                  setTimeout(function() {
                    that.backoffCounter++;
                    that.requestModelStatus();
                  }, that.backoffCounter * 1000);
                } else {
                  this.$.validationToast.show({ text: this.modelStatusResp.error}); //not in db
                }
              }
          }
          else {
            //once status is found, handle succesfully completed upload
            this.backoffCounter = 0;
            if (this.modelStatusResp.latestStatus === 200) {
              //remove all filters so user can be redirected to model without upload needing to be within filter results
              this.$.uploadSuccessToast.show({ text: "Upload successful, filters removed. Please wait to be redirected to new model."})
              this.$['get-models-request'].generateRequest();
              this.clearAllFilters();
              // this.selectedModel = this.fullFileNameNoExtension
              //refresh models and redirect to new model
              //handles upload failure
            } else if (this.modelStatusResp.latestStatus === 500) {
              this.$.validationToast.show({ text: this.modelStatusResp.latestLogMessage})
            } else if (this.modelStatusResp.latestStatus === 202) {
              //continue receiving latest statuses
              this.$.pollingStatusToast.show({ text: this.modelStatusResp.latestLogMessage})
              this.requestModelStatus()
              // eventually if this stays at 202 indefinitely it needs to just say sorry something went wrong
            }
          }
        }
        console.log(this.modelStatusResp);
      }

      confirmArchive() {
        this.$.archiveModal.open()
      }

      agreeToArchive() {
        this.$['archive-model'].url = this.baseUrl + "archive-model/" + this.selectedModel;
        this.$['archive-model'].generateRequest();
        this.$.archivingToast.show({ text: "Archiving model, please wait"});
      }

      archiveModel(event, response) {
        console.log(this.selectedModel + " archive status", response.response);
        //reload dataoptions now that this model has been removed
        if ("success" in response.response) {
          this.$['get-models-request'].generateRequest();
          this.selectedModel = this.dataOptions[0];
        }
      }

      //removed rounding functions because when I applied this to the value of the geometryfilters.#min/Max, applyFilters did not work
      // _roundDown(n) {
      //   return typeof n !== 'undefined' ? _.floor(n, 1) : ""
      // }
      //
      // _roundUp(n) {
      //   return typeof n !== 'undefined' ? _.ceil(n, 1) : ""
      // }

      // makes the numbers appear with comma formatting
      _prettify(n) {
        if (typeof n !== 'undefined' && !isNaN(n)) {
          return parseFloat(n).toLocaleString()
        } else if(n === 'undefined') {
          return ""
        } else if (isNaN(n)) {
          return "NA"
        }
      }

      _prettifyDollar(n) {
        return typeof n !== 'undefined' ? n.toLocaleString('en-US', { style: 'currency', currency: 'USD' }) : ""
      }

      _capitalize(str) {
        return typeof str !== 'undefined' ? _.capitalize(str) : ""
      }

      // _dropdownUnitLabel(item, unitType) {
      //   // displays proper units of measurements offered in dropdown
      //   var that = this;
      //   item = _.toLower(item)
      //   unitType = _.toLower(that.currentModelResp.modelInformation.units)
      //   if (item.includes('area')) {
      //     return unitType === 'imperial' ? item + ' (in\u00B2)' : item + ' (mm\u00B2)'
      //   } else if (item.includes('length')) {
      //     return unitType === 'imperial' ? item + ' (in)' : item + ' (mm)'
      //   } else if (item.includes('mass')) {
      //     return unitType === 'imperial' ? item + ' (lb)' : item + ' (kg)'
      //   } else if (item.includes('vol')) {
      //     return unitType === 'imperial' ? item + ' (in\u00B3)' : item + ' (mm\u00B3)'
      //   } else if (item.includes('thickness')) {
      //     return unitType === 'imperial' ? item + ' (in)' : item + ' (mm)'
      //   } else {
      //     return item
      //   }
      // }

      _quantUnitLabels(measurement, unitType) {
        //to display units within the vaadin-grid
      	var that = this;
        measurement = _.toLower(measurement)
        unitType = _.toLower(this.currentModelResp.modelInformation.units)
        if (unitType === 'imperial') {
        	if (measurement.includes('area')) {
          	return ' (in\u00B2)'
          } else if (measurement.includes('length')) {
              return ' (in)'
          } else if (measurement.includes('mass')) {
          	 return ' (lb)'
          } else if (measurement.includes('vol')) {
              return ' (in\u00B3)'
          } else if (measurement.includes('thickness')) {
              return ' (in)'
          } else {
              return ''
            }
        } else if (unitType === 'metric') {
        	if (measurement.includes('area')) {
          	return ' (mm\u00B2)'
          } else if (measurement.includes('length')) {
              return ' (mm)'
          } else if (measurement.includes('mass')) {
              return ' (kg)'
          } else if (measurement.includes('vol')) {
              return ' (mm\u00B3)'
          } else if (measurement.includes('thickness')) {
              return ' (mm)'
          } else {
             return ''
           }
        }
      }

      _strOtherUnitLabel(unitType, selectedSumField) {
        var otherUnitVals = ['area', 'length', 'mass', 'volume']
        if (otherUnitVals.indexOf(this.selectedSumField) === -1) {
          this.$.otherUnitColumn.hidden = true;
        } else {
          this.$.otherUnitColumn.hidden = false;
        }
        if (this.currentModelResp.modelInformation.units === 'imperial') {
            if (this.selectedSumField.includes('area')) {
              this.strOtherUnitLabel = ' (ft\u00B2)'
            } else if (this.selectedSumField.includes('length')) {
              this.strOtherUnitLabel = ' (ft)'
            } else if (this.selectedSumField.includes('mass')) {
              this.strOtherUnitLabel = ' (ton)'
            } else if (this.selectedSumField.includes('vol')) {
              this.strOtherUnitLabel = ' (yd\u00B3)'
            } else {
              this.strOtherUnitLabel = ''
            }
        } else if (this.currentModelResp.modelInformation.units === 'metric') {
          if (this.selectedSumField.includes('area')) {
              this.strOtherUnitLabel = ' (m\u00B2)'
          } else if (this.selectedSumField.includes('length')) {
            this.strOtherUnitLabel = ' (m)'
          } else if (this.selectedSumField.includes('mass')) {
            this.strOtherUnitLabel = ' (tonne)'
          } else if (this.selectedSumField.includes('vol')) {
            this.strOtherUnitLabel = ' (m\u00B3)'
          } else {
            this.strOtherUnitLabel = ''
          }
        }
      }

      _costUnitLabels(material, unitType) {
        var that = this;
        material = _.toLower(that.material)
        unitType = _.toLower(that.currentModelResp.modelInformation.units)
        if (that.material === "concrete") {
          return unitType === 'imperial' ? that.costUnitLabel =' (in\u00B3)' : that.costUnitLabel =' (mm\u00B3)'
        } if (that.material === "steel") {
          return unitType === 'imperial' ? that.costUnitLabel =' (lb)' : that.costUnitLabel =' (kg)'
        } else {
          return ''
        }
      }

      _generateNumDropdownOptions() {
        // using numDropdownOptions not metadataFields to not alter metadataFields
        this.numDropdownOptions = []
        var that = this;
        this.linearNumFilterResult = _.filter(that._modelData.linearElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        this.planarNumFilterResult = _.filter(that._modelData.planarElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        var resultFilterInput = this.selectedElementType === 'linear-view' ?  this.linearNumFilterResult : this.planarNumFilterResult
        var _numDropdownOptions = []
        for (var i=0; i < resultFilterInput.length; i++) {
          var keys = _.keys(resultFilterInput[i].metadata);
          for (var j=0; j < keys.length; j++) {
            if (_numDropdownOptions.indexOf(keys[j]) === -1 && keys[j] !== 'beamnum' && _numDropdownOptions.indexOf(keys[j]) === -1 && keys[j] !== 'shellnum') {
              _numDropdownOptions.push(keys[j])
            }
          }
        }
        this.set('numDropdownOptions', _numDropdownOptions.sort())
        if (this.numDropdownOptions.indexOf(this.selectedContourBy) === -1) {
          this.set('selectedContourBy', this.numDropdownOptions[0])
        }
      }

      _numericalAggregations() {
        this.showStringAggregations = false;
        this._generateNumDropdownOptions()
        var that = this;
        this.linearNumFilterResult = _.filter(that._modelData.linearElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        this.planarNumFilterResult = _.filter(that._modelData.planarElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        var resultFilterInput = this.selectedElementType === 'linear-view' ?  this.linearNumFilterResult : this.planarNumFilterResult
        if (resultFilterInput.length > 0 && _.includes(this.numDropdownOptions, this.selectedContourBy)) {
          this.minResult = _.round(_.minBy(resultFilterInput, function(o) {
            return o.metadata[that.selectedContourBy]
          }).metadata[this.selectedContourBy], 3)
          this.maxResult = _.round(_.maxBy(resultFilterInput, function(o) {
            return o.metadata[that.selectedContourBy]
          }).metadata[this.selectedContourBy], 3)
          var _average = []
          var average = _.forEach(resultFilterInput, function(o) {
            if (typeof o.metadata[that.selectedContourBy] !== 'undefined') {
              _average.push(o.metadata[that.selectedContourBy])
            }
          })
          this.avgResult =  _.round(_.mean(_average), 3);
          this._getAggregationLabels()
          this.numericalAggregationsTableData = []
          var name = [this.getMinLabel, this.getMaxLabel, this.getAvgLabel];
          var result = [this.minResult, this.maxResult, this.avgResult];
          for (var i=0; i < name.length; i++) {
            var setup = {
              'name': name[i],
              'result': result[i]
            }
            this.push('numericalAggregationsTableData', setup)
          }
          this.totalResult = _.round(_.sumBy(resultFilterInput, function(o) {
            return o.metadata[that.selectedContourBy]
          }), 3);
        } else {
          this.numericalAggregationsTableData = []
          this.totalResult = 0
        }
        this.showNumericalAggregations = true;
      }

      _getSumByForSelectedSumField(_selectedSumField) {
        if (typeof this.selectedSumField !== 'undefined') {
          this._stringAggregations();
        }
        return
      }

      _getCostByForSelectedCostGroup(_selectedCostGroup) {
        if (typeof this.selectedCostGroup !== 'undefined') {
          this._costAggregations()
        }
        return
      }

      _setStringPieData() {
        //for pie chart in string aggregations
        var _strPieData = []
        for (var i=0; i < this.groupSumData.length; i++) {
          var item = this.groupSumData[i]
          _strPieData.push([item.group, parseFloat(item.sum)])
          }
        this.strPieData = _strPieData;
        this.strChartExportName = this.selectedModel + "_" + this.selectedElementType.split('-')[0]  + "_" + this.selectedSumField  + "_quantities"
      }

      _generateNumMetadataKeys() {
        var that = this;
        this.linearNumFilterResult = _.filter(that._modelData.linearElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        this.planarNumFilterResult = _.filter(that._modelData.planarElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        var resultFilterInput = this.selectedElementType === 'linear-view' ?  this.linearNumFilterResult : this.planarNumFilterResult
        this.resultGroupByName = _.groupBy(resultFilterInput, function(o) {
        if (that.selectedContourBy === 'propertyname_1') {
          //to include parent group to which it belongs
          return o.metadata.propertyname_1 + " (" + o.metadata.propertyname_0 + ")"
        }
          return o.metadata[that.selectedContourBy]
        })
        // console.log("RESULTGROUPBYNAME");
        // console.log( this.resultGroupByName);
        this.groupKeys = _.without(_.keys(this.resultGroupByName), 'undefined')
        // console.log(this.groupKeys)
        this.allObjectsByGroup = []
        for (var i = 0; i < this.groupKeys.length; i++) {
          var groupObjects = this.resultGroupByName[this.groupKeys[i]]
          this.push('allObjectsByGroup', groupObjects)
        }
        var _numericalMetadataKeys = []
        var totalGroupObjects = _.flatten(this.allObjectsByGroup)
        for (var i = 0; i < totalGroupObjects.length; i++) {
          var metadataObject = totalGroupObjects[i].metadata
          var metadataValues = _.values(metadataObject)
          var metadataKeys = _.keys(metadataObject)
          for (var j = 0; j < metadataKeys.length; j++) {
            //to include only these in dropdown menu
            //var validSumGroups = ['meta_length', 'length', 'meta_mass', 'mass', 'meta_vol', 'vol', 'volume']
            var ignoreSumGroups = ['beamnum', 'density', 'shellnum']
            // to find unique keys with numeric values for dropdown options
            //&& validSumGroups.indexOf(metadataKeys[j]) !== -1
            if(_.isNumber(metadataValues[j]) && _numericalMetadataKeys.indexOf(metadataKeys[j]) === -1 && ignoreSumGroups.indexOf(metadataKeys[j]) === -1) {
              _numericalMetadataKeys.push(metadataKeys[j])
            }
            this.set('numericalMetadataKeys', _numericalMetadataKeys.sort())
          }
        }
      }

      _createStringTableData() {
        var that = this;
        var _groupSumData = [];
       // console.log(this.groupSumData);
         for (var i = 0; i < this.groupKeys.length; i++) {
         //reusing var groupObjects below (was local variable in previous loop for numericalMetadataKeys)
           var groupObjects = this.resultGroupByName[this.groupKeys[i]]
           var elemsPerGroup = groupObjects.length
           var vals = []
           for (var j = 0; j < groupObjects.length; j++) {
             if (groupObjects[j].metadata[that.selectedSumField] !== undefined) {
               vals.push(groupObjects[j].metadata[that.selectedSumField])
             }
           }
           var sumByGroup = _.round(_.sum(vals), 0)
           var minByGroup = isFinite(Math.min(...vals)) ? _.round(Math.min(...vals), 0) : 'NA'
           var maxByGroup = isFinite(Math.max(...vals)) ? _.round(Math.max(...vals), 0) : 'NA'
           var avgByGroup = isFinite(minByGroup) && isFinite(maxByGroup)  ? _.round(sumByGroup/elemsPerGroup, 3) : 'NA'
           //if they do not have other unit label; _strOtherUnitLabel() will hide the otherUnitColumn
           if (that.currentModelResp.modelInformation.units === 'imperial') {
             if (that.selectedSumField.includes('length')) {
               this.strOtherUnitSum = _.round(sumByGroup/12, 0)
             } else if (that.selectedSumField.includes('mass')) {
               this.strOtherUnitSum = _.round(sumByGroup/2000, 0)
             } else if (that.selectedSumField.includes('vol')) {
               this.strOtherUnitSum = _.round(sumByGroup/46656, 0)
             } else if (that.selectedSumField.includes('area')) {
               this.strOtherUnitSum = _.round(sumByGroup/144, 0)
             }
           } else if (that.currentModelResp.modelInformation.units === 'metric') {
             if (that.selectedSumField.includes('length')) {
               this.strOtherUnitSum = _.round(sumByGroup/1000, 0)
             } else if (that.selectedSumField.includes('mass')) {
               this.strOtherUnitSum = _.round(sumByGroup/1000, 0)
             } else if (that.selectedSumField.includes('vol')) {
               this.strOtherUnitSum = _.round(sumByGroup/1000000000, 0)
             } else if (that.selectedSumField.includes('area')) {
               this.strOtherUnitSum = _.round(sumByGroup/1000000, 0)
             }
           }
           var groupSumDataSetup = {
             'group': this.groupKeys[i],
             'elemsPerGroup': elemsPerGroup,
             'sum': sumByGroup,
             'otherUnitSum': this.strOtherUnitSum,
             'min' : minByGroup,
             'max' : maxByGroup,
             'avg' : avgByGroup
           }
           _groupSumData.push(groupSumDataSetup)
           this.push('allObjectsByGroup', groupObjects)
         }
         this.set('groupSumData',_.sortBy(_groupSumData, [function(o) { return o.group }]))
         // for strOtherUnitLabel (column to the right with different unit)
         this._strOtherUnitLabel()
         // to display number of elements per group
         this.totalElements = _.round(_.sumBy(this.groupSumData, function(o) {
           return o.elemsPerGroup
         }), 0)
         this.grandTotalSum = _.round(_.sumBy(this.groupSumData, function(o) {
           return o.sum
         }), 1)
         this.grandTotalOtherUnitSum = _.round(_.sumBy(this.groupSumData, function(o) {
           return o.otherUnitSum
         }), 1)
         this._setStringPieData()
      }

      _stringAggregations() {
        this.showNumericalAggregations = false;
        var that = this
        // ================ repeated function start ==========================================
        this.linearStringFilterResult = _.filter(that._modelData.linearElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        this.planarStringFilterResult = _.filter(that._modelData.planarElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        var resultFilterInput = this.selectedElementType === 'linear-view' ?  this.linearStringFilterResult : this.planarStringFilterResult
        // this is to add a propertyname field that groups together anything after the last underscore in case naming convention divided this
        resultFilterInput = _.forEach(resultFilterInput, function(o) {
          if (o.metadata.propertyname) {
            var propname = o.metadata.propertyname;
          } else {
            var propname = o.metadata.meta_propname_1;
          }
          var splitPropname = propname.split("_");
          return o.metadata.propertyname_last = splitPropname[splitPropname.length-1];
        })
        this._generateNumDropdownOptions()
        if (resultFilterInput.length > 0) {
          this._generateNumMetadataKeys()
          if (typeof this.selectedSumField === 'undefined' || !_.includes(this.numericalMetadataKeys, this.selectedSumField)) {
            var that = this;
            setTimeout(function() {
              if (that.numericalMetadataKeys) {
                that.set('selectedSumField', that.numericalMetadataKeys[0])
                that._createStringTableData()
              }
            }, 0)
         } else {
           if (!_.includes(this.numDropdownOptions, this.selectedContourBy)) {
            this.$.sumFieldDropDown.disabled = true
          } else if (_.includes(this.numDropdownOptions, this.selectedContourBy)) {
            this.$.sumFieldDropDown.disabled = false
          }
           this._createStringTableData()
          }
        } else {
          this.groupSumData = []
          this.totalElements = 0
          this.grandTotalSum = 0
          this.grandTotalOtherUnitSum = 0
          this.strPieData = []
        }
        this.showStringAggregations = true;
      }

      _aggregations(_modelData, selectedContourBy, _currentPage, _selectedElementType) {
        if(this.selectedView === 'cost-view') {
          this._disableCostTab()
        }
        if (this._isNumberField(_modelData, selectedContourBy)) {
          this._numericalAggregations();
          return
        }
        if (this._isStringField(_modelData, selectedContourBy)) {
          this._stringAggregations();
          return
        }
        this.showStringAggregations = false;
        this.showNumericalAggregations = false;
      }

      _getAggregationLabels() {
        if (typeof this.selectedContourBy === 'undefined' || typeof this.selectedModel === 'undefined') {
          this.getAvgLabel = "Avg unavailable"
          this.getMinLabel = "Min unavailable"
          this.getMaxLabel = "Max unavailable"
          this.getTotalResultLabel = "Total unavailable"
        } else {
          this.getAvgLabel = "Avg " + _.capitalize(this.selectedContourBy)
          this.getMinLabel = "Min " + _.capitalize(this.selectedContourBy)
          this.getMaxLabel = "Max " + _.capitalize(this.selectedContourBy)
          this.getTotalResultLabel = "Total " + _.capitalize(this.selectedContourBy)
        }
      }

      _hideShareBtn(_model) {
        return typeof this.selectedModel === 'undefined'
      }

      _disableViewIcon(totalCost, costPieView) {
        // if total cost is 0, no need to offer chart view
        return totalCost === 0 && !costPieView
      }

      _getStringIcon(stringPieView) {
        return (stringPieView) ? 'my-icons:list' : 'my-icons:pie-chart'
      }

      _getCostIcon(costPieView) {
        return (costPieView) ? 'my-icons:list' : 'my-icons:pie-chart'
      }

      strToggleView() {
        if (this.selectedView === "aggregations-view" && this.showStringAggregations === true) {
          this.stringPieView = !this.stringPieView
        }
        if (this.selectedView === "aggregations-view" && this.showStringAggregations === true && !this.stringPieView) {
          this._stringAggregations()
        }
      }

      costToggleView() {
        if (this.selectedView === "cost-view") {
          this.costPieView = !this.costPieView
        }
        if (this.selectedView === "cost-view" && !this.costPieView) {
          this._costAggregations()
        }
      }

      ready() {
        super.ready();
        this.$['get-models-request'].generateRequest();
        this.$['get-latest-fe-commit'].generateRequest();
        this.$['get-latest-be-commit'].generateRequest();
        Polymer.dom(this.root).querySelector('#instructionsToast').show()
      }

      handleGetLatestFeCommitResp(event, response) {
        var resp = response.response;
        // console.log(resp);
        // console.log(resp.object.sha);
        this.feSha = resp.object.sha
        this.$['get-latest-fe-commit-date'].generateRequest();
      }

      handleGetLatestBeCommitResp(event, response) {
        var resp = response.response;
        // console.log(resp);
        // console.log(resp.object.sha);
        this.beSha = resp.object.sha;
        this.$['get-latest-be-commit-date'].generateRequest();
      }

      handleGetLatestCommitError(event, response) {
        console.log("Error retrieving latest commit.");
        this.frontEndBuildDate = 'unavailable';
        this.backEndBuildDate = 'unavailable';
      }

      handleGetLatestFeCommitDateResp(event, response) {
          var resp = response.response;
          // console.log(resp);
          var date = resp.author.date;
          // console.log(date);
          // console.log(date.slice(0, 10));
          this.frontEndBuildDate = date.slice(0, 10);
      }

      handleGetLatestBeCommitDateResp(event, response) {
          var resp = response.response;
          // console.log(resp);
          var date = resp.author.date;
          // console.log(date);
          // console.log(date.slice(0, 10));
          this.backEndBuildDate = date.slice(0, 10);
      }

      handleGetLatestCommitDateError() {
        // console.log("Error retrieving date of latest commit.");
        this.frontEndBuildDate = 'unavailable';
        this.backEndBuildDate = 'unavailable';
      }

      _currentDateTimeFormat() {
        // displays current timestamp with format: yymmdd_hhmmss
        var d = new Date();
        var curr_date = (d.getDate() <= 9 ? '0': '') + (d.getDate())
        var curr_month = (d.getMonth() <= 9 ? '0': '') + (d.getMonth()+1)
        var curr_year = d.getFullYear();
        var curr_year_formatted = curr_year.toString().substring(2)
        var curr_hour = (d.getHours() <= 9 ? '0': '') + d.getHours()
        var currMins = (d.getMinutes() <= 9 ? '0': '') + d.getMinutes()
        var currSecs = (d.getSeconds() <= 9 ? '0': '') + d.getSeconds()
        var timeFormat = curr_year_formatted + curr_month + curr_date + "_" + curr_hour + currMins + currSecs
        return timeFormat
      }

      _convertUTCToPacific(_date) {
        var date = new Date(_date);
        var utcDate = new Date(date.toUTCString());
        utcDate.setHours(utcDate.getHours()-7);
        var pacificDate = new Date(utcDate);
        //format: yymmdd_hhmmss
        var _date = (pacificDate.getDate() <= 9 ? '0': '') + (pacificDate.getDate())
        var _month = (pacificDate.getMonth() <= 9 ? '0': '') + (pacificDate.getMonth()+1)
        var _year = pacificDate.getFullYear();
        var _year_formatted = _year.toString().substring(2)
        var _hour = (pacificDate.getHours() <= 9 ? '0': '') + pacificDate.getHours()
        var Mins = (pacificDate.getMinutes() <= 9 ? '0': '') + pacificDate.getMinutes()
        var Secs = (pacificDate.getSeconds() <= 9 ? '0': '') + pacificDate.getSeconds()
        // var timeFormat = _year_formatted + _month + _date + "_" + _hour + Mins + Secs
        var timeFormat = _year + '-' + _month  + '-' + _date + " " + _hour  + ':' + Mins + ':' + Secs
        return timeFormat
      }

      // _toUTCFormat(date) {
      //   //convert a date to utc
      //   var date = new Date(date);
      //   var utc = new Date( date.getTime() + (date.getTimezoneOffset() * 60000));
      //   //format: yymmdd_hhmmss
      //   var curr_date = (utc.getDate() <= 9 ? '0': '') + (utc.getDate())
      //   var curr_month = (utc.getMonth() <= 9 ? '0': '') + (utc.getMonth()+1)
      //   var curr_year = utc.getFullYear();
      //   var curr_year_formatted = curr_year.toString().substring(2)
      //   var curr_hour = (utc.getHours() <= 9 ? '0': '') + utc.getHours()
      //   var currMins = (utc.getMinutes() <= 9 ? '0': '') + utc.getMinutes()
      //   var currSecs = (utc.getSeconds() <= 9 ? '0': '') + utc.getSeconds()
      //   var timeFormat = curr_year_formatted + curr_month + curr_date + "_" + curr_hour + currMins + currSecs
      //   return timeFormat
      // }

      _currentFilters() {
        // displays currently applied geometry filters
        return "Filters:" + '\r\n' +
        'min x, ' + this.geometryFilter.xMin + '\r\n' + 'max x, ' + this.geometryFilter.xMax + '\r\n' +
        'min y, ' + this.geometryFilter.yMin + '\r\n' + 'max y, ' + this.geometryFilter.yMax + '\r\n' +
        'min z, ' + this.geometryFilter.zMin + '\r\n' + 'max z, ' + this.geometryFilter.zMax
      }

      createNumericalCsv() {
        var elementType = this.selectedElementType.split('-')[0]
        var rowData = ''
        if (this.numericalAggregationsTableData.length > 0) {
          for (var i=0; i < this.numericalAggregationsTableData.length; i++) {
            this.numDataHeaders = _.keys(this.numericalAggregationsTableData[i])
            var el = _.values(this.numericalAggregationsTableData[i]) + '\r\n'
          	rowData += el
          }
          var that = this;
          var headers_ = _.map(this.numDataHeaders, function(h) {
            if (h === 'name') {
              return h
            }
            return h + that._quantUnitLabels(that.selectedContourBy)
          })
          this.numDataHeaders = headers_ + '\r\n'
          var csvData = this.numDataHeaders + rowData + '\r\n' + this._currentFilters() + '\r\n' + "Element type: " + elementType + '\r\n' + "Downloaded on: " + this._currentDateTimeFormat()
          var uri = 'data:text/csv;charset=utf-8,' + escape(csvData);
          var link = document.createElement("a");
          link.href = uri;
          link.style = "visibility:hidden";
          link.download = this.selectedModel + "_" + elementType + "_elements" + ".csv";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }

      createGroupDataCsv() {
        var elementType = this.selectedElementType.split('-')[0]
        var rowData = ''
        if (this.groupSumData.length > 0) {
          for (var i=0; i < this.groupSumData.length; i++) {
            this.groupDataHeaders = _.keys(this.groupSumData[i])
            var el = _.values(this.groupSumData[i]) + '\r\n'
            rowData += el
          }
          var that = this;
          var headers_ = _.map(this.groupDataHeaders,function(h) {
            if (h === 'group') {
              return h
            } if (h === 'elemsPerGroup') {
              return "elements per group"
            } if (h === 'otherUnitSum') {
              return that.selectedSumField + " sum " + that.strOtherUnitLabel
            }
            return that.selectedSumField + " " + h + that._quantUnitLabels(that.selectedSumField)
          })
          this.groupDataHeaders = headers_ + '\r\n';
          var csvData = this.groupDataHeaders + rowData + '\r\n' + this._currentFilters() + '\r\n' + "Element type: " + elementType + '\r\n' + "Downloaded on: " + this._currentDateTimeFormat()
          var uri = 'data:text/csv;charset=utf-8,' + escape(csvData);
          var link = document.createElement("a");
          link.href = uri;
          link.style = "visibility:hidden";
          link.download = this.selectedModel + "_" + elementType + "_elements" + ".csv";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }

      createCostDataCsv() {
        var elementType = this.selectedElementType.split('-')[0]
        var rowData = ''
        if (this.costTableData.length > 0) {
          for (var i=0; i < this.costTableData.length; i++) {
            this.costTableHeaders = _.keys(this.costTableData[i])
            var el = _.values(this.costTableData[i]) + '\r\n'
            rowData += el
          }
          var that = this;
          var headers_ = _.map(this.costTableHeaders,function(h) {
            if (h === 'group') {
              return h
            } if (h === 'elemsPerGroup') {
              return "elements per group"
            } if (h === 'sum') {
              return that.material + " sum " + that.costUnitLabel
            } if (h === 'otherUnitSum') {
              return that.material + " sum " + that.costOtherUnitLabel
            } if (h === 'input') {
              return "cost per " + that.costOtherUnitLabel
            } if (h === 'costResult') {
              return "cost amount"
            }
          })
          this.costTableHeaders = headers_ + '\r\n';
          var csvData = this.costTableHeaders + rowData + '\r\n' + this._currentFilters() + '\r\n' + "Element type: " + elementType + '\r\n' + "Downloaded on: " + this._currentDateTimeFormat()
          var uri = 'data:text/csv;charset=utf-8,' + escape(csvData);
          var link = document.createElement("a");
          link.href = uri;
          link.style = "visibility:hidden";
          link.download = this.selectedModel + "_" + elementType + "_elements" + ".csv";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }

      _hideMainDropdown(_currentPage) {
        return this.selectedView === 'aggregations-view' || this.selectedView === 'cost-view';
      }

      _hideCsvButton(_currentPage) {
        return this.selectedView !== 'aggregations-view' && this.selectedView !== 'cost-view';
      }

      createCsv() {
        if (this.selectedView === 'aggregations-view') {
          if (this.showNumericalAggregations) {
            this.createNumericalCsv();
          }
          else if (this.showStringAggregations) {
            this.createGroupDataCsv();
          }
        } else if (this.selectedView === 'cost-view') {
          this.createCostDataCsv();
        }
      }

      _disableCostTab(_currentMetadataFields, _currentModel, _geoFilter) {
       if (!_.isEmpty(this.geometryFilter) && this.metadataFields.includes('material')) {
         // var payloadElems = _.concat(this.currentModelResp.payload.linearElements, this.currentModelResp.payload.planarElements)
         var payloadElems = this.selectedElementType === 'linear-view' ?  this.currentModelResp.payload.linearElements : this.currentModelResp.payload.planarElements
         for (var i=0; i < payloadElems.length; i++) {
           this.material = _.toLower(payloadElems[i].metadata.material)
           //console.log(payloadElems[i]);
           // go through payload elements and their metadata keys
           if (this.material === 'concrete' && _.has(payloadElems[i], 'metadata.volume') ||  _.has(payloadElems[i], 'metadata.vol') ||  _.has(payloadElems[i], 'metadata.meta_volume') ||
               this.material === 'steel' && _.has(payloadElems[i], 'metadata.mass') || _.has(payloadElems[i], 'metadata.meta_mass')) {
             // console.log("material cost for: " + this.material)
             // console.log("does it include 'conc': " + this.material.includes('conc'))
             // console.log("does it include 'steel': " + this.material.includes('steel'))
             this._costAggregations()
             return false
           } else {
             //console.log("cost-tab should be DISABLED!");
           }
         }
       }
       return true
     }

      _setCostPieData() {
        var _costPieData = []
        for (var i=0; i < this.costTableData.length; i++) {
          var item = this.costTableData[i]
          _costPieData.push([item.group, parseFloat(item.costResult)])
          }
        this.costPieData = _costPieData;
        this.costChartExportName = this.selectedModel + "_" + this.selectedElementType.split('-')[0] + "_cost"
      }

      _enableApplyAllBtn(applyToAll) {
        if (applyToAll !== undefined && applyToAll !== '' && applyToAll !== 0) {
          Polymer.dom(this.root).querySelector('#apply-all-btn').disabled = false
        } else {
          Polymer.dom(this.root).querySelector('#apply-all-btn').disabled = true
        }
      }

      _applyAllCostResults() {
        // for apply all button within cost tab
        for (var i=0; i < this.costTableData.length; i++) {
            this.set('costTableData.'+i+'.input', this.applyToAll)
            this.set('costTableData.'+i+'.costResult', this.costTableData[i].input*this.costTableData[i].otherUnitSum);
        }
        if (this.costItems.length === 0) {
        for (var i=0; i < this.costTableData.length; i++) {
            this.costItems.push({'model': this.selectedModel, 'group': this.costTableData[i].group, 'input': this.costTableData[i].input})
          }
        } else {
          //if group already in costItems, overwrite input value
          for (var i=0; i < this.costTableData.length; i++) {
            for (var j=0; j < this.costItems.length; j++) {
              if (this.costTableData[i].group === this.costItems[j].group && this.costItems[j].model === this.selectedModel) {
                this.set('costItems.'+j+'.input', this.costTableData[i].input);
              }
            }
          } //if group not there, push onto costItems
          var costItemGroups = []
          _.forEach(this.costItems, function(o) {
             costItemGroups.push(o.group)
          })
          for (var i=0; i < this.costTableData.length; i++) {
          if (costItemGroups.indexOf(this.costTableData[i].group) === -1) {
            this.costItems.push({'model': this.selectedModel, 'group': this.costTableData[i].group, 'input': this.costTableData[i].input})
            }
          }
        }
        this.totalCost = _.sumBy(this.costTableData, function(o) {
          return o.costResult
        })
        this._setCostPieData()
        this.applyToAll = ''
      }

      _setCostResults(e) {
        // when user inserts cost input individually (not the apply all button), sets input and result (product of input and otherUnitSum)
        var item = e.model.item
        var inputIndex = e.model.index
        for (var i=0; i < this.costTableData.length; i++) {
          if (i === inputIndex) {
            // console.log("values: " + e.target.value + " : " + this.costTableData[i].input)
            this.set('costTableData.'+i+'.costResult', this.costTableData[i].input * this.costTableData[i].otherUnitSum);
          }
        }
        //if no user input has been saved to costItems object, save the input
        if (this.costItems.length === 0) {
          this.costItems.push({'model': this.selectedModel, 'group': item.group, 'input': item.input})
          console.log(e.target.value);
          // console.log(item.input);
        } else {
          // if costItems is not empty then check to see if that item in the group column already exists within costItems
          var found = this.costItems.some(function (el) {
            return el.group === item.group;
          });
          // if it's not on there then save the user input in costItems object
          if (!found) {
            this.costItems.push({'model': this.selectedModel, 'group': item.group, 'input': item.input})
          } else if (found) {
            // if it is already in costItems then save the latest input to overwrite the current info within costItems for that group
            for (var i=0; i < this.costItems.length; i++) {
              if (this.costItems[i].group === item.group && this.costItems[i].model === this.selectedModel) {
                this.costItems[i].input = item.input
              }
            }
          }
        }
        this.totalCost = _.sumBy(this.costTableData, function(o) {
          return o.costResult
        })
        // console.log(this.costItems);
        this._setCostPieData()
      }

      _updateCostValues() {
        // in case user enters a different value, set new input and recalculate cost result; use costItems to check if there is any user input that already exists
        if (typeof this.costItems !== 'undefined') {
          // update if costItems has information saved onto there (overwrite previous input)
          for (var i=0; i < this.costTableData.length; i++) {
            for (var j=0; j < this.costItems.length; j++) {
              if (this.costTableData[i].group == this.costItems[j].group && this.selectedModel === this.costItems[j].model) {
                //console.log(this.costTableData[i].group + " = " + this.costItems[j].group);
                this.set('costTableData.'+i+'.input', this.costItems[j].input);
                this.set('costTableData.'+i+'.costResult', this.costTableData[i].input*this.costTableData[i].otherUnitSum);
              }
            }
          }
          this.totalCost = _.sumBy(this.costTableData, function(o) {
            return o.costResult
          })
          this._setCostPieData()
        }
      }

      _disableLinearTab(linearNumFilterResult, linearStringFilterResult) {
        return _.isEmpty(linearNumFilterResult) && _.isEmpty(linearStringFilterResult)
      }

      _disablePlanarTab(planarNumFilterResult, planarStringFilterResult) {
        return _.isEmpty(planarNumFilterResult) && _.isEmpty(planarStringFilterResult)
      }

      _costAggregations() {
        var that = this
        // ================ repeated function start ==========================================
        this.linearStringFilterResult = _.filter(that._modelData.linearElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        this.planarStringFilterResult = _.filter(that._modelData.planarElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        var resultFilterInput = this.selectedElementType === 'linear-view' ?  this.linearStringFilterResult : this.planarStringFilterResult
        // this is to add a propertyname field that groups together anything after the last underscore in case naming convention divided this
        resultFilterInput = _.forEach(resultFilterInput, function(o) {
          if (o.metadata.propertyname) {
            var propname = o.metadata.propertyname;
          } else {
            var propname = o.metadata.meta_propname_1;
          }
          var splitPropname = propname.split("_");
          return o.metadata.propertyname_last = splitPropname[splitPropname.length-1];
        })
        if (resultFilterInput.length > 0) {
          this.costGroups = []
          for (var i=0; i < this.metadataFields.length; i++) {
            if (this.metadataFields[i].includes('propertyname')) {
              this.push('costGroups', this.metadataFields[i])
            };
          }
          if (typeof this.selectedCostGroup === 'undefined') {
            this.selectedCostGroup = this.costGroups[0]
          }
          var groupsForMaterial = _.groupBy(resultFilterInput, function(o) {
            if (that.selectedCostGroup === 'propertyname_1') {
              return o.metadata.propertyname_1 + " (" + o.metadata.propertyname_0 + ")"
            }
            return o.metadata[that.selectedCostGroup]
          })
          // ================ repeated pattern for CODE end ==========================================
          var unitType = this.currentModelResp.modelInformation.units
          // console.log(unitType);
          var _costTableData = []
          // console.log(this.costTableData);
          var groupKeys = _.without(_.keys(groupsForMaterial), 'undefined')
          var allObjectsByMaterialGroup = []
          if (this.material === 'concrete') {
            for (var i=0; i < groupKeys.length; i++) {
              var groupObjects = groupsForMaterial[groupKeys[i]];
              var elemsPerGroup = groupObjects.length
              allObjectsByMaterialGroup.push(groupObjects)
              var sumByGroup = _.sumBy(groupObjects, function(o) {
                return o.metadata.volume
              })
              var _otherUnitSum = unitType === 'imperial' ? _.round(sumByGroup/46656, 2) : _.round(sumByGroup/1000000000, 2)
              this.costOtherUnitLabel = unitType === 'imperial' ? '(yd\u00B3)' : '(m\u00B3)'
              var costTableDataSetup = {
                'group': groupKeys[i],
                'elemsPerGroup': elemsPerGroup,
                'sum': sumByGroup,
                'otherUnitSum': _otherUnitSum,
                'input': 0
              }
              costTableDataSetup['costResult'] = costTableDataSetup.otherUnitSum * costTableDataSetup.input;
              _costTableData.push(costTableDataSetup)
            }
            this.set('costTableData', _.sortBy(_costTableData, [function(o) { return o.group }]))
          } else if (this.material === 'steel') {
            for (var i=0; i < groupKeys.length; i++) {
              var groupObjects = groupsForMaterial[groupKeys[i]];
              var elemsPerGroup = groupObjects.length
              allObjectsByMaterialGroup.push(groupObjects)
              var sumByGroup = _.sumBy(groupObjects, function(o) {
                return o.metadata.mass
              })
              var _otherUnitSum = unitType === 'imperial' ? _.round(sumByGroup/2000, 2) : _.round(sumByGroup/1000, 2)
              this.costOtherUnitLabel = unitType === 'imperial' ? ' (ton)' : ' (tonne)'
              var costTableDataSetup = {
                'group': groupKeys[i],
                'elemsPerGroup': elemsPerGroup,
                'sum': sumByGroup,
                'otherUnitSum': _otherUnitSum,
                'input': 0
              }
              costTableDataSetup['costResult'] = costTableDataSetup.otherUnitSum * costTableDataSetup.input;
              _costTableData.push(costTableDataSetup)
            }
            this.set('costTableData', _.sortBy(_costTableData, [function(o) { return o.group }]))
          }
          this.costTotalElements = _.round(_.sumBy(this.costTableData, function(o) {
           return o.elemsPerGroup
          }), 0)
          this.totalMaterialSum = _.round(_.sumBy(this.costTableData, function(o) {
            return o.sum
          }), 3)
          this.totalMaterialSumDiffUnit = _.round(_.sumBy(this.costTableData, function(o) {
            return o.otherUnitSum
          }), 3)
          this._updateCostValues()
        } else {
          this.costTableData = []
          this.costTotalElements = 0
          this.totalMaterialSum = 0
          this.totalMaterialSumDiffUnit = 0
          this.totalCost = 0
        }
      }

      //Ensure that the geometry input is within boundaries and is compatible with its input sibling
      _computeMin(_b, _g) {
        _g = parseFloat(_g)
        if (_.isNumber(_g)) {
          return (_g > _b) ? _g : _b
        }
        return _b
      }

      _computeMax(_b, _g) {
        _g = parseFloat(_g)
        if (_.isNumber(_g)) {
          return (_g < _b) ? _g : _b
        }
        return _b
      }

      _boundariesChanged(boundaries) {
        this.resetFilters();
        //console.log(this.boundaries)
      }

      _loadingChanged(modelLoading) {
        //console.log(modelLoading)
        this.checkValidInput();
      }

      _contourPropsChanged(metadataFields) {
        this.metadataFields = this.metadataFields.sort();
        if (this.metadataFields.indexOf(this.selectedContourBy) === -1) {
          this.selectedContourBy = undefined;
          if (this.metadataFields.length > 0) {
            var that = this;
            setTimeout(function() {
              that.selectedContourBy = that.metadataFields[0];
            }, 0);
          }
        }
      }

      _isNumberField(_modelData, selectedContourBy) {
          return !_.isEmpty(_modelData.linearElements)  && this.selectedContourBy && _.isNumber(_modelData.linearElements[0].metadata[this.selectedContourBy]) || !_.isEmpty(_modelData.planarElements)  && this.selectedContourBy && _.isNumber(_modelData.planarElements[0].metadata[this.selectedContourBy])
      }

      _isStringField(_modelData, selectedContourBy) {
        return !_.isEmpty(_modelData.linearElements) && typeof this.selectedContourBy !== 'undefined' && !_.isNumber(_modelData.linearElements[0].metadata[this.selectedContourBy]) || !_.isEmpty(_modelData.planarElements) && typeof this.selectedContourBy !== 'undefined' && !_.isNumber(_modelData.planarElements[0].metadata[this.selectedContourBy])
      }

      isLoadingState(modelLoading, appLoading) {
        return modelLoading || appLoading
      }

      checkValidInput() {
        //console.log(this.geometryFilter)
        if (!_.isEmpty(this.geometryFilter) && !_.isEmpty(this.boundaries) && !this.modelLoading && _.every(_.values(this.geometryFilter), function(o) {
            return o !== ""
          })) {
          this._filtersDisabled =
            parseFloat(this.geometryFilter.xMin) < this.boundaries.xMin || parseFloat(this.geometryFilter.xMin) > this.geometryFilter.xMax ||
            parseFloat(this.geometryFilter.yMin) < this.boundaries.yMin || parseFloat(this.geometryFilter.yMin) > this.geometryFilter.yMax ||
            parseFloat(this.geometryFilter.zMin) < this.boundaries.zMin || parseFloat(this.geometryFilter.zMin) > this.geometryFilter.zMax ||
            parseFloat(this.geometryFilter.xMax) > this.boundaries.xMax ||
            parseFloat(this.geometryFilter.yMax) > this.boundaries.yMax ||
            parseFloat(this.geometryFilter.zMax) > this.boundaries.zMax
        } else {
          this._filtersDisabled = true;
        }
      }

      resetFilters() {
        this.geometryFilter = _.cloneDeep(this.boundaries);
        this.checkValidInput();
        this._aggregations(this._modelData, this.selectedContourBy, this.selectedView, this.selectedElementType);
        //reset filter selection to the model boundaries
        //console.log(this.geometryFilter)
        //console.log(this.boundaries)
      }

      applyFilters() {
        //so user input on Model Filters adjusts the data that corresponds to it
        this.geometryFilter = {
          'xMin': parseFloat(this.geometryFilter.xMin),
          'xMax': parseFloat(this.geometryFilter.xMax),
          'yMin': parseFloat(this.geometryFilter.yMin),
          'yMax': parseFloat(this.geometryFilter.yMax),
          'zMin': parseFloat(this.geometryFilter.zMin),
          'zMax': parseFloat(this.geometryFilter.zMax)
        }
        this._aggregations(this._modelData, this.selectedContourBy, this.selectedView, this.selectedElementType);
      }

      todaysDate() {
        var d = new Date();
        var curr_date = (d.getDate() <= 9 ? '0': '') + (d.getDate())
        var curr_month = (d.getMonth() <= 9 ? '0': '') + (d.getMonth()+1)
        var curr_year = d.getFullYear();
        return curr_year + "-" + curr_month + "-" + curr_date
      }

      _initData(dataOptions_) {
        //this.set('dataOptions', dataOptions_)
        //sort by date
        this.set('dataOptions', _.orderBy(dataOptions_, [function(o) { return o.s3_attributes.uploadTime; }], ['desc']));
        if (this.dataOptions.length > 0) {
          var link_ = window.location.hash.replace("#","");
          var linkIndex = -1;
          if (link_ !== "") {
            linkIndex = _.findIndex(this.dataOptions, function(o) {return o.model === link_})
            if (linkIndex === -1) {
              this.$.linkFailToast.show({ text: "Couldn't find linked model" });
            }
            history.replaceState('', document.title, window.location.pathname);
          }
          if (linkIndex >= 0) {
            this.set('selectedModel', this.dataOptions[linkIndex].model)
          }
          else {
            this.set('selectedModel', this.dataOptions[0].model)
          }
        }
        this.processSearchOptions();
      }

      clearAllFilters() {
        if (this.userSearchInput !== undefined) {
          this.filterSelectedUser = undefined,
          this.filterSelectedProject = undefined,
          this.filterSelectedOffice = undefined,
          Polymer.dom(this.root).querySelector("#from-upload-date").value = undefined,
          Polymer.dom(this.root).querySelector("#to-upload-date").value = undefined,
          Polymer.dom(this.root).querySelector("#from-model-version-date").value = undefined,
          Polymer.dom(this.root).querySelector("#to-model-version-date").value = undefined
          this.setSearchFilters();
          // render searchOptions already exists within setSearchFilters()
          // this.$.searchOptions.render();
          this.$.filterIcon.style.color = '';
        }
      }

      cancelFilterInput() {
        // removes user input from search filters modal only if no filters are currently applied
        if (this.userSearchInput === undefined) {
          this.filterSelectedUser = undefined,
          this.filterSelectedProject = undefined,
          this.filterSelectedOffice = undefined,
          Polymer.dom(this.root).querySelector("#from-upload-date").value = undefined,
          Polymer.dom(this.root).querySelector("#to-upload-date").value = undefined
          Polymer.dom(this.root).querySelector("#from-model-version-date").value = undefined,
          Polymer.dom(this.root).querySelector("#to-model-version-date").value = undefined
        } else {
          //if filters applied keep user's input
          this.filterSelectedUser = this.userSearchInput.user,
          this.filterSelectedProject = this.userSearchInput.project,
          this.filterSelectedOffice = this.userSearchInput.office,
          Polymer.dom(this.root).querySelector("#from-upload-date").value = this.userSearchInput.minUploadDate,
          Polymer.dom(this.root).querySelector("#to-upload-date").value = this.userSearchInput.maxUploadDate
          Polymer.dom(this.root).querySelector("#from-model-version-date").value = this.userSearchInput.minModelVersionDate,
          Polymer.dom(this.root).querySelector("#to-model-version-date").value = this.userSearchInput.maxModelVersionDate
        }
      }

      processSearchOptions() {
        // displays available options to search from according to already uploaded models
        // console.log(this.dataOptions);
        //create a set of all the different options
        this.searchOptionsMap = {
          'user': [],
          'project': _.concat([], "non-tagged"),
          'office': [],
          'minUploadDate': "",
          'maxUploadDate': "",
          'minModelVersionDate': "",
          'maxModelVersionDate': ""
        };
        for (var i=0; i < this.dataOptions.length; i++) {
          var item = this.dataOptions[i]
          // if model has no user/has a user that is not already in the searchOptions map, add them to it
          if (typeof item.s3_attributes.user !== 'undefined' && this.searchOptionsMap.user.indexOf(item.s3_attributes.user) === -1) {
            this.searchOptionsMap.user.push(item.s3_attributes.user)
          }
          // if model has no project/has a project that is not already in the searchOptions map, add it
          if (typeof item.s3_attributes.project !== 'undefined' && this.searchOptionsMap.project.indexOf(item.s3_attributes.project) === -1) {
            this.searchOptionsMap.project.push(item.s3_attributes.project)
          }
          // if model has no office/has a office that is not already in the searchOptions map, add it
          if (typeof item.s3_attributes.office !== 'undefined' && this.searchOptionsMap.office.indexOf(item.s3_attributes.office) === -1) {
            this.searchOptionsMap.office.push(item.s3_attributes.office)
          }
          // if model has no minUploadDate/uploadTime is not less than the minDate, set it
          if (_.isEmpty(this.searchOptionsMap.minUploadDate) || new Date(this.searchOptionsMap.minUploadDate) > new Date(item.s3_attributes.uploadTime.split(" ")[0])) {
            this.set('searchOptionsMap.minUploadDate', item.s3_attributes.uploadTime.split(" ")[0]);
          }
          // if model has no maxUploadDate/uploadTime is not greater than the minDate, set it
          if (_.isEmpty(this.searchOptionsMap.maxUploadDate) || new Date(this.searchOptionsMap.maxUploadDate) < new Date(item.s3_attributes.uploadTime.split(" ")[0])) {
            this.set('searchOptionsMap.maxUploadDate', item.s3_attributes.uploadTime.split(" ")[0]);
          }
          /////
         // if model has no minModelVersionDate/VersionDate is not less than the minDate, set it
         if (!_.isEmpty(item.s3_attributes.VersionDate)) {
           if (_.isEmpty(this.searchOptionsMap.minModelVersionDate) || new Date(this.searchOptionsMap.minModelVersionDate) > new Date(item.s3_attributes.VersionDate.split(" ")[0])) {
             this.set('searchOptionsMap.minModelVersionDate', item.s3_attributes.VersionDate.split(" ")[0]);
           }
           // if model has no maxModelVersionDate/VersionDate is not greater than the minDate, set it
           if (_.isEmpty(this.searchOptionsMap.maxModelVersionDate) || new Date(this.searchOptionsMap.maxModelVersionDate) < new Date(item.s3_attributes.VersionDate.split(" ")[0])) {
             this.set('searchOptionsMap.maxModelVersionDate', item.s3_attributes.VersionDate.split(" ")[0]);
           }
         }
         //////
        }
        //to set min value for vaadin-date-picker
        this.minUploadFromDate = this.searchOptionsMap.minUploadDate
        this.minModelVersionFromDate = this.searchOptionsMap.minModelVersionDate
        // console.log("available options: ");
        // console.log(this.searchOptionsMap)
      }

      setSearchFilters() {
        //if user didn't select a minUploadDate, assign the date of the first possible model
        if (_.isEmpty(Polymer.dom(this.root).querySelector("#from-upload-date").value)) {
          var minUploadDate = this.searchOptionsMap.minUploadDate;
        } else {
          var minUploadDate = Polymer.dom(this.root).querySelector("#from-upload-date").value;
        }
        //if user didn't select a maxUploadDate, assign the date of the latest possible model
        if (_.isEmpty(Polymer.dom(this.root).querySelector("#to-upload-date").value)) {
          var maxUploadDate = this.searchOptionsMap.maxUploadDate
        } else {
          var maxUploadDate = Polymer.dom(this.root).querySelector("#to-upload-date").value
        }
        ///////////////
       //if user didn't select a minModelVersionDate, assign the date of the first possible model
       if (_.isEmpty(Polymer.dom(this.root).querySelector("#from-model-version-date").value)) {
         var minModelVersionDate = this.searchOptionsMap.minModelVersionDate;
       } else {
         var minModelVersionDate = Polymer.dom(this.root).querySelector("#from-model-version-date").value;
       }
       //if user didn't select a maxModelVersionDate, assign the date of the latest possible model
       if (_.isEmpty(Polymer.dom(this.root).querySelector("#to-model-version-date").value)) {
         var maxModelVersionDate = this.searchOptionsMap.maxModelVersionDate
       } else {
         var maxModelVersionDate = Polymer.dom(this.root).querySelector("#to-model-version-date").value
       }
       //////////
        this.userSearchInput = {
          'user': this.filterSelectedUser,
          'project': this.filterSelectedProject,
          'office': this.filterSelectedOffice,
          'minUploadDate': minUploadDate,
          'maxUploadDate': maxUploadDate,
          'minModelVersionDate': minModelVersionDate,
          'maxModelVersionDate': maxModelVersionDate
        }
        // console.log("search input: ");
        // console.log(this.userSearchInput);
        this.$.searchFilterModal.close()
        this.$.searchOptions.render();
        var that = this
        setTimeout(function() {
          //to display only the models that meet the requierments of the user's search
          that.includedModels = _.map(that.$['model-options'].items, function(o) {return o.name})
          // console.log(that.includedModels);
          if (that.includedModels.length === 0) {
            //if user input renders no results, remove search filters
            that.clearAllFilters();
            var toast = Polymer.dom(that.root).querySelector('#searchResultMsg')
            toast.show({ text: "No search results; filters removed" })
          } else {
            // console.log(that.$.searchOptions.filter);
            // if selectedModel does not meet requirements of user search input, assign the first search result to selectedModel
            if (!_.includes(that.includedModels, that.selectedModel)) {
              for (var m = 0; m < that.includedModels.length; m++) {
                //these are all the available Models
                // console.log(includedModels[m])
                that.set('selectedModel',that. includedModels[0])
              }
            }
          }
          // console.log(that.selectedModel);
        }, 0)
      }

      applySearchFilters(item) {
        // applies user's search input to return models that meet filters
        if (typeof this.userSearchInput === 'undefined') {
          this.$.filterIcon.style.color = '';
          return true
        }
        var uploadTimeDate = new Date(item.s3_attributes.uploadTime.split(" ")[0])
        if (item.s3_attributes.VersionDate !== undefined) { var modelVersionDateTime = new Date(item.s3_attributes.VersionDate.split(" ")[0]) }
        var userSearchInputMinUploadDate = new Date(this.userSearchInput.minUploadDate)
        var userSearchInputMaxUploadDate = new Date(this.userSearchInput.maxUploadDate)
        var userSearchInputMinModelVersionDate = new Date(this.userSearchInput.minModelVersionDate)
        var userSearchInputMaxModelVersionDate = new Date(this.userSearchInput.maxModelVersionDate)
        var result = true;
        // if (this.userSearchInput.user === undefined && this.userSearchInput.project === undefined && this.userSearchInput.office === undefined
        //   && this.userSearchInput.minUploadDate === this.searchOptionsMap.minUploadDate && this.userSearchInput.maxUploadDate === this.searchOptionsMap.maxUploadDate
        //   && this.userSearchInput.minModelVersionDate === this.searchOptionsMap.minModelVersionDate && this.userSearchInput.maxModelVersionDate === this.searchOptionsMap.maxModelVersionDate) {
        //   // if all of user's input is blank, keep the default color of the filter icon, whenever filter is activated (other if statements) filter icon will turn green
        //   this.$.filterIcon.style.color = '';
        // }
        // using multiple if statements because all of these conditions must be met
        if (typeof this.userSearchInput.user !== 'undefined') {
          this.$.filterIcon.style.color = '#4CAF50';
          result = item.s3_attributes.user === this.userSearchInput.user
          if (!result) {return result}
        }
        if (typeof this.userSearchInput.office !== 'undefined') {
          this.$.filterIcon.style.color = '#4CAF50';
          result = item.s3_attributes.office === this.userSearchInput.office
          if (!result) {return result}
        }
        if (this.userSearchInput.minUploadDate !== this.searchOptionsMap.minUploadDate || this.userSearchInput.maxUploadDate !== this.searchOptionsMap.maxUploadDate) {
          this.$.filterIcon.style.color = '#4CAF50';
          result = uploadTimeDate >= userSearchInputMinUploadDate && uploadTimeDate <= userSearchInputMaxUploadDate
          if (!result) {return result}
        }
        //////////////
        if (this.userSearchInput.minModelVersionDate !== this.searchOptionsMap.minModelVersionDate || this.userSearchInput.maxModelVersionDate !== this.searchOptionsMap.maxModelVersionDate) {
          this.$.filterIcon.style.color = '#4CAF50';
          result = modelVersionDateTime >= userSearchInputMinModelVersionDate && modelVersionDateTime <= userSearchInputMaxModelVersionDate
          if (!result) {return result}
        }
        //////////////
        if (this.userSearchInput.project === 'non-tagged') {
          this.$.filterIcon.style.color = '#4CAF50';
          result = item.s3_attributes.project === undefined
          if (!result) {return result}
        }
        if (typeof this.userSearchInput.project !== 'undefined' && this.userSearchInput.project !== 'non-tagged') {
          this.$.filterIcon.style.color = '#4CAF50';
          result = item.s3_attributes.project === this.userSearchInput.project
          if (!result) {return result}
        }
        console.log(item);
        //each if statement above checks to see if condition is met (true using result); if a model fails on the previous/any of the input conditions: doesn't return the model at all
        return result;
        }

      clearSearchField(e) {
        if (e.path[2].id === 'clearFilterUser') {
          this.filterSelectedUser = undefined
        } if (e.path[2].id === 'clearFilterProject') {
          this.filterSelectedProject = undefined
        } if (e.path[2].id === 'clearFilterOffice') {
          this.filterSelectedOffice = undefined
        }
      }

      handleOptionsResponse(event, response) {
        this.getModelsResp = response.response
        if (this.getModelsResp) {
          this.appLoading = false
          this._initData(this.getModelsResp);
        } else {
            this.handleOptionsError();
          }
      }

      handleOptionsError(event, response) {
        this.appLoading = false;
        this._initData([]);
        alert("Couldn't fetch data.  Please check your internet connection");
      }

      handleDataResponse(event, response) {
        this.currentModelResp = response.response
        console.log(this.currentModelResp);
        var costTab = Polymer.dom(this.root).querySelector("#cost-tab")
        if (costTab.disabled && this.selectedView === 'cost-view') {
          this.selectedView = 'model-view'
        }
        if (this.currentModelResp && this.currentModelResp.modelInformation.name === this.selectedModel && "payload" in this.currentModelResp) {
          this.appLoading = false;
          this.set('_modelData', {
            'linearElements': this.currentModelResp.payload.linearElements,
            'planarElements': this.currentModelResp.payload.planarElements
          });
          this.selectedElementType = _.isEmpty(this._modelData.linearElements) ? 'planar-view' : 'linear-view'
          //set selectedSumField to undefined in order to trigger stringAggregtions initialization
          this.selectedSumField = undefined
        } else {
          this.handleDataError()
        }
      }

      handleDataError(event, response) {
        this.appLoading = false;
        alert("couldn't retrieve " + this.selectedModel)
      }

      _getModelData(_selectedModel) {
        this.viewData = {
             "linearElements": [],
             "planarElements": []
        }
        this.$['model-request'].url = this.baseUrl + "get-model-data/" + this.selectedModel
        this.$['model-request'].generateRequest();
        this.appLoading = true;
      }

      showDialog() {
        this.$.addModelDialog.open();
      }

      showFilterModal() {
        this.$.searchFilterModal.open();
      }

      handleUploadResponse(event, response) {
        // var resp = response.response;
        // // console.log(resp);
        // if ("success" in resp) {
        //   this.$['get-models-request'].generateRequest();
        //   this.selectedModel = this.fullFileNameNoExtension
        //   window.location.href = window.location.pathname + '#' + this.fullFileNameNoExtension
        // //   // this.$.pollingStatusToast.show({ text: "Upload successful!"})
        // }
        // else {
        //   if ("error" in resp) {
        //     this.$.validationToast.show({ text: resp["Error"]})
        //   }
        //   else {
        //     this.$.validationToast.show({ text: "An error occurred"})
        //   }
        // }
      }
    }

    window.customElements.define(ThreePolymerWireframe.is, ThreePolymerWireframe);
  </script>
</dom-module>

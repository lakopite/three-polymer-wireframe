@license
<!--
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/three-polymer/three-view/three-view.html">
<link rel="import" href="../bower_components/three-polymer/three-model/three-model.html">
<link rel="import" href="my-icons.html">

<dom-module id="three-polymer-wireframe-app">
  <template>
    <style>
      :host {
        --app-primary-color: #4285f4;
        --app-secondary-color: black;

        display: block;
      }

      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }

      app-header {
        color: #fff;
        background-color: var(--app-primary-color);
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      .drawer-list {
        margin: 0 20px;
      }

      .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }

      .three-container {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        height: 100%;
      }

      #view {
        @apply(--layout-self-center);
        @apply(--shadow-elevation-2dp);
      }

      #filter-container {
        margin-top: 60px;
      }

      .horizontal {
        @apply(--layout-horizontal);
      }

      .inline-input {
        padding: 0.1em;
        @apply(--layout-flex);
      }

      .dropdown-item {
        cursor: pointer;
      }

      paper-button.filterBtn {
        background: var(--app-primary-color);
        color: #FFF;
      }

      paper-button[disabled] {
        background: #eaeaea;
        color: #a8a8a8;
      }

      paper-dialog#addModelDialog {
        padding: 1em;
      }

      paper-spinner {
        --paper-spinner-layer-1-color: #FFF;
        --paper-spinner-layer-2-color: #FFF;
        --paper-spinner-layer-3-color: #FFF;
        --paper-spinner-layer-4-color: #FFF;
      }
    </style>
    <iron-ajax auto url="/data/test_response.json" handle-as="json" on-response="handleResponse" on-error="handleError"></iron-ajax>
    <paper-dialog modal id="addModelDialog">
      <h2>Add a Model</h2>
      <paper-input label="JSON file" type="file"></paper-input>
      <paper-input label="meta val" type="text"></paper-input>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Accept</paper-button>
      </div>
    </paper-dialog>
    <app-drawer-layout fullbleed>
      <!-- Drawer content -->
      <app-drawer id="drawer" slot="drawer">
        <app-toolbar>
          <paper-item>Model Options</paper-item>
        </app-toolbar>
        <div class="drawer-list">
          <paper-dropdown-menu label="Model">
            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedModel}}">
              <template is="dom-repeat" items="[[data]]">
                <paper-item class="dropdown-item" name="{{item.id}}">{{item.id}}</paper-item>
              </template>
  </paper-listbox>
  </paper-dropdown-menu>
  <paper-dropdown-menu label="Contour">
    <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
      <template is="dom-repeat" items="[[metadataFields]]">
                <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
              </template>
    </paper-listbox>
  </paper-dropdown-menu>
  <div id="filter-container">
    <paper-item>Model Filters</paper-item>
    <div class="horizontal">
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min x" class="inline-input" type="number" value="{{geometryFilter.xMin}}" max="[[_computeMax(boundaries.xMax,geometryFilter.xMax)]]" min="[[boundaries.xMin]]"></paper-input>
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max x" class="inline-input" type="number" value="{{geometryFilter.xMax}}" max="[[boundaries.xMax]]" min="[[_computeMin(boundaries.xMin,geometryFilter.xMin)]]"></paper-input>
    </div>
    <div class="horizontal">
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min y" class="inline-input" type="number" value="{{geometryFilter.yMin}}" max="[[_computeMax(boundaries.yMax,geometryFilter.yMax)]]" min="[[boundaries.yMin]]"></paper-input>
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max y" class="inline-input" type="number" value="{{geometryFilter.yMax}}" max="[[boundaries.yMax]]" min="[[_computeMin(boundaries.yMin,geometryFilter.yMin)]]"></paper-input>
    </div>
    <div class="horizontal">
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min z" class="inline-input" type="number" value="{{geometryFilter.zMin}}" max="[[_computeMax(boundaries.zMax,geometryFilter.zMax)]]" min="[[boundaries.zMin]]"></paper-input>
      <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max z" class="inline-input" type="number" value="{{geometryFilter.zMax}}" max="[[boundaries.zMax]]" min="[[_computeMin(boundaries.zMin,geometryFilter.zMin)]]"></paper-input>
    </div>
    <div class="horizontal">
      <paper-button class="filterBtn" raised disabled$="{{_filtersDisabled}}" id="applyBtn" on-tap="applyFilters">Apply</paper-button>
      <paper-button class="filterBtn" raised disabled$="{{modelLoading}}" id="resetBtn" on-tap="resetFilters">Reset</paper-button>
    </div>
  </div>
  <div id="aggegation-container">
    <paper-item>Aggregations</paper-item>
    <paper-input readonly label="average" value="[[meanResult]]"></paper-input>
    <paper-input readonly label="minimum value" value="[[minResult]]"></paper-input>
    <paper-input readonly label="maximum value" value="[[maxResult]]"></paper-input>
  </div>
  </div>
  </app-drawer>

  <!-- Main content -->
  <app-header-layout has-scrolling-region>

    <app-header slot="header" condenses reveals effects="waterfall">
      <app-toolbar>
        <paper-icon-button icon="my-icons:menu" drawer-toggle></paper-icon-button>
        <div main-title>Arup Model QuickView</div>
        <div class="spacer"></div>
        <paper-spinner active$="{{modelLoading}}"></paper-spinner>
        <paper-icon-button on-tap="showDialog" icon="my-icons:add"></paper-icon-button>
      </app-toolbar>
    </app-header>
    <div class="three-container">
      <three-view id="view" scene-background-color="#F5F5F5">
        <three-model id="model" slot="model" metadata-fields="{{metadataFields}}" is-loading="{{modelLoading}}" contour-by="[[selectedContourBy]]" boundaries="{{boundaries}}" geometry-filter="{{geometryFilter}}" data="[[_modelData]]">
        </three-model>
      </three-view>
    </div>
  </app-header-layout>
  </app-drawer-layout>
  </template>

  <script>
    class ThreePolymerWireframe extends Polymer.Element {

      static get is() {
        return 'three-polymer-wireframe-app';
      }

      static get properties() {
        return {
          selectedModel: {
            type: String
          },
          selectedContourBy: {
            type: String,
            value: "flexure"
          },
          boundaries: {
            type: Object
          },
          geometryFilter: {
            type: Object
          },
          data: {
            type: Array,
            value: []
          },
          _filtersDisabled: {
            type: Boolean,
            value: false
          },
          _modelData: {
            type: Array,
            value: []
          },
          modelLoading: {
            type: Boolean
          },
          metadataFields: {
            type: Array,
            value: []
          },
          meanResult: {
            type: Number,
            value: 0
          },
          minResult: {
            type: Number,
            value: 0
          },
          maxResult: {
            type: Number,
            value: 0
          }
        };
      }

      static get observers() {
        return [
          '_boundariesChanged(boundaries.*)',
          '_loadingChanged(modelLoading)',
          '_contourPropsChanged(metadataFields)',
          '_getModelData(selectedModel)',
          '_aggregations(_modelData,selectedContourBy)'
        ]
      }

      constructor() {
        super();
      }

      _aggregations(_modelData, selectedContourBy) {

        if (!_.isEmpty(_modelData) && this.selectedContourBy) {
          var that = this;

          this.meanResult = _.meanBy(_.filter(that._modelData, function(i) {}), function(o) {
            return o.metadata[that.selectedContourBy]
          });
          //min
          this.minResult = _.minBy(_modelData, function(o) {
            // console.log(that.selectedContourBy)
            return o.metadata[that.selectedContourBy]
          }).metadata[this.selectedContourBy];
          // console.log("The minimum value is: " + minResult.metadata[this.selectedContourBy])
          //max
          this.maxResult = _.maxBy(that._modelData, function(o) {
            // console.log(that.selectedContourBy)
            return o.metadata[that.selectedContourBy]
          }).metadata[this.selectedContourBy];
          // console.log("The maximum value is: " + maxResult.metadata[this.selectedContourBy])
        } else {
          this.meanResult = 0
          this.minResult = 0
          this.maxResult = 0
          // console.log("no mean could be calculated")
        }
      }

      //Ensure that the geometry input is within boundaries and is compatible with its input sibling
      _computeMin(_b, _g) {
        _g = parseFloat(_g)
        if (_.isNumber(_g)) {
          return (_g > _b) ? _g : _b
        }
        return _b
      }

      _computeMax(_b, _g) {
        _g = parseFloat(_g)
        if (_.isNumber(_g)) {
          return (_g < _b) ? _g : _b
        }
        return _b
      }

      _boundariesChanged(boundaries) {
        this.resetFilters();
        //console.log(this.boundaries)
      }

      _loadingChanged(modelLoading) {
        //console.log(modelLoading)
        this.checkValidInput();
      }

      _contourPropsChanged(metadataFields) {
        if (this.metadataFields.indexOf(this.selectedContourBy) === -1) {
          this.selectedContourBy = undefined;
          if (this.metadataFields.length > 0) {
            var that = this;
            setTimeout(function() {
              that.selectedContourBy = that.metadataFields[0];
            }, 0);
          }
        }
      }

      checkValidInput() {
        //console.log(this.geometryFilter)
        if (!_.isEmpty(this.geometryFilter) && !_.isEmpty(this.boundaries) && !this.modelLoading && _.every(_.values(this.geometryFilter), function(o) {
            return o !== ""
          })) {
          this._filtersDisabled =
            parseFloat(this.geometryFilter.xMin) < this.boundaries.xMin || parseFloat(this.geometryFilter.xMin) > this.geometryFilter.xMax ||
            parseFloat(this.geometryFilter.yMin) < this.boundaries.yMin || parseFloat(this.geometryFilter.yMin) > this.geometryFilter.yMax ||
            parseFloat(this.geometryFilter.zMin) < this.boundaries.zMin || parseFloat(this.geometryFilter.zMin) > this.geometryFilter.zMax ||
            parseFloat(this.geometryFilter.xMax) > this.boundaries.xMax ||
            parseFloat(this.geometryFilter.yMax) > this.boundaries.yMax ||
            parseFloat(this.geometryFilter.zMax) > this.boundaries.zMax
        } else {
          this._filtersDisabled = true;
        }
      }

      resetFilters() {
        this.geometryFilter = _.cloneDeep(this.boundaries);
        this.checkValidInput();
        //reset filter selection to the model boundaries
        //console.log(this.geometryFilter)
        //console.log(this.boundaries)
      }

      applyFilters() {
        //this clone below works, but it turns values into strings. must parseFloat *values*. -rsc
        // this.geometryFilter = _.cloneDeep(this.geometryFilter)
        //parse filter selection and pass the range to three-model
        // if (this.geometryFilter.xMin >= this.boundaries.xMin &&
        //   this.geometryFilter.yMin >= this.boundaries.yMin &&
        //   this.geometryFilter.zMin >= this.boundaries.zMin &&
        //   this.geometryFilter.xMax <= this.boundaries.xMax &&
        //   this.geometryFilter.yMax <= this.boundaries.yMax &&
        //   this.geometryFilter.zMax <= this.boundaries.zMax) {

        this.geometryFilter = {
          'xMin': parseFloat(this.geometryFilter.xMin),
          'xMax': parseFloat(this.geometryFilter.xMax),
          'yMin': parseFloat(this.geometryFilter.yMin),
          'yMax': parseFloat(this.geometryFilter.yMax),
          'zMin': parseFloat(this.geometryFilter.zMin),
          'zMax': parseFloat(this.geometryFilter.zMax)
        }
        //console.log(this.geometryFilter)
        //console.log(this.boundaries)
        //}
      }

      _initData(data_) {
        this.set('data', data_);
        console.log(this.data)
        if (this.data.length > 0) {
          this.set('selectedModel', this.data[0].id)
        }
      }

      handleResponse(event, response) {
        var resp = response.response;
        if (resp) {
          this._initData(resp);
          //this.handleError();
        } else {
          this.handleError();
        }
      }

      handleError(event, response) {
        this._initData([{
          "id": "Model A",
          "payload": [{
            "vertices": [
              [-10, 0, -10],
              [-10, 0, 10]
            ],
            "metadata": {
              "axial": 10,
              "flexure": 40
            }
          }, {
            "vertices": [
              [-10, 0, 10],
              [10, 0, 10]
            ],
            "metadata": {
              "axial": 40,
              "flexure": 55
            }
          }, {
            "vertices": [
              [10, 0, 10],
              [10, 0, -10]
            ],
            "metadata": {
              "axial": 100,
              "flexure": 20
            }
          }]
        }, {
          "id": "Model B",
          "payload": [{
            "vertices": [
              [-10, 0, -10],
              [-10, 0, 10]
            ],
            "metadata": {
              "axial": 40,
              "flexure": 20
            }
          }, {
            "vertices": [
              [-10, 0, 10],
              [10, 0, 10]
            ],
            "metadata": {
              "axial": 10,
              "flexure": 55
            }
          }, {
            "vertices": [
              [10, 0, 10],
              [10, 0, 30]
            ],
            "metadata": {
              "axial": 100,
              "flexure": 40
            }
          }]
        }, {
          "id": "Model C",
          "payload": [{
            "vertices": [
              [-10, 0, 30],
              [-10, 0, 10]
            ],
            "metadata": {
              "axial": 100,
              "flexure": 55
            }
          }, {
            "vertices": [
              [-10, 0, 10],
              [10, 0, 10]
            ],
            "metadata": {
              "axial": 40,
              "flexure": 20
            }
          }, {
            "vertices": [
              [10, 0, 10],
              [10, 0, -10]
            ],
            "metadata": {
              "axial": 10,
              "flexure": 40
            }
          }]
        }])
        alert("Couldn't fetch sample data, using three stick models.")
      }

      _getModelData(_selectedModel) {
        var result = _.find(this.data, function(o) {
          return o.id === _selectedModel
        });
        if (result) {
          this._modelData = result.payload;
        } else {
          this.modelData = [];
        }
      }

      showDialog() {
        this.$.addModelDialog.open();
      }
    }

    window.customElements.define(ThreePolymerWireframe.is, ThreePolymerWireframe);
  </script>
</dom-module>

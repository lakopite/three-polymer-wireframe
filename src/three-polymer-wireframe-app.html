@license
<!--
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../bower_components/three-polymer/three-view/three-view.html">
<link rel="import" href="../bower_components/three-polymer/three-model/three-model.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">

<dom-module id="three-polymer-wireframe-app">
  <template>
    <style>
      :host {
        --app-primary-color: #4285f4;
        --app-secondary-color: black;

        display: block;
      }

      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }

      app-header {
        color: #fff;
        background-color: var(--app-primary-color);
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      .drawer-list {
        margin: 0 20px;
      }

      .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }

      .three-container {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        height: 100%;
      }

      #view {
        @apply(--layout-self-center);
        @apply(--shadow-elevation-2dp);
      }

      #filter-container {
        margin-top: 60px;
      }

      .horizontal {
        @apply(--layout-horizontal);
      }

      .inline-input {
        padding: 0.1em;
        @apply(--layout-flex);
      }

      .dropdown-item {
        cursor: pointer;
      }

      #uploaded-by {
        font-size: .9em;
        color: #3F51B5;
        padding: 0;
      }

      #model-dropdown {
        /*font-size: .75em;*/
      }

      paper-button.filterBtn {
        background: var(--app-primary-color);
        color: #FFF;
      }

      paper-button[disabled] {
        background: #eaeaea;
        color: #a8a8a8;
      }

      paper-dialog#addModelDialog {
        padding: 1em;
      }

      paper-spinner {
        --paper-spinner-layer-1-color: #FFF;
        --paper-spinner-layer-2-color: #FFF;
        --paper-spinner-layer-3-color: #FFF;
        --paper-spinner-layer-4-color: #FFF;
      }

      #sum-field-dropdown {
        --paper-input-container-label: {
          font-size:20px;
        }
      }

      .numerical-aggregations-table {
        height: calc(100vh - 192px);
      }

      .data-by-group-table, .numerical-aggregations-table, .cost-by-group-table {
        --vaadin-grid-body-row-odd-cell: {
          background-color: #f5f5f5;
        };
      }

      .num-wrapper {
        background-color: var(--paper-grey-300);
        display: grid;
        grid-template-columns: 1fr 1fr;
      }

      .str-header {
        background-color: var(--paper-grey-300);
        display: grid;
        grid-template-columns: 1fr 1fr 2fr;
      }

      #num-contour-dropdown, #str-contour-dropdown {
        padding: 0 0.5em;
          --paper-input-container-label: {
            font-size:20px;
          }
      }

      #wrap-str-info {
        @apply(--layout-vertical);
        overflow-x:hidden;
        height: calc(100vh - 192px);
        /*overflow-y: hidden;*/
      }

      #wrap-cost-info {
        /*height: calc(100vh - 192px);*/
        /*overflow-y: hidden;*/
      }

      #sum-chart-container {
        height: 398px;
      }

      .cost-by-group-table {
        height: 630px;
      }

      #cost-chart-container {
        height: 398px;
      }

      #csv-button {
        margin: 60px 0 0 0;
        background: var(--app-primary-color);
        color: #FFF;
      }

      #validationToast {
        padding: 1em 1em;
        border: 1px solid gray;
      }

      .yellow-toast {
        text-transform: none;
        color: #eeff41;
      }

      #cost-tab[disabled] {
        color: #9E9E9E;
      }

      #apply-all-div {
        display: inline-block;
      }

      .secondary-item {
        font-size: .7em;
        color: grey;
      }

    </style>
    <iron-ajax headers="{{authHeaders}}" id="get-models-request" method="GET" url="[[baseUrl]]get-models" handle-as="json" on-response="handleOptionsResponse" on-error="handleOptionsError"></iron-ajax>
    <iron-ajax headers="{{authHeaders}}" id="model-request" method="GET" handle-as="json" on-response="handleDataResponse" on-error="handleDataError"></iron-ajax>
    <iron-ajax headers="{{authHeaders}}" id="json-upload-request" method="POST" content-type="application/json" body='[[jsonUploadPayload]]' on-response="handleUploadResponse" url="[[baseUrl]]post-model"></iron-ajax>
    <!-- ?\<iron-ajax headers="{{authHeaders}}" id="remove-upload-request" method="DELETE" content-type="application/json" on-response="handleModelRemoval" url="[[baseUrl]]delete-model"></iron-ajax> -->
    <paper-dialog modal id="addModelDialog">
      <h2>Add a Model</h2>
      <iron-input id="user-email" label="username" prevent-invalid-input allowed-pattern="([A-Za-z0-9\._-]+)" bind-value="{{userEmail}}" on-change="_checkEmailField">
        <input>@arup.com
      </iron-input>
      <iron-input>
      <input id="modelUpload" type="file" on-change="handleJsonUpload"></input>
      </iron-input>
      <div class="buttons">
        <paper-button dialog-dismiss on-tap="_clearUploadInput">Cancel</paper-button>
        <paper-button id="acceptUploadBtn" dialog-confirm autofocus disabled$="{{_acceptUploadDisabled}}" on-tap="uploadJsonModel">Upload</paper-button>
      </div>
    </paper-dialog>
    <paper-toast id="validationToast" duration="0" class="fit-bottom">
      <paper-button on-tap="reopenUploadBox" class="yellow-toast">Try Again</paper-button>
      <paper-button dialog-dismiss on-tap="closeToast" class="yellow-toast">Cancel</paper-button>
    </paper-toast>
    <paper-toast id="uploadSuccessToast" duration="3000"></paper-toast>
    <paper-toast id="linkFailToast" duration="3000"></paper-toast>
    <app-drawer-layout fullbleed>
    <!-- Drawer content -->
    <app-drawer id="drawer" slot="drawer">
    <div style="height: 100%; overflow: auto;">
    <app-toolbar>
      <paper-item>Model Options</paper-item>
    </app-toolbar>
    <div class="drawer-list">
      <!-- <paper-input id="search-input" label="Search Models..." value="{{searchInput}}"></paper-input> -->
      <paper-dropdown-menu label="Model">
        <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedModel}}">
          <!-- <paper-input id="search-input" label="Search Models..." value="{{searchInput}}" type="text" autofocus minlength="1"></paper-input> -->
          <!-- REMOVED FROM TEMPLATE BELOW: selected="" filter="{{searchFilter(searchInput)}}"-->
          <template is="dom-repeat" items="[[dataOptions]]">
            <paper-item id="model-dropdown" class="dropdown-item" name="[[item.model]]">
            <paper-item-body two-line>
              <div class="primary-item">[[_formatModelName(item.model)]]</div>
              <div secondary class="secondary-item">[[_formatModelTimeStamp(item.model)]]</div>
            </paper-item-body>
          </paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>
      <paper-button hidden$="{{_hideShareBtn(selectedModel)}}" id="share-model" class="filterBtn" on-tap="_shareModelEmail">Share via Email</paper-button>
      <paper-item id="uploaded-by" label="Uploaded by"><p>Uploaded by: {{_uploadedBy(currentModelResp.modelInformation.user)}}<br/>at [[currentModelResp.modelInformation.s3_attributes.uploadTime]]</p></paper-item>
      <div hidden$="{{_hideMainDropdown(selectedView)}}">
        <paper-dropdown-menu id="main-contour-dropdown" label="Select Contour">
          <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
            <template is="dom-repeat" items="{{metadataFields}}">
              <paper-item class="dropdown-item" name="{{item}}">{{_dropdownUnitLabel(item)}}</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>
      <div id="filter-container">
        <paper-item>Model Filters</paper-item>
        <div class="horizontal">
          <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min x" class="inline-input" type="number" value="{{geometryFilter.xMin}}" max="[[_computeMax(boundaries.xMax,geometryFilter.xMax)]]" min="[[boundaries.xMin]]"></paper-input>
          <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max x" class="inline-input" type="number" value="{{geometryFilter.xMax}}" max="[[boundaries.xMax]]" min="[[_computeMin(boundaries.xMin,geometryFilter.xMin)]]"></paper-input>
        </div>
        <div class="horizontal">
          <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min y" class="inline-input" type="number" value="{{geometryFilter.yMin}}" max="[[_computeMax(boundaries.yMax,geometryFilter.yMax)]]" min="[[boundaries.yMin]]"></paper-input>
          <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max y" class="inline-input" type="number" value="{{geometryFilter.yMax}}" max="[[boundaries.yMax]]" min="[[_computeMin(boundaries.yMin,geometryFilter.yMin)]]"></paper-input>
        </div>
        <div class="horizontal">
          <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min z" class="inline-input" type="number" value="{{geometryFilter.zMin}}" max="[[_computeMax(boundaries.zMax,geometryFilter.zMax)]]" min="[[boundaries.zMin]]"></paper-input>
          <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max z" class="inline-input" type="number" value="{{geometryFilter.zMax}}" max="[[boundaries.zMax]]" min="[[_computeMin(boundaries.zMin,geometryFilter.zMin)]]"></paper-input>
        </div>
        <!-- for force filter -->
        <!-- <div hidden$="[[!showNumericalAggregations]]">
        <div class="horizontal">
        <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="min [[selectedContourBy]]" class="inline-input" type="number" value="[[minResult]]" min="#"></paper-input>
        <paper-input prevent-invalid-input allowed-pattern="[-.\d]" on-input="checkValidInput" label="max [[selectedContourBy]]" class="inline-input" type="number" value="[[maxResult]]" max="#"></paper-input>
        </div>
        </div> -->
        <!-- force filter end -->
        <div class="horizontal">
          <paper-button class="filterBtn" raised disabled$="{{_filtersDisabled}}" id="applyBtn" on-tap="applyFilters" type="number">Apply</paper-button>
          <paper-button class="filterBtn" raised disabled$="{{modelLoading}}" id="resetBtn" on-tap="resetFilters" type="number">Reset</paper-button>
        </div>
      </div>
      <!-- for numerical aggregations -->
      <div hidden$="{{_hideQuantCsvButton(selectedView)}}">
        <div class="csv-wrapper">
          <div hidden$="[[!showNumericalAggregations]]">
            <div class="csv-button">
              <paper-button id="csv-button" on-tap="createNumericalCsv">Export Table to CSV</paper-button>
            </div>
          </div>
        </div>
      </div>
      <!-- for string aggregations -->
      <div hidden$="{{_hideQuantCsvButton(selectedView)}}">
        <div class="csv-wrapper">
          <div hidden$="[[!showStringAggregations]]">
            <div class="csv-button">
              <paper-button id="csv-button" on-tap="createGroupDataCsv">Export Table to CSV</paper-button>
            </div>
          </div>
        </div>
      </div>
    <!-- </div>
    </div>
    </app-drawer> -->
      <!-- for cost aggregations -->
      <div hidden$="{{_hideCostCsvButton(selectedView)}}">
        <div class="csv-wrapper">
            <div class="csv-button">
              <paper-button id="csv-button" on-tap="createCostDataCsv">Export Table to CSV</paper-button>
            </div>
        </div>
      </div>
    </div>
    </div>
  </div>
  </div>
    </app-drawer>
  <!-- Main content -->
    <app-header-layout has-scrolling-region>
    <app-header slot="header" medium-tall>
      <app-toolbar>
        <paper-icon-button icon="my-icons:menu" drawer-toggle></paper-icon-button>
        <div main-title>Arup Model QuickView: [[selectedModel]]</div>
        <paper-item>Build Date: 11/06/17</paper-item>
        <div class="spacer"></div>
        <paper-spinner active$="{{isLoadingState(modelLoading,appLoading)}}"></paper-spinner>
        <paper-icon-button on-tap="showDialog" icon="my-icons:add"></paper-icon-button>
        <paper-menu-button horizontal-align="right">
          <paper-icon-button icon="my-icons:account-circle" slot="dropdown-trigger"></paper-icon-button>
          <paper-listbox slot="dropdown-content">
            <paper-item style="cursor:pointer;" on-tap="logout">Logout</paper-item>
          </paper-listbox>
        </paper-menu-button>
      </app-toolbar>
      <app-toolbar>
        <paper-tabs bottom-item attr-for-selected="name" selected="{{selectedView}}">
          <paper-tab name="model-view">Model</paper-tab>
          <paper-tab name="aggregations-view">Quantities</paper-tab>
          <paper-tab name="cost-view" id="cost-tab" disabled$="{{_disableCostTab(metadataFields, currentModelResp, geometryFilter)}}">Cost</paper-tab>
        </paper-tabs>
      </app-toolbar>
    </app-header>
    <iron-pages style="height:100%;" attr-for-selected="name" selected="{{selectedView}}">
    <div name="model-view" class="three-container">
      <three-view id="view" legend-position="top-left" scene-background-color="#F5F5F5">
        <three-model id="model" slot="model" metadata-fields="{{metadataFields}}" is-loading="{{modelLoading}}" contour-by="[[selectedContourBy]]" boundaries="{{boundaries}}" geometry-filter="{{geometryFilter}}" data="[[_modelData]]"></three-model>
      </three-view>
    </div>
    <!-- Quantities tab -->
      <!-- For numerical aggregations -->
    <div name="aggregations-view">
      <div hidden$="[[!showNumericalAggregations]]">
        <div class="num-wrapper">
          <app-toolbar class="aggregation-toolbar">
            <div main-title>Aggregations</div>
          </app-toolbar>
          <paper-dropdown-menu id="num-contour-dropdown" label="Select Contour">
            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
              <template is="dom-repeat" items="{{metadataFields}}">
                <paper-item class="dropdown-item" name="{{item}}">{{_dropdownUnitLabel(item)}}</paper-item>
              </template>
            </paper-listbox>
            </paper-dropdown-menu>
        </div>
        <!-- min/max/avg table -->
        <vaadin-grid class="numerical-aggregations-table" items="[[numericalAggregationsTableData]]">
          <vaadin-grid-column>
            <template class="header">Name</template>
            <template>[[item.name]] [[_quantUnitLabels(selectedContourBy)]]</template>
            <template class="footer">Grand Total: [[_prettify(totalResult)]] [[_quantUnitLabels(selectedContourBy)]]</template>
          </vaadin-grid-column>
          <vaadin-grid-column>
            <template class="header">Result</template>
            <template>[[_prettify(item.result)]]</template>
          </vaadin-grid-column>
        </vaadin-grid>
      </div>
      <!-- For string aggregations -->
      <div hidden$="[[!showStringAggregations]]">
        <div class="str-header">
          <app-toolbar class="aggregation-toolbar">
            <div main-title>Data by Group</div>
          </app-toolbar>
          <paper-dropdown-menu id="str-contour-dropdown" label="Select Contour">
            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedContourBy}}">
              <template is="dom-repeat" items="{{metadataFields}}">
                <paper-item class="dropdown-item" name="{{item}}">{{_dropdownUnitLabel(item)}}</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
          <paper-dropdown-menu class="aggregation-toolbar" id="sum-field-dropdown" label="Select Sum Field">
            <paper-listbox slot="dropdown-content" class="dropdown-content" attr-for-selected="name" selected="{{selectedSumField}}">
              <template is="dom-repeat" items="{{numericalMetadataKeys}}">
                <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
        </div>
        <!-- wrap all string aggregation info -->
        <div id="wrap-str-info">
          <!-- div holds pie chart -->
          <div id="sum-chart-container"></div>
          <!-- data by group table -->
          <div id="group-data-table-section">
          <vaadin-grid class="data-by-group-table" items="[[groupSumData]]">
            <vaadin-grid-column width="200px">
              <template class="header">
                <vaadin-grid-sorter path="group">group</vaadin-grid-sorter>
              </template>
              <template>[[item.group]]</template>
              <template class="footer">Grand Total</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="elemsPerGroup">elements/group</vaadin-grid-sorter>
              </template>
              <template>[[_prettify(item.elemsPerGroup)]]</template>
              <template class="footer">[[_prettify(totalElements)]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="sum">sum [[selectedSumField]] [[_quantUnitLabels(selectedSumField)]]</vaadin-grid-sorter>
              </template>
              <template>[[_prettify(item.sum)]]</template>
              <template class="footer">[[_prettify(grandTotalSum)]] [[_quantUnitLabels(selectedSumField)]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="otherUnitSum">sum [[selectedSumField]] [[strOtherUnitLabel]]</vaadin-grid-sorter>
              </template>
              <template>[[_prettify(item.otherUnitSum)]]</template>
              <template class="footer">[[_prettify(grandTotalOtherUnitSum)]] [[strOtherUnitLabel]]</template>
            </vaadin-grid-column>
            <!-- NUMERICAL AGGREGATIONS WITHIN STRING AGGREGATION TABLE-->
            <vaadin-grid-column>
              <template class="header">min [[selectedSumField]] [[_quantUnitLabels(selectedSumField)]]</template>
              <template>[[_prettify(item.min)]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">max [[selectedSumField]] [[_quantUnitLabels(selectedSumField)]]</template>
              <template>[[_prettify(item.max)]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
              <template class="header">avg [[selectedSumField]] [[_quantUnitLabels(selectedSumField)]]</template>
              <template>[[_prettify(item.avg)]]</template>
            </vaadin-grid-column>
          </vaadin-grid>
          </div>
        </div>
    </div>
  </div>
    <!-- Cost Tab -->
    <div name="cost-view">
      <div class="num-wrapper">
        <app-toolbar class="aggregation-toolbar">
          <div main-title>Cost of [[_capitalize(material)]] by Group</div>
        </app-toolbar>
        <paper-dropdown-menu id="cost-group" label="Select Group/Subgroup">
        <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{selectedCostGroup}}">
          <template is="dom-repeat" items="[[costGroups]]">
            <paper-item class="dropdown-item" name="{{item}}">{{item}}</paper-item>
          </template>
        </paper-listbox>
        </paper-dropdown-menu>
      </div>
      <div id="wrap-cost-info">
        <div id="cost-table-section">
        <!-- cost by group table -->
        <vaadin-grid class="cost-by-group-table" items="{{costTableData}}">
        <vaadin-grid-column width="200px">
          <template class="header">
            <vaadin-grid-sorter path="group">group</vaadin-grid-sorter>
          </template>
          <template>[[item.group]]</template>
          <template class="footer">Grand Total</template>
        </vaadin-grid-column>
        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="elemsPerGroup">elements/group</vaadin-grid-sorter>
          </template>
          <template>[[_prettify(item.elemsPerGroup)]]</template>
          <template class="footer">[[_prettify(costTotalElements)]]</template>
        </vaadin-grid-column>
          <vaadin-grid-column>
            <template class="header">
              <vaadin-grid-sorter path="sum">[[material]] sum [[_costUnitLabels(material, unitType)]]</vaadin-grid-sorter>
            </template>
            <template>[[_prettify(item.sum)]]</template>
            <template class="footer">[[_prettify(totalMaterialSum)]] [[_costUnitLabels(material, unitType)]]</template>
          </vaadin-grid-column>
          <vaadin-grid-column>
            <template class="header">
              <vaadin-grid-sorter path="otherUnitSum">[[material]] sum [[costOtherUnitLabel]]</vaadin-grid-sorter>
            </template>
            <template>[[_prettify(item.otherUnitSum)]]</template>
            <template class="footer">[[_prettify(totalMaterialSumDiffUnit)]] [[costOtherUnitLabel]]</template>
          </vaadin-grid-column>
          <vaadin-grid-column>
            <template class="header">Cost/[[costOtherUnitLabel]]<div id ="apply-all-div"><iron-input id="apply-all-input" prevent-invalid-input allowed-pattern="[.\d]" bind-value="{{applyToAll}}"><input></iron-input>
              <br><button id="apply-all-btn" on-tap="_applyAllCostResults">Apply all</button></div>
            </template>
            <template>
              <iron-input id="cost-input-[[index]]" prevent-invalid-input allowed-pattern="[.\d]" bind-value="{{item.input}}" on-change="_setCostResults">
                <input>
              </iron-input>
            </template>
          </vaadin-grid-column>
        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="costResult">Cost Amount</vaadin-grid-sorter>
          </template>
          <template>[[_prettifyDollar(item.costResult)]]</template>
          <template class="footer">[[_prettifyDollar(totalCost)]]</template>
        </vaadin-grid-column>
        </vaadin-grid>
        <!-- to hold cost pie chart -->
        <div id="cost-chart-container" ></div>
        </div>
      </div>
    </div>
    </iron-pages>
    </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>

    class ThreePolymerWireframe extends Polymer.Element {

      static get is() {
        return 'three-polymer-wireframe-app';
      }

      static get properties() {
        return {
          authHeaders: {
            type: Object,
            value: {}
          },
          baseUrl: {
            type: String,
            //CI pipeline will replace with the production api link
            value: _BACKEND_URL_,
            readOnly: true
          },
          selectedModel: {
            type: String
          },
          currentModelResp: {
            type: Object
          },
          userEmail: {
            type: String
          },
          selectedContourBy: {
            type: String,
            value: "flexure"
          },
          boundaries: {
            type: Object
          },
          geometryFilter: {
            type: Object
          },
          dataOptions: {
            type: Array,
            value: []
          },
          _filtersDisabled: {
            type: Boolean,
            value: false
          },
          _modelData: {
            type: Object,
            value: {}
          },
          modelLoading: {
            type: Boolean
          },
          appLoading: {
            type: Boolean,
            value: true
          },
          _acceptUploadDisabled: {
            type: Boolean,
            value: true
            //notify: true
          },
          jsonUploadPayload: {
            type: Object,
            value: {}
          },
          metadataFields: {
            type: Array,
            value: []
          },
          avgResult: {
            type: Number,
            value: 0
          },
          minResult: {
            type: Number,
            value: 0
          },
          maxResult: {
            type: Number,
            value: 0
          },
          getAvgLabel: {
            type: String,
            value: "average"
          },
          getMinLabel: {
            type: String,
            value: "min value"
          },
          getMaxLabel: {
            type: String,
            value: "max value"
          },
          totalResult : {
            type: Number,
            value: 0
          },
          allObjectsByGroup: {
            type: Array,
            value: []
          },
          numericalAggregationsTableData: {
            type: Array,
            value: []
          },
          grandTotalSum : {
            type: Number,
            value: 0
          },
          totalCost: {
            type: Number,
            value: 0
          },
          getTotalResultLabel: {
            type: String,
            value: "total"
          },
          groupSumData: {
            type: Array,
            value: []
          },
          costTableData: {
            type: Array,
            value: []
          },
          costItems: {
            type: Array,
            value: []
          },
          strPieChart: {
            type: Object
          },
          costPieChart: {
            type: Object
          },
          strPieData: {
            type: Array
          },
          costPieData: {
            type: Array
          },
          selectedView: {
            type: String,
            value: 'model-view'
          },
          selectedSumField: {
            type: String
          },
          showNumericalAggregations: {
            type: Boolean,
            value: false
          },
          showStringAggregations: {
            type: Boolean,
            value: false
          }
        };
      }

      static get observers() {
        return [
          '_boundariesChanged(boundaries.*)',
          '_loadingChanged(modelLoading)',
          '_contourPropsChanged(metadataFields)',
          '_getModelData(selectedModel)',
          '_aggregations(_modelData, selectedContourBy, selectedView)',
          '_getAggregationLabels(_modelData, selectedContourBy)',
          '_getSumByForSelectedSumField(selectedSumField)',
          '_drawStrChart(strPieData)',
          '_drawCostChart(costPieData)',
          '_delayChartResize(selectedView, selectedContourBy)',
          '_getCostByForSelectedCostGroup(selectedCostGroup)'
        ]
      }

      constructor() {
        super();
      }

      logout() {
        this.dispatchEvent(new CustomEvent('logout', {bubbles: true, composed: true}))
      }

      _shareModelEmail(message) {
        var email = '';
        var subject = "Arup Model Quickview link has been shared with you";
        var link = document.createElement("a");
        link.href =  window.location.pathname + '#' + this.selectedModel;
        var emailBody = 'Visit Arup Model Quickview link: ' + '\r\n' + link.href;
        document.location = "mailto:"+email+"?subject="+subject+"&body="+emailBody;
      }

      //the below 2 functions will have to be altered when backend is adjusted to auto timestamp
      _formatModelName(modelName) {
        var arr = modelName.split("_");
        return _.join(_.filter(arr,function(s) {
          return isNaN(s)
        }),' ')
      }

      _formatModelTimeStamp(modelName) {
        var arr = modelName.split("_")
        if (arr.length > 2) {
          if (!isNaN(arr[arr.length-1]) && !isNaN(arr[arr.length-2])) {
            return arr[arr.length-2] + " " + arr[arr.length-1]
          }
          if (!isNaN(arr[0]) && !isNaN(arr[1])) {
            return arr[0] + " " + arr[1]
          }
          if (!isNaN(arr[0])) {
            return arr[0]
          }
        }
        return ""
      }

      _uploadedBy(user) {
        if (_.isEmpty(user)) {
          return user = "admin"
        } else {
          return user
        }
      }

      uploadJsonModel() {
        var that = this
        that.$['json-upload-request'].generateRequest();
        that._clearUploadInput()
        this.$.uploadSuccessToast.show({ text: "Valid JSON, posted to server" })
        this._acceptUploadDisabled = true
        //console.log(that.dataOptions);
      }

      reopenUploadBox(){
        this.$.validationToast.hide()
        Polymer.dom(this.root).querySelector('#addModelDialog').open();
      }

      closeToast() {
        //var toast = Polymer.dom(this.root).querySelector('#validationToast')
        this.$.validationToast.hide()
        this.userEmail = ''
      }

      handleJsonUpload(evt) {
        var inputFile = this.$.modelUpload.files[0]
        var fileName = inputFile.name
        var fileNameNoExtension = fileName.slice(0, fileName.lastIndexOf('.'))
        var extension = fileName.slice(fileName.indexOf('.'))
      	var reader = new FileReader()
        var that = this;
        // Capture the file information
        reader.onload = (function (theFile) {
    			return function (e) {
    				// console.log('e readAsText = ', e);
    				// console.log('e readAsText target = ', e.target);
              //validation
            try {
              //check extension
              if (fileName.slice(-5) !== ".json")
              throw "file has a " + "\"'" + extension  + "'\"" + " extension, but must be a .json file."
              // check that this json has not already been uplaoded
              if (_.includes(_.map(that.dataOptions,'model'), fileNameNoExtension))
              throw "a file with the name " + "\"'" + fileNameNoExtension + "'\"" + " has already been uploaded."
              //parse JSON
              that.jsonUploadPayload = JSON.parse(e.target.result)
              // check that file name matches name in doc
              if (_.toLower(that.jsonUploadPayload.modelInformation.name) + ".json"!== _.toLower(fileName))
              throw "file name is "  + "\"'" + fileName + "'\"" + " and modelInformation.name is " + "\"'" + that.jsonUploadPayload.modelInformation.name + "'\"" + ". These must match."
              // check that modelInfo keys exists
              if (_.has(that.jsonUploadPayload, 'modelInformation') === false)
              throw "it is missing a 'modelInformation' key. This property is required."
              // check that payload key exists
              if (_.has(that.jsonUploadPayload, 'payload') === false)
              throw "it is missing payload key. This property is required."
              // check that modelInfo has units and name keys
              if (_.has(that.jsonUploadPayload, 'modelInformation.units') === false)
              throw "modelInformation must contain a 'units' key."
              if (_.has(that.jsonUploadPayload, 'modelInformation.name') === false)
              throw "modelInformation must contain a 'name' key."
              //add email of user uploading file
              that.jsonUploadPayload.modelInformation.user = that.userEmail
              // check that units are either metric or imperial only
              if (!(that.jsonUploadPayload.modelInformation.units === "metric" ||
              that.jsonUploadPayload.modelInformation.units === "imperial"))
              throw "units values must be either 'imperial' or 'metric'. " + "\"'" + that.jsonUploadPayload.modelInformation.units + "'\"" + " is not a valid unit type."
              var payloadElems = that.jsonUploadPayload.payload
              for (var i=0; i < payloadElems.length; i++) {
                // go through payload elements and ensure each has vertices and metadata keys
                if (_.has(payloadElems[i], 'vertices') === false ||
                    _.has(payloadElems[i], 'metadata') === false) {
                  throw "payload must include both a 'vertices' and 'metadata' key for each element."
                }
              }
            //if it does not get stuck on any errors above, it'll make it to the below
            if (that.flipUploadSwitch === true) {
              that._acceptUploadDisabled = false
            } else {
              //this won't work
              that._checkEmailField()
              if (that.flipUploadSwitch === true) {
                that._acceptUploadDisabled = false
              }
            }
          } catch (err) {
              that._clearUploadInput()
              var toast = Polymer.dom(that.root).querySelector('#validationToast')
              toast.show({ text: "File could not be uploaded because " + err })
            }
          }
        })(inputFile);
        reader.readAsText(inputFile);
      }

      // handleModelRemoval() {
      //   this.$['remove-upload-request'].generateRequest();
      // }

      _checkEmailField() {
        if (_.isEmpty(this.userEmail)) {
          this.flipUploadSwitch = false
        } else if (!_.isEmpty(this.userEmail)){
          this.flipUploadSwitch = true
        }
        this.handleJsonUpload()
      }

      _clearUploadInput() {
        Polymer.dom(this.root).querySelector('#modelUpload').value = ''
        this._acceptUploadDisabled = true;
      }

      // searchFilter(searchInput) {
      //   //to clear results of previous search and filter within ALL models in bucket
      //   this.dataOptions = this.getModelsResp
      //   searchInput = _.toLower(searchInput)
      //   var that = this;
      //   var result = _.filter(that.dataOptions, function(o) {
      //     return _.toLower(o).indexOf(searchInput) !== -1
      //   })
      //   that.dataOptions = _.uniq(_.concat(that.selectedModel, result))
      //   // console.log("SEARCHING: " + searchInput)
      //   // console.log("RESULTS:")
      //   // console.log(that.dataOptions);
      // }

      _isWithinBounds(val, min, max) {
        return val >= min && val <= max
      }

      _prettify(n) {
        return typeof n !== 'undefined' ? parseFloat(n).toLocaleString() : ""
      }

      _prettifyDollar(n) {
        return typeof n !== 'undefined' ? n.toLocaleString('en-US', { style: 'currency', currency: 'USD' }) : ""
      }

      _capitalize(str) {
        return typeof str !== 'undefined' ? _.capitalize(str) : ""
      }

      _dropdownUnitLabel(item, unitType) {
        var that = this;
        item = _.toLower(item)
        var unitType = _.toLower(that.currentModelResp.modelInformation.units)
        if (item.includes('area')) {
          return unitType === 'imperial' ? item + ' (in\u00B2)' : item + ' (mm\u00B2)'
        } else if (item.includes('length')) {
            return unitType === 'imperial' ? item + ' (in)' : item + ' (mm)'
        } else if (item.includes('mass')) {
            return unitType === 'imperial' ? item + ' (lb)' : item + ' (kg)'
        } else if (item.includes('vol')) {
            return unitType === 'imperial' ? item + ' (in\u00B3)' : item + ' (mm\u00B3)'
        } else {
            return item
          }
      }

      _quantUnitLabels(measurement, unitType) {
      	var that = this;
        measurement = _.toLower(measurement)
        unitType = _.toLower(this.currentModelResp.modelInformation.units)
        if (unitType === 'imperial') {
        	if (measurement.includes('area')) {
          	return ' (in\u00B2)'
          } else if (measurement.includes('length')) {
              return ' (in)'
          } else if (measurement.includes('mass')) {
          	 return ' (lb)'
          } else if (measurement.includes('vol')) {
              return ' (in\u00B3)'
          } else {
              return ''
            }
        } else if (unitType === 'metric') {
        	if (measurement.includes('area')) {
          	return ' (mm\u00B2)'
          } else if (measurement.includes('length')) {
              return ' (mm)'
          } else if (measurement.includes('mass')) {
              return ' (kg)'
          } else if (measurement.includes('vol')) {
              return ' (mm\u00B3)'
          } else {
             return ''
           }
        }
      }

      _strOtherUnitLabel(unitType, unitLabel) {
        if (this.currentModelResp.modelInformation.units === 'imperial') {
            if (this._quantUnitLabels(this.selectedSumField) === ' (in)') {
              this.strOtherUnitLabel = ' (ft)'
            } else if (this._quantUnitLabels(this.selectedSumField) === ' (lb)') {
              this.strOtherUnitLabel = ' (ton)'
            } else if (this._quantUnitLabels(this.selectedSumField) === ' (in\u00B3)') {
              this.strOtherUnitLabel = ' (yd\u00B3)'
            }
        } else if (this.currentModelResp.modelInformation.units === 'metric') {
          if (this._quantUnitLabels(this.selectedSumField) === ' (mm)') {
              this.strOtherUnitLabel = ' (m)'
          } else if (this._quantUnitLabels(this.selectedSumField) === ' (kg)') {
              this.strOtherUnitLabel = ' (tonne)'
          } else if (this._quantUnitLabels(this.selectedSumField) === ' (mm\u00B3)') {
              this.strOtherUnitLabel = ' (m\u00B3)'
          }
        }
      }

      _costUnitLabels(material, unitType) {
        var that = this;
        material = _.toLower(that.material)
        unitType = _.toLower(that.currentModelResp.modelInformation.units)
        if (that.material.includes('conc')) {
          return unitType === 'imperial' ? that.costUnitLabel =' (in\u00B3)' : that.costUnitLabel =' (mm\u00B3)'
        } else if (that.material.includes('steel')) {
          return unitType === 'imperial' ? that.costUnitLabel =' (lb)' : that.costUnitLabel =' (kg)'
        } else {
          return ''
        }
      }

      _numericalAggregations() {
        this.showStringAggregations = false;
        var that = this;
        this.linearNumFilterResult = _.filter(that._modelData.linearElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        this.planarNumFilterResult = _.filter(that._modelData.planarElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
          var resultFilterInput = _.concat(this.linearNumFilterResult, this.planarNumFilterResult)
          console.log(resultFilterInput);
        console.log(this.selectedContourBy);
        console.log(this.selectedSumField);
        //reevaluate metadataFields if geoFilters change (BUGGY)
        // console.log(resultFilterInput);
        //   var recalcMetadataKeys = []
        //   _.forEach(resultFilterInput, function(o) {
        //     recalcMetadataKeys.push(_.keys(o.metadata))
        //   });
        //   this.metadataFields = _.uniq(_.flattenDeep(recalcMetadataKeys));
        //   console.log(this.metadataFields);
        if (resultFilterInput.length > 0) {
          this.minResult = _.round(_.minBy(resultFilterInput, function(o) {
            return o.metadata[that.selectedContourBy]
          }).metadata[this.selectedContourBy], 3)
          this.maxResult = _.round(_.maxBy(resultFilterInput, function(o) {
            return o.metadata[that.selectedContourBy]
          }).metadata[this.selectedContourBy], 3)
          var _average = []
          var average = _.forEach(resultFilterInput, function(o) {
            if (typeof o.metadata[that.selectedContourBy] !== 'undefined') {
              _average.push(o.metadata[that.selectedContourBy])
            }
          })
          this.avgResult =  _.round(_.mean(_average), 3);
          this._getAggregationLabels()
          this.numericalAggregationsTableData = []
          var name = [this.getMinLabel, this.getMaxLabel, this.getAvgLabel];
          var result = [this.minResult, this.maxResult, this.avgResult];
          for (var i=0; i < name.length; i++) {
            var setup = {
              'name': name[i],
              'result': result[i]
            }
            this.push('numericalAggregationsTableData', setup)
          }
          this.totalResult = _.round(_.sumBy(resultFilterInput, function(o) {
            return o.metadata[that.selectedContourBy]
          }), 3);
        } else {
          this.numericalAggregationsTableData = []
          this.totalResult = 0
        }
        this.showNumericalAggregations = true;
      }

      _getSumByForSelectedSumField(_selectedSumField) {
        if (typeof this.selectedSumField !== 'undefined') {
          this._stringAggregations();
        }
        return
      }

      _getCostByForSelectedCostGroup(_selectedCostGroup) {
        if (typeof this.selectedCostGroup !== 'undefined') {
          this._costAggregations()
        }
        return
      }

      _stringAggregations() {
        this.showNumericalAggregations = false;
        var that = this
        // ================ repeated function start ==========================================
        this.linearStringFilterResult = _.filter(that._modelData.linearElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        this.planarStringFilterResult = _.filter(that._modelData.planarElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
          var resultFilterInput = _.concat(this.linearStringFilterResult, this.planarStringFilterResult)
          console.log(resultFilterInput);
        // ================ repeated function end ==========================================
        //reevaluate metadataFields when geofilters change
        // if (!_.isEqual(this.geometryFilter, this.boundaries)) {
        //   console.log(resultFilterInput);
        //   var recalcMetadataKeys = []
        //   _.forEach(resultFilterInput, function(o) {
        //     recalcMetadataKeys.push(_.keys(o.metadata))
        //   });
        //   this.metadataFields = _.uniq(_.flattenDeep(recalcMetadataKeys));
        //   console.log(this.metadataFields);
        // }
        if (resultFilterInput.length > 0) {
          var resultGroupByName = _.groupBy(resultFilterInput, function(o) {
            if (that.selectedContourBy === 'propertyname_1') {
              return o.metadata.propertyname_1 + " (" + o.metadata.propertyname_0 + ")"
            }
            return o.metadata[that.selectedContourBy]
          })
          // console.log("RESULTGROUPBYNAME");
          // console.log(resultGroupByName);
          this.groupKeys = _.without(_.keys(resultGroupByName), 'undefined')
          if(typeof this.selectedSumField === 'undefined') {
            this.allObjectsByGroup = []
            //console.log("ALL OBJECTS BY GROUP ONCE");
            //console.log(this.allObjectsByGroup);
            for (var i = 0; i < this.groupKeys.length; i++) {
              var groupObjects = resultGroupByName[this.groupKeys[i]]
              this.push('allObjectsByGroup', groupObjects)
          }
          var _numericalMetadataKeys = []
          var totalGroupObjects = _.flatten(this.allObjectsByGroup)
          for (var i = 0; i < totalGroupObjects.length; i++) {
            var metadataObject = totalGroupObjects[i].metadata
            var metadataValues = _.values(metadataObject)
            var metadataKeys = _.keys(metadataObject)
             for (var j = 0; j < metadataKeys.length; j++) {
              //to include only these in dropdown menu
              //var validSumGroups = ['meta_length', 'length', 'meta_mass', 'mass', 'meta_vol', 'vol', 'volume']
              var ignoreSumGroups = ['area', 'beamnum', 'density', 'shellnum']
              //but also do an "includes/contains" because names could vary
               // to find unique keys with numeric values for dropdown options
               //&& validSumGroups.indexOf(metadataKeys[j]) !== -1
               if(_.isNumber(metadataValues[j]) && _numericalMetadataKeys.indexOf(metadataKeys[j]) === -1 && ignoreSumGroups.indexOf(metadataKeys[j]) === -1) {
                 _numericalMetadataKeys.push(metadataKeys[j])
               }
               this.set('numericalMetadataKeys', _numericalMetadataKeys.sort())
             }
           }
           this.selectedSumField = this.numericalMetadataKeys[0]
         } else {
           var _groupSumData = [];
          // console.log(this.groupSumData);
          this.allObjectsByGroupDupe = []
          // console.log("ALL OBJECTS BY GROUP SECOND");
          // console.log(this.allObjectsByGroupDupe);
          for (var i = 0; i < this.groupKeys.length; i++) {
            //reusing var groupObjects below (was local variable in previous loop for numericalMetadataKeys)
            var groupObjects = resultGroupByName[this.groupKeys[i]]
              var elemsPerGroup = groupObjects.length
              var sumByGroup = _.round(_.sumBy(groupObjects, function(o) {
                return o.metadata[that.selectedSumField]
              }), 0)
              var minByGroup = _.round(_.minBy(groupObjects, function(o) {
                return o.metadata[that.selectedSumField]
              }).metadata[that.selectedSumField], 0)
              var maxByGroup = _.round(_.maxBy(groupObjects, function(o) {
                return o.metadata[that.selectedSumField]
              }).metadata[that.selectedSumField], 0)
              var _average = []
              var average = _.forEach(groupObjects, function(o) {
                if (typeof o.metadata[that.selectedSumField] !== 'undefined') {
                  _average.push(o.metadata[that.selectedSumField])
                }
              })
              var avgByGroup =  _.round(_.mean(_average), 3);
              //for conversion
              if (that.currentModelResp.modelInformation.units === 'imperial') {
                if (that.selectedSumField.includes('length')) {
                  this.strOtherUnitSum = _.round(sumByGroup/12, 0)
                } else if (that.selectedSumField.includes('mass')) {
                  this.strOtherUnitSum = _.round(sumByGroup/2000, 0)
                } else if (that.selectedSumField.includes('vol')) {
                  this.strOtherUnitSum = _.round(sumByGroup/46656, 0)
                }
              } else if (that.currentModelResp.modelInformation.units === 'metric') {
                if (that.selectedSumField.includes('length')) {
                  this.strOtherUnitSum = _.round(sumByGroup/1000, 0)
                } else if (that.selectedSumField.includes('mass')) {
                  this.strOtherUnitSum = _.round(sumByGroup/1000, 0)
                } else if (that.selectedSumField.includes('vol')) {
                  this.strOtherUnitSum = _.round(sumByGroup/1000000000, 0)
                }
              }
              var groupSumDataSetup = {
                'group': this.groupKeys[i],
                'elemsPerGroup': elemsPerGroup,
                'sum': sumByGroup,
                'otherUnitSum': this.strOtherUnitSum,
                'min' : minByGroup,
                'max' : maxByGroup,
                'avg' : avgByGroup
              }
              _groupSumData.push(groupSumDataSetup)
              this.push('allObjectsByGroupDupe', groupObjects)
            }
            this.set('groupSumData',_.sortBy(_groupSumData, [function(o) { return o.group }]))
            //   //for strOtherUnitLabel
            this._strOtherUnitLabel()
            // for chart total sum by group
            this.totalElements = _.round(_.sumBy(this.groupSumData, function(o) {
              return o.elemsPerGroup
            }), 0)
            this.grandTotalSum = _.round(_.sumBy(this.groupSumData, function(o) {
              return o.sum
            }), 1)
            this.grandTotalOtherUnitSum = _.round(_.sumBy(this.groupSumData, function(o) {
              return o.otherUnitSum
            }), 1)
            // for pie chart
            var _strPieData = []
            for (var i=0; i < this.groupSumData.length; i++) {
              var item = this.groupSumData[i]
              _strPieData.push([item.group, parseFloat(item.sum)])
              }
            this.strPieData = _strPieData;
          }
        } else {
          this.groupSumData = []
          this.grandTotalSum = 0
          this.grandTotalOtherUnitSum = 0
          this.strPieData = []
        }
        this.showStringAggregations = true;
      }

      _aggregations(_modelData, selectedContourBy, _currentPage) {
        if(this.selectedView === 'cost-view') {
          this._disableCostTab()
        }
        if (this._isNumberField(_modelData, selectedContourBy)) {
          this._numericalAggregations();
          return
        }
        if (this._isStringField(_modelData, selectedContourBy)) {
          this._stringAggregations();
          return
        }
        this.showStringAggregations = false;
        this.showNumericalAggregations = false;
      }

      _getAggregationLabels() {
        if (typeof this.selectedContourBy === 'undefined' || typeof this.selectedModel === 'undefined') {
          this.getAvgLabel = "Avg unavailable"
          this.getMinLabel = "Min unavailable"
          this.getMaxLabel = "Max unavailable"
          this.getTotalResultLabel = "Total unavailable"
        } else {
          this.getAvgLabel = "Avg " + _.capitalize(this.selectedContourBy)
          this.getMinLabel = "Min " + _.capitalize(this.selectedContourBy)
          this.getMaxLabel = "Max " + _.capitalize(this.selectedContourBy)
          this.getTotalResultLabel = "Total " + _.capitalize(this.selectedContourBy)
        }
      }

      _initStrChart() {
        var chartdiv = Polymer.dom(this.root).querySelector("#sum-chart-container")
        this.strPieChart = Highcharts.chart(chartdiv, {
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false,
            type: 'pie'
        },
        title: {
            text: 'Sum by Group'
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: false
                },
                showInLegend: true
            }
        },
        series: [{
            name: 'Sum',
            colorByPoint: true,
            data: []
          }]
        });
      }

      _hideShareBtn(_model) {
        return typeof this.selectedModel === 'undefined'
      }

      // _hideChart(_totalCost) {
      //   return this.totalCost === 0
      // }

      _initCostChart() {
        var chartdiv = Polymer.dom(this.root).querySelector("#cost-chart-container")
        this.costPieChart = Highcharts.chart(chartdiv, {
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false,
            type: 'pie'
        },
        title: {
            text: 'Cost by Group'
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: false
                },
                showInLegend: true
            }
        },
        series: [{
            name: 'Cost',
            colorByPoint: true,
            data: []
          }]
        });
      }

      _drawStrChart() {
        var chartdiv = Polymer.dom(this.root).querySelector("#sum-chart-container")
        //console.log(this.strPieData);
        this.strPieChart = Highcharts.chart(chartdiv, {
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false,
            type: 'pie'
        },
        title: {
            text: 'Sum by Group',
            align: 'right'
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: false
                },
                showInLegend: true
            }
        },
        legend: {
          layout: 'vertical',
          align: 'right',
          verticalAlign: 'top',
          y: 40,
        },
        series: [{
            name: 'Sum',
            colorByPoint: true,
            colors: ['#7cb5ec', '#434348', '#90ed7d', '#f7a35c', '#8085e9',
                    '#f15c80', '#e4d354', '#2b908f', '#f45b5b', '#91e8e1', '#2f7ed8', '#0d233a', '#8bbc21', '#910000', '#1aadce',
                    '#492970', '#f28f43', '#77a1e5', '#c42525', '#a6c96a', '#4572A7', '#AA4643', '#89A54E', '#80699B', '#3D96AE',
                    '#DB843D', '#92A8CD', '#A47D7C', '#B5CA92'],
            data: this.strPieData
          }]
        });
        //console.log(this.strPieChart.series[0].userOptions.data);
      }

      _drawCostChart() {
        var chartdiv = Polymer.dom(this.root).querySelector("#cost-chart-container")
        //console.log(this.strPieData);
        this.costPieChart = Highcharts.chart(chartdiv, {
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false,
            type: 'pie'
        },
        title: {
            text: 'Cost by Group',
            align: 'right'
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: false
                },
                showInLegend: true
            }
        },
        legend: {
          layout: 'vertical',
          align: 'right',
          verticalAlign: 'top',
          y: 40,
        },
        series: [{
            name: 'Sum',
            colorByPoint: true,
            colors: ['#7cb5ec', '#434348', '#90ed7d', '#f7a35c', '#8085e9',
                    '#f15c80', '#e4d354', '#2b908f', '#f45b5b', '#91e8e1', '#2f7ed8', '#0d233a', '#8bbc21', '#910000', '#1aadce',
                    '#492970', '#f28f43', '#77a1e5', '#c42525', '#a6c96a', '#4572A7', '#AA4643', '#89A54E', '#80699B', '#3D96AE',
                    '#DB843D', '#92A8CD', '#A47D7C', '#B5CA92'],
            data: this.costPieData
          }]
        });
        //console.log(this.strPieChart.series[0].userOptions.data);
      }

      _delayChartResize() {
        var that = this;
        setTimeout(function() {
          that.strPieChart.reflow()
        }, 0)
      }

      ready() {
        super.ready();
        this.$['get-models-request'].generateRequest();
        this._initStrChart();
        this._initCostChart();
      }

      _dateTimeFormat() {
        var d = new Date();
        var curr_date = (d.getDate() < 9 ? '0': '') + (d.getDate()+1)
        var curr_month = (d.getMonth() < 9 ? '0': '') + (d.getMonth()+1)
        var curr_year = d.getFullYear();
        var curr_year_formatted = curr_year.toString().substring(2)
        var curr_hour = (d.getHours() < 9 ? '0': '') + d.getHours()
        var currMins = (d.getMinutes() < 9 ? '0': '') + d.getMinutes()
        var timeFormat = curr_year_formatted + curr_month + curr_date + "_" + curr_hour + currMins
        return "Downloaded on: " + timeFormat + '\r\n'
      }

      _currentFilters() {
        return "Filters:" + '\r\n' +
        'min x, ' + this.geometryFilter.xMin + '\r\n' + 'max x, ' + this.geometryFilter.xMax + '\r\n' +
        'min y, ' + this.geometryFilter.yMin + '\r\n' + 'max y, ' + this.geometryFilter.yMax + '\r\n' +
        'min z, ' + this.geometryFilter.zMin + '\r\n' + 'max z, ' + this.geometryFilter.zMax
      }

      createNumericalCsv() {
        var rowData = ''
        if (this.numericalAggregationsTableData.length > 0) {
          for (var i=0; i < this.numericalAggregationsTableData.length; i++) {
            this.numDataHeaders = _.keys(this.numericalAggregationsTableData[i])
            var el = [_.values(this.numericalAggregationsTableData[i])] + '\r\n'
          	rowData += el
          }
          var that = this;
          var headers_ = _.map(this.numDataHeaders, function(h) {
            if (h === 'name') {
              return h
            }
            return h + that._quantUnitLabels(that.selectedContourBy)
          })
          this.numDataHeaders = headers_ + '\r\n'
          var csvData = this.numDataHeaders + rowData + '\r\n' + this._currentFilters() + '\r\n' + this._dateTimeFormat()
          var uri = 'data:text/csv;charset=utf-8,' + escape(csvData);
          var link = document.createElement("a");
          link.href = uri;
          link.style = "visibility:hidden";
          link.download = this.selectedModel + ".csv";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }

      createGroupDataCsv() {
        var rowData = ''
        if (this.groupSumData.length > 0) {
          for (var i=0; i < this.groupSumData.length; i++) {
            this.groupDataHeaders = _.keys(this.groupSumData[i])
            var el = [_.values(this.groupSumData[i])] + '\r\n'
            rowData += el
          }
          var that = this;
          var headers_ = _.map(this.groupDataHeaders,function(h) {
            if (h === 'group') {
              return h
            } if (h === 'elemsPerGroup') {
              return "elements per group"
            } if (h === 'otherUnitSum') {
              return that.selectedSumField + " sum " + that.strOtherUnitLabel
            }
            return that.selectedSumField + " " + h + that._quantUnitLabels(that.selectedSumField)
          })
          this.groupDataHeaders = headers_ + '\r\n';
          var csvData = this.groupDataHeaders + rowData + '\r\n' + this._currentFilters() + '\r\n' + this._dateTimeFormat()
          var uri = 'data:text/csv;charset=utf-8,' + escape(csvData);
          var link = document.createElement("a");
          link.href = uri;
          link.style = "visibility:hidden";
          link.download = this.selectedModel + ".csv";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }

      createCostDataCsv() {
        var rowData = ''
        if (this.costTableData.length > 0) {
          for (var i=0; i < this.costTableData.length; i++) {
            this.costTableHeaders = _.keys(this.costTableData[i])
            var el = [_.values(this.costTableData[i])] + '\r\n'
            rowData += el
          }
          var that = this;
          var headers_ = _.map(this.costTableHeaders,function(h) {
            if (h === 'group') {
              return h
            } if (h === 'elemsPerGroup') {
              return "elements per group"
            } if (h === 'sum') {
              return that.material + " sum " + that.costUnitLabel
            } if (h === 'otherUnitSum') {
              return that.material + " sum " + that.costOtherUnitLabel
            } if (h === 'input') {
              return "cost per " + that.costOtherUnitLabel
            } if (h === 'costResult') {
              return "cost amount"
            }
          })
          this.costTableHeaders = headers_ + '\r\n';
          var csvData = this.costTableHeaders + rowData + '\r\n' + this._currentFilters() + '\r\n' + this._dateTimeFormat()
          var uri = 'data:text/csv;charset=utf-8,' + escape(csvData);
          var link = document.createElement("a");
          link.href = uri;
          link.style = "visibility:hidden";
          link.download = this.selectedModel + ".csv";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }

      _hideMainDropdown(_currentPage) {
        return this.selectedView === 'aggregations-view' || this.selectedView === 'cost-view';
      }

      _hideQuantCsvButton(_currentPage) {
        return this.selectedView === 'model-view' || this.selectedView === 'cost-view';
      }

      _hideCostCsvButton(_currentPage) {
        return this.selectedView !== 'cost-view';
      }

      _disableCostTab(_currentMetadataFields, _currentModel, _geoFilter) {
        if (!_.isEmpty(this.geometryFilter) && this.metadataFields.includes('material')) {
          if (_.isEmpty(this.currentModelResp.payload.planarElements)) {
            var payloadElems = this.currentModelResp.payload.linearElements
            console.log(payloadElems);
          } else if (_.isEmpty(this.currentModelResp.payload.linearElements)) {
            var payloadElems = this.currentModelResp.payload.planarElements
            console.log(payloadElems);
          } else if (!_.isEmpty(this.currentModelResp.payload.linearElements) && !_.isEmpty(this.currentModelResp.payload.planarElements)) {
            var payloadElems = _.concat(this.currentModelResp.payload.linearElements, this.currentModelResp.payload.planarElements)
            console.log(payloadElems);
          }
          for (var i=0; i < payloadElems.length; i++) {
            this.material = _.toLower(payloadElems[i].metadata.material)
            //console.log(payloadElems[i]);
            // go through payload elements and their metadata keys
            if (this.material === 'concrete' && _.has(payloadElems[i], 'metadata.volume') ||  _.has(payloadElems[i], 'metadata.vol') ||  _.has(payloadElems[i], 'metadata.meta_volume') ||
                this.material === 'steel' && _.has(payloadElems[i], 'metadata.mass') || _.has(payloadElems[i], 'metadata.meta_mass')) {
              // console.log("material cost for: " + this.material)
              // console.log("does it include 'conc': " + this.material.includes('conc'))
              // console.log("does it include 'steel': " + this.material.includes('steel'))
              this._costAggregations()
              return false
            } else {
              //console.log("cost-tab should be DISABLED!");
            }
          }
        }
        return true
      }

      _setCostPieData() {
        var _costPieData = []
        for (var i=0; i < this.costTableData.length; i++) {
          var item = this.costTableData[i]
          _costPieData.push([item.group, parseFloat(item.costResult)])
          }
        this.costPieData = _costPieData;
      }

      _applyAllCostResults() {
        //make DRY!...somehow
        for (var i=0; i < this.costTableData.length; i++) {
            this.set('costTableData.'+i+'.input', this.applyToAll)
            this.set('costTableData.'+i+'.costResult', this.costTableData[i].input*this.costTableData[i].otherUnitSum);
        }
        if (this.costItems.length === 0) {
        for (var i=0; i < this.costTableData.length; i++) {
            this.costItems.push({'model': this.selectedModel, 'group': this.costTableData[i].group, 'input': this.costTableData[i].input})
          }
        } else {
          //if group already in costItems, overwrite input value
          for (var i=0; i < this.costTableData.length; i++) {
            for (var j=0; j < this.costItems.length; j++) {
              if (this.costTableData[i].group === this.costItems[j].group && this.costItems[j].model === this.selectedModel) {
                this.set('costItems.'+j+'.input', this.costTableData[i].input);
              }
            }
          } //if group not there, push onto costItems
          var costItemGroups = []
          _.forEach(this.costItems, function(o) {
             costItemGroups.push(o.group)
          })
          for (var i=0; i < this.costTableData.length; i++) {
          if (costItemGroups.indexOf(this.costTableData[i].group) === -1) {
            this.costItems.push({'model': this.selectedModel, 'group': this.costTableData[i].group, 'input': this.costTableData[i].input})
            }
          }
        }
        this.totalCost = _.sumBy(this.costTableData, function(o) {
          return o.costResult
        })
        this._setCostPieData()
        this.applyToAll = ''
      }

      _setCostResults(e) {
        //console.log(e.model);
        var item = e.model.item
        var inputIndex = e.model.index
        for (var i=0; i < this.costTableData.length; i++) {
          if (i === inputIndex) {
            //console.log("values: " + e.target.value + " : " + this.costTableData[i].input)
            this.set('costTableData.'+i+'.costResult', this.costTableData[i].input * this.costTableData[i].otherUnitSum);
          }
        }
        if (this.costItems.length === 0) {
          this.costItems.push({'model': this.selectedModel, 'group': item.group, 'input': item.input})
        } else {
          var found = this.costItems.some(function (el) {
            return el.group === item.group;
          });
          if (!found) {
            this.costItems.push({'model': this.selectedModel, 'group': item.group, 'input': item.input})
          } else if (found) {
            for (var i=0; i < this.costItems.length; i++) {
              if (this.costItems[i].group === item.group && this.costItems[i].model === this.selectedModel) {
                this.costItems[i].input = item.input
              }
            }
          }
        }
        this.totalCost = _.sumBy(this.costTableData, function(o) {
          return o.costResult
        })
        this._setCostPieData()
      }

      _updateCostValues() {
        if (typeof this.costItems !== 'undefined') {
          for (var i=0; i < this.costTableData.length; i++) {
            for (var j=0; j < this.costItems.length; j++) {
              if (this.costTableData[i].group == this.costItems[j].group && this.selectedModel === this.costItems[j].model) {
                //console.log(this.costTableData[i].group + " = " + this.costItems[j].group);
                this.set('costTableData.'+i+'.input', this.costItems[j].input);
                this.set('costTableData.'+i+'.costResult', this.costTableData[i].input*this.costTableData[i].otherUnitSum);
              }
            }
          }
          this.totalCost = _.sumBy(this.costTableData, function(o) {
            return o.costResult
          })
          this._setCostPieData()
        }
      }

      _costAggregations() {
        var that = this
        // ================ repeated function start ==========================================
        this.linearCostFilterResult = _.filter(that._modelData.linearElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
        this.planarCostFilterResult = _.filter(that._modelData.planarElements, function(o) {
          return _.every(o.vertices, function(j) {
            return that._isWithinBounds(j[0], that.geometryFilter.xMin, that.geometryFilter.xMax) &&
            that._isWithinBounds(j[1], that.geometryFilter.yMin, that.geometryFilter.yMax) &&
            that._isWithinBounds(j[2], that.geometryFilter.zMin, that.geometryFilter.zMax)
          })
        })
          var resultFilterInput = _.concat(this.linearCostFilterResult, this.planarCostFilterResult)
          console.log(resultFilterInput);
        if (resultFilterInput.length > 0) {
          // ================ repeated function end ==========================================
          this.costGroups = []
          for (var i=0; i < this.metadataFields.length; i++) {
            if (this.metadataFields[i].includes('propertyname')) {
              this.push('costGroups', this.metadataFields[i])
            };
          }
          if (typeof this.selectedCostGroup === 'undefined') {
            this.selectedCostGroup = this.costGroups[0]
          }
          var groupsForMaterial = _.groupBy(resultFilterInput, function(o) {
            if (that.selectedCostGroup === 'propertyname_1') {
              return o.metadata.propertyname_1 + " (" + o.metadata.propertyname_0 + ")"
            }
            return o.metadata[that.selectedCostGroup]
          })
          // ================ repeated pattern for CODE end ==========================================
          var unitType = this.currentModelResp.modelInformation.units
          // console.log(unitType);
          var _costTableData = []
          // console.log(this.costTableData);
          var groupKeys = _.without(_.keys(groupsForMaterial), 'undefined')
          var allObjectsByMaterialGroup = []
          if (this.material === 'concrete') {
            for (var i=0; i < groupKeys.length; i++) {
              var groupObjects = groupsForMaterial[groupKeys[i]];
              var elemsPerGroup = groupObjects.length
              allObjectsByMaterialGroup.push(groupObjects)
              var sumByGroup = _.sumBy(groupObjects, function(o) {
                return o.metadata.volume
              })
              var _otherUnitSum = unitType === 'imperial' ? _.round(sumByGroup/46656, 2) : _.round(sumByGroup/1000000000, 2)
              this.costOtherUnitLabel = unitType === 'imperial' ? '(yd\u00B3)' : '(m\u00B3)'
              var costTableDataSetup = {
                'group': groupKeys[i],
                'elemsPerGroup': elemsPerGroup,
                'sum': sumByGroup,
                'otherUnitSum': _otherUnitSum,
                'input': 0
              }
              costTableDataSetup['costResult'] = costTableDataSetup.otherUnitSum * costTableDataSetup.input;
              _costTableData.push(costTableDataSetup)
            }
            this.set('costTableData', _.sortBy(_costTableData, [function(o) { return o.group }]))
          } else if (this.material === 'steel') {
            for (var i=0; i < groupKeys.length; i++) {
              var groupObjects = groupsForMaterial[groupKeys[i]];
              var elemsPerGroup = groupObjects.length
              allObjectsByMaterialGroup.push(groupObjects)
              var sumByGroup = _.sumBy(groupObjects, function(o) {
                return o.metadata.mass
              })
              var _otherUnitSum = unitType === 'imperial' ? _.round(sumByGroup/2000, 2) : _.round(sumByGroup/1000, 2)
              this.costOtherUnitLabel = unitType === 'imperial' ? ' (ton)' : ' (tonne)'
              var costTableDataSetup = {
                'group': groupKeys[i],
                'elemsPerGroup': elemsPerGroup,
                'sum': sumByGroup,
                'otherUnitSum': _otherUnitSum,
                'input': 0
              }
              costTableDataSetup['costResult'] = costTableDataSetup.otherUnitSum * costTableDataSetup.input;
              _costTableData.push(costTableDataSetup)
            }
            this.set('costTableData', _.sortBy(_costTableData, [function(o) { return o.group }]))
          }
          this.costTotalElements = _.round(_.sumBy(this.costTableData, function(o) {
           return o.elemsPerGroup
          }), 0)
          this.totalMaterialSum = _.round(_.sumBy(this.costTableData, function(o) {
            return o.sum
          }), 3)
          this.totalMaterialSumDiffUnit = _.round(_.sumBy(this.costTableData, function(o) {
            return o.otherUnitSum
          }), 3)
          //may or may not be the best place for this:
          this._updateCostValues()
        } else {
          this.costTableData = []
          this.costTotalElements = 0
          this.totalMaterialSum = 0
          this.totalMaterialSumDiffUnit = 0
          this.totalCost = 0
        }
      }

      //Ensure that the geometry input is within boundaries and is compatible with its input sibling
      _computeMin(_b, _g) {
        _g = parseFloat(_g)
        if (_.isNumber(_g)) {
          return (_g > _b) ? _g : _b
        }
        return _b
      }

      _computeMax(_b, _g) {
        _g = parseFloat(_g)
        if (_.isNumber(_g)) {
          return (_g < _b) ? _g : _b
        }
        return _b
      }

      _boundariesChanged(boundaries) {
        this.resetFilters();
        //console.log(this.boundaries)
      }

      _loadingChanged(modelLoading) {
        //console.log(modelLoading)
        this.checkValidInput();
      }

      _contourPropsChanged(metadataFields) {
        this.metadataFields = this.metadataFields.sort();
        if (this.metadataFields.indexOf(this.selectedContourBy) === -1) {
          this.selectedContourBy = undefined;
          if (this.metadataFields.length > 0) {
            var that = this;
            setTimeout(function() {
              that.selectedContourBy = that.metadataFields[0];
            }, 0);
          }
        }
      }

      _isNumberField(_modelData, selectedContourBy) {
          return !_.isEmpty(_modelData.linearElements)  && this.selectedContourBy && _.isNumber(_modelData.linearElements[0].metadata[this.selectedContourBy]) || !_.isEmpty(_modelData.planarElements)  && this.selectedContourBy && _.isNumber(_modelData.planarElements[0].metadata[this.selectedContourBy])
      }

      _isStringField(_modelData, selectedContourBy) {
        return !_.isEmpty(_modelData.linearElements) && typeof this.selectedContourBy !== 'undefined' && !_.isNumber(_modelData.linearElements[0].metadata[this.selectedContourBy]) || !_.isEmpty(_modelData.planarElements) && typeof this.selectedContourBy !== 'undefined' && !_.isNumber(_modelData.planarElements[0].metadata[this.selectedContourBy])
      }

      isLoadingState(modelLoading, appLoading) {
        return modelLoading || appLoading
      }

      checkValidInput() {
        //console.log(this.geometryFilter)
        if (!_.isEmpty(this.geometryFilter) && !_.isEmpty(this.boundaries) && !this.modelLoading && _.every(_.values(this.geometryFilter), function(o) {
            return o !== ""
          })) {
          this._filtersDisabled =
            parseFloat(this.geometryFilter.xMin) < this.boundaries.xMin || parseFloat(this.geometryFilter.xMin) > this.geometryFilter.xMax ||
            parseFloat(this.geometryFilter.yMin) < this.boundaries.yMin || parseFloat(this.geometryFilter.yMin) > this.geometryFilter.yMax ||
            parseFloat(this.geometryFilter.zMin) < this.boundaries.zMin || parseFloat(this.geometryFilter.zMin) > this.geometryFilter.zMax ||
            parseFloat(this.geometryFilter.xMax) > this.boundaries.xMax ||
            parseFloat(this.geometryFilter.yMax) > this.boundaries.yMax ||
            parseFloat(this.geometryFilter.zMax) > this.boundaries.zMax
        } else {
          this._filtersDisabled = true;
        }
      }

      resetFilters() {
        this.geometryFilter = _.cloneDeep(this.boundaries);
        this.checkValidInput();
        this._aggregations(this._modelData, this.selectedContourBy, this.selectedView);
        //reset filter selection to the model boundaries
        //console.log(this.geometryFilter)
        //console.log(this.boundaries)
      }

      applyFilters() {
        this.geometryFilter = {
          'xMin': parseFloat(this.geometryFilter.xMin),
          'xMax': parseFloat(this.geometryFilter.xMax),
          'yMin': parseFloat(this.geometryFilter.yMin),
          'yMax': parseFloat(this.geometryFilter.yMax),
          'zMin': parseFloat(this.geometryFilter.zMin),
          'zMax': parseFloat(this.geometryFilter.zMax)
        }
        this._aggregations(this._modelData, this.selectedContourBy, this.selectedView);
      }

      _initData(dataOptions_) {
        //this.set('dataOptions', dataOptions_)
        //sort by date
        this.set('dataOptions', _.sortBy(dataOptions_, [function(o) { return o.s3_attributes.uploadTime }]));
        if (this.dataOptions.length > 0) {
          var link_ = window.location.hash.replace("#","");
          var linkIndex = -1;
          if (link_ !== "") {
            linkIndex = _.findIndex(this.dataOptions,function(o) {return o.model === link_})
            if (linkIndex === -1) {
              this.$.linkFailToast.show({ text: "Couldn't find linked model" });
            }
            history.replaceState('', document.title, window.location.pathname);
          }
          if (linkIndex >= 0) {
            this.set('selectedModel', this.dataOptions[linkIndex].model)
          }
          else {
            this.set('selectedModel', this.dataOptions[0].model)
          }
        }
      }

      handleOptionsResponse(event, response) {
        this.getModelsResp = response.response
        var resp = response.response;
        if (resp) {
          this.appLoading = false
          this._initData(resp);
        } else {
          this.handleOptionsError();
        }
      }

      handleOptionsError(event, response) {
        this.appLoading = false;
        this._initData([]);
        alert("Couldn't fetch data.  Please check your internet connection");
      }

      handleDataResponse(event, response) {
        this.currentModelResp = response.response
        //console.log(this.currentModelResp);
        console.log("has both kinds of elements: ");
        console.log(!_.isEmpty(this.currentModelResp.payload.linearElements) && !_.isEmpty(this.currentModelResp.payload.planarElements))
        var costTab = Polymer.dom(this.root).querySelector("#cost-tab")
        if (costTab.disabled && this.selectedView === 'cost-view') {
          this.selectedView = 'model-view'
        }
        if (this.currentModelResp && this.currentModelResp.modelInformation.name === this.selectedModel && "payload" in this.currentModelResp) {
          this.appLoading = false;
          this.set('_modelData', {
            'linearElements': this.currentModelResp.payload.linearElements,
            'planarElements': this.currentModelResp.payload.planarElements
          });
          //set selectedSumField to undefined in order to trigger stringAggregtions initialization
          this.selectedSumField = undefined
          //console.log(this._modelData)
        } else {
          this.handleDataError()
        }
      }

      handleDataError(event, response) {
        this.appLoading = false;
        alert("couldn't retrieve " + this.selectedModel)
      }

      _getModelData(_selectedModel) {
        this.viewData = {
             "linearElements": [],
             "planarElements": []
        }
        this.$['model-request'].url = this.baseUrl + "get-model-data/" + this.selectedModel
        this.$['model-request'].generateRequest();
        this.appLoading = true;
      }

      showDialog() {
        this.$.addModelDialog.open();
      }

      handleUploadResponse(event, response) {
        var resp = response.response;
        if ("success" in resp) {
          this.$['get-models-request'].generateRequest();
          this.$.uploadSuccessToast.show({ text: "Upload successful!"})
        }
      }

    }

    window.customElements.define(ThreePolymerWireframe.is, ThreePolymerWireframe);
  </script>
</dom-module>
